//.20211004_172114.js
//.20211004_170726.js
//CreativeClusters:patch #1:2020-06-25
//CreativeDCO:patch #1:2020-06-10

window.__system = {
	adxcel_tag_version:"v2.0.5",
	review: "2020-12-01"
};

//TODO 1/11
var adxcel_review = "2021-10-04 17:00:00"; 

if (!window.adxcel) adxcel = {};

var adxcel_id = (window.__ad__ && window.__ad__.uid) ? window.__ad__.uid : ("adxcel_id_" + Math.floor(Math.random() * 100000000));
window.adxcel_uid = (window.__ad__ && window.__ad__.uid) ? window.__ad__.uid : ((new Date()).getTime() + "" + (Math.floor(Math.random() * 10000) + 999));

//#CONTENT: PACKAGES
var adxcel_content_packages_path_addon = "_compressed-fs8.png";
var adxcel_content_packages_path = null;
var adxcel_content_packages = null;
//+see adxcel_getCurrentPackageURL
//#CONTENT: PACKAGES: END

setTimeout(function(){
	var skip_packages = UrlParam("skip_packages", "")
	if(skip_packages == "1"){
		window.adxcel_content_packages = null;
	}
}, 100)

//#MULTI LINES
var adxcel_lines = [
	{
		alias:"dco",
		settings:{
			dco_slots:10,
			dco_slots:10,
			dco_rev_start:10,
			dco_strategy:"mult",
		},
		dco:{
			//#DATA: DCO AI
           revision: 9,
           dco_ai_item_id: 0,
           dco_ai_features: [[0,["iid",{"-1":0,"663367":1,"663371":2,"663436":3,"663361":4,"663427":5,"663438":6,"663425":7,"663379":8,"663439":9,"663384":10,"663429":11,"663426":12,"663381":13,"663382":14,"663373":15,"663441":16,"663385":17,"663430":18,"663375":19,"663366":20}]],[0,["utmtr",{"3":0,"2":1,"7":2,"4":3,"5":4,"6":5,"0":6,"1":7}]],[0,["mm_dma",{"-1":0,"501":1,"602":2,"511":3,"0":4,"504":5,"506":6,"524":7,"803":8,"623":9,"505":10,"819":11,"613":12,"618":13,"539":14,"517":15,"534":16,"807":17,"510":18,"528":19,"751":20}]],[0,["s_width",{"1920":0,"-1":1,"384":2,"412":3,"1536":4,"360":5,"1280":6,"1366":7,"1440":8,"2560":9,"390":10,"320":11,"393":12,"1600":13,"1470":14,"430":15,"432":16,"375":17,"385":18,"414":19,"820":20}]],[0,["s_height",{"-1":0,"1080":1,"864":2,"832":3,"900":4,"768":5,"780":6,"1440":7,"800":8,"915":9,"960":10,"720":11,"844":12,"892":13,"852":14,"956":15,"854":16,"932":17,"824":18,"1200":19,"694":20}]],[0,["s_ratio",{"1.78":0,"0.46":1,"0.45":2,"1.6":3,"0.47":4,"1.54":5,"-1.0":6,"0.75":7,"1.5":8,"2.39":9,"0.69":10,"0.56":11,"0.41":12,"0.44":13,"1.55":14,"1.25":15,"0.49":16,"2.37":17,"1.33":18,"3.56":19,"0.7":20}]],[0,["fc_imp_chk",{"0":0,"1":1,"4":2,"2":3,"3":4,"-1":5}]],[0,["fc_time_chk",{"7":0,"0":1,"1":2,"6":3,"2":4,"5":5,"4":6,"3":7,"-1":8}]],[0,["os_name",{"Windows_10":0,"Android":1,"macOS":2,"iOS":3,"Chrome_OS":4,"-":5,"Linux":6,"Windows_7":7,"Windows_8.1":8,"OS_X":9,"Linux_-_Ubuntu":10,"iPadOS":11,"Windows_8":12,"Windows":13,"Windows_Phone":14,"Windows_Vista":15,"Linux_-_Fedora":16,"_":17,"Windows_XP":18,"KaiOS":19,"Mac_OS_X":20}]],[0,["model",{"-":0,"Generic_Android_Mobile":1,"_":2,"iPhone":3,"SM-S928U":4,"SM-S911U":5,"SM-S901U":6,"SM-S918U":7,"SM-S921U":8,"SM-S926U":9,"Pixel":10,"iPhone_13":11,"iPhone_14":12,"SM-A156U":13,"SM-S908U":14,"SM-S916U":15,"iPhone_15_Pro_Max":16,"iPhone_15":17,"SM-G991U":18,"SM-A146U":19,"iPhone_11":20}]],[0,["hardware",{"Desktop":0,"Mobile_Phone":1,"-":2,"Tablet":3,"VR_Headset":4,"Media_Player":5,"TV":6,"Digital_Signage_Media_Player":7,"Set_Top_Box":8,"Digital_Home_Assistant":9,"Data_Collection_Terminal":10,"Games_Console":11,"eReader":12,"Payment_Terminal":13,"Refrigerator":14,"Digital_Whiteboard":15,"Vehicle_Multimedia_System":16,"Single-board_Computer":17}]],[0,["mm_isp",{"_":0,"Comcast_Cable":1,"Spectrum":2,"AT&T_Internet":3,"T-Mobile_USA":4,"Verizon_Wireless":5,"Verizon_Fios":6,"AT&T_Wireless":7,"Cox_Communications":8,"Spectrum_Business":9,"Frontier_Communications":10,"CenturyLink":11,"Comcast_Business":12,"Optimum_Online":13,"Verizon_5g_Home_Internet":14,"Starlink":15,"AT&T_Business":16,"-":17,"Windstream_Communications":18,"Lumen":19,"Optimum":20}]],[0,["mm_asn",{"-1":0,"7922":1,"7018":2,"21928":3,"6167":4,"701":5,"20115":6,"22773":7,"10796":8,"0":9,"11351":10,"33363":11,"11426":12,"5650":13,"6128":14,"209":15,"11427":16,"20001":17,"14593":18,"7029":19,"19108":20}]],[0,["prizm",{"0":0,"-1":1,"12":2,"5":3,"22":4,"36":5,"9":6,"44":7,"3":8,"27":9,"11":10,"18":11,"6":12,"28":13,"4":14,"20":15,"32":16,"58":17,"38":18,"7":19,"2":20}]],[0,["psycle",{"0":0,"-1":1,"10":2,"1":3,"2":4,"3":5,"7":6,"6":7,"13":8,"20":9,"47":10,"46":11,"59":12,"54":13,"14":14,"16":15,"18":16,"9":17,"11":18,"26":19,"33":20}]],[0,["connexion",{"0":0,"-1":1,"4":2,"28":3,"3":4,"7":5,"21":6,"6":7,"16":8,"11":9,"12":10,"14":11,"41":12,"23":13,"18":14,"1":15,"10":16,"26":17,"30":18,"27":19,"5":20}]]],
           dco_ai_logits: {"root":{"0":[[-0.00511,0.04435,0.05656,-0.1183,0.1179,-0.05523,-0.04197,0.11091,-0.26519,-0.11341,-0.19911,0.09256,-0.12897,-0.04967,-0.12136,-0.04749,0.19824,-0.21794,-0.13867,0.14204,0.54787,-0.02712,-0.07706,0.08377,0.11731,0.29073,0.28411,-0.00753,0.11734,-0.17686,0.33343,0.35014,-0.0579,-0.24803,0.0793,0.03639,-0.0692,0.60982,0.1258,-0.17991,0.032,-0.00635,0.01566,-0.1583,-0.10258,-0.01793,0.27577,-0.05251,0.07697,0.13129,-0.05907,0.11725,-0.05561,-0.03839,-0.07732,-0.03999,-0.0933,-0.18971,0.04251,0.05009,0.14408,0.00588,0.23663,-0.08286,-0.1532,0.22808,0.022,0.1469,-0.08626,0.42049,0.33801,0.1098,-0.02659,-0.06978,-0.10999,-0.10398,-0.18906,-0.13252,0.00603,0.03775,0.00818,-0.01193,-0.07554,0.15072,-0.10113,0.14128,0.22422,0.06498,0.22329,0.1798,-0.06277,-0.18313,-0.1356,0.26694,-0.00191,-0.07372,-0.03977,-0.16798,-0.05489,0.52346,-0.19587,-0.21024,0.4189,-0.13741,-0.14874,-0.17652,0.00688,-0.41238,-0.18758,-0.09565,-0.6979,-0.23901,0.72863,0.0175,-0.11483,0.05877,0.16248,0.27524,-0.61927,0.0175,-0.24158,-0.16509,0.70465,0.30621,0.79652,0.65276,0.39721,-0.61927,-0.20829,-0.11526,0.28444,0.61625,-0.41418,0.21876,0.07281,-0.34934,0.09119,0.40902,-0.23873,-0.68272,-0.48236,-0.51849,-0.83725,-0.50474,-0.61608,-0.60311,-0.38896,-1.01228,-0.76162,-0.16357,-0.06768,-0.09319,0.90484,-0.18155,-0.20572,-0.33841,-0.13536,-0.10157,-0.21986,-0.20722,-0.18287,-0.12651,-0.07133,-0.13826,-0.28277,-0.06878,-0.21564,-0.24779,-0.05399,-0.53288,-0.1566,0.15196,0.18624,-0.60698,0.87683,-1.03337,-0.62089,-0.85042,-0.55401,-0.26452,-0.83133,-0.46823,-0.43154,-0.61774,0.0,-0.80953,0.0,-0.2978,0.35751,-0.19452,-0.16166,-0.26714,0.16951,-0.40632,-0.11151,0.34721,-0.06799,-0.10211,-0.20694,-0.11331,0.0371,-0.17481,-0.38249,-0.24043,0.0035,0.24508,-0.15333,-0.00532,-0.15768,0.29142,-0.17545,0.1292,0.16951,-0.40445,-0.19612,-0.10593,-0.13177,-0.06557,-0.14234,0.05207,-0.07262,-0.13375,-0.1622,-0.34994,-0.08787,0.01214,-0.18861,-0.23645,-0.14839,-0.15873,0.45193,-0.30469,-0.23913,-0.14959,-0.16227,-0.24407,-0.22963,-0.33186,-0.1578,-0.41483,-0.22848,-0.20519,-0.2218,-0.44342,-0.35383,-0.14581,-0.18649,-0.26979,-0.30489,-0.31454,-0.22095,0.22049,-0.20533,-0.16748,-0.25025,-0.30565,-0.12942,-0.09412,-0.23126,-0.27198,-0.16924,-0.22055,-0.16636,-0.22257,-0.3084,-0.32802,-0.20675,0.08855,-0.24354,-0.18307,-0.25078,-0.17847,0.20985,-0.21812,-0.22627,-0.18145,-0.1823,-0.13192,-0.23786,-0.07793,-0.14918,-0.25263,-0.24108,-0.08322,-0.26763,-0.2225,-0.24126,-0.17516,0.09274,-0.09331,-0.11246,-0.23727,-0.21392],-9.58887,"L"],"1":[[0.01327,0.44631,0.51066,-0.10046,0.47808,-0.05268,0.00708,-0.0394,0.04039,-0.14562,-0.10978,0.0188,0.08061,0.70922,0.2514,0.02801,-0.08983,-0.06764,-0.08109,0.89916,0.97867,-0.04483,-0.08652,0.12161,0.10451,0.25983,0.14938,0.15216,-0.01758,-0.08574,0.1454,0.28002,-0.00959,-0.19423,0.011,0.00406,-0.04663,0.56946,0.10896,-0.15383,0.00759,-0.04249,0.03976,-0.07123,-0.07851,-0.03235,0.32904,-0.18217,0.06073,0.01148,-0.02969,0.05044,-0.04873,-0.01933,-0.05934,-0.03435,-0.03188,-0.16951,0.05321,0.03154,0.16127,0.02278,0.16206,-0.05578,-0.02368,0.17018,0.02384,0.17597,0.11198,0.26438,0.37822,0.0579,-0.00367,-0.05285,-0.03613,0.02663,-0.18149,-0.09828,-0.037,-0.00151,0.01222,-0.02817,-0.03112,0.15506,-0.01447,0.1654,0.12294,-0.07986,0.20857,0.12794,-0.19956,-0.09193,-0.07467,0.15303,0.00437,-0.05683,-0.05567,-0.07403,-0.12704,0.23552,-0.12369,-0.05635,0.36125,-0.25155,-0.00154,0.08676,-0.09258,-0.08574,-0.05154,0.14183,-0.37718,-0.46893,0.46026,0.13298,-0.10782,-0.20137,-0.21357,-0.07307,-0.50306,0.13298,-0.23108,-0.17701,0.18029,-0.0636,0.40209,0.27854,0.23207,-0.50306,-0.1045,-0.06723,0.12495,0.52191,-0.25359,0.06932,-0.24138,0.03686,-0.43768,0.26176,-0.54604,0.08361,-0.42465,-0.66265,0.0,-0.3942,-0.51857,-0.52412,-0.34917,-0.78148,-0.6308,-0.08053,-0.03052,-0.08501,0.92333,-0.24806,-0.1848,-0.33146,-0.29326,-0.20676,-0.26215,-0.06393,-0.16471,-0.27773,-0.03672,-0.04843,-0.03219,-0.25337,0.07413,-0.36694,-0.0461,-0.38495,-0.08191,0.08069,0.04584,0.19152,-0.45734,-0.88628,-0.51451,-0.5971,-0.57157,-0.62216,-0.84649,-0.42795,-0.3977,-0.59701,-0.19963,0.0,-0.58408,0.0,0.21996,-0.14764,-0.12267,-0.25902,0.27742,-0.27909,-0.09583,0.55098,-0.12074,0.02383,-0.23582,-0.14838,0.06791,-0.10888,-0.40646,-0.19382,-0.13194,0.07867,-0.12821,0.09307,-0.10408,0.17729,-0.12704,0.10997,0.27742,-0.29974,-0.08674,-0.09771,-0.13425,-0.02419,-0.01835,-0.10863,0.02223,-0.04734,-0.21995,-0.20649,-0.16604,-0.02289,-0.17162,-0.1915,-0.14391,-0.09029,0.40277,-0.24886,-0.12582,-0.16415,-0.23478,-0.26903,-0.2323,-0.30412,-0.07346,-0.42739,-0.30032,-0.28646,-0.15704,-0.37435,-0.22129,-0.17644,-0.17911,-0.32896,-0.3481,-0.24646,-0.19693,0.21453,-0.20059,-0.15917,-0.25742,0.00402,-0.21935,-0.11502,-0.22288,-0.20893,-0.30326,-0.32077,-0.20213,-0.22507,-0.18776,-0.19616,-0.31093,-0.0869,-0.17528,-0.19352,-0.31356,-0.30742,0.21299,-0.19568,-0.09073,-0.21258,-0.32472,-0.13102,-0.21602,-0.26298,-0.20915,-0.31581,-0.22996,-0.31571,-0.28375,-0.07588,0.024,-0.34006,-0.09374,-0.29938,-0.03002,-0.16433,-0.32255],-9.76607,"L"]},"0":[{"00":[]}],"1":[{"00":[]}]},
           dco_ai_revision: 56, 
           dco_ai_id: 292487, 
           dco_ai_score_level: null,
           dco_ai_thresholds: [],
           dco_templates: [["gas",100,[[["A0",1]]]],["hybrid",0,[[["A0",1]]]]],
           dco_defaults: {"iid":-1,"utmtr":-1,"mm_dma":-1,"s_width":-1,"s_height":-1,"s_ratio":"-1.0","fc_imp_chk":-2,"fc_time_chk":-2,"os_name":"_","model":"_","hardware":"_","mm_isp":"_","mm_asn":-1,"prizm":-1,"psycle":-1,"connexion":-1},
           dco_na_filers: {"iid":0,"utmtr":0,"mm_dma":0,"s_width":0,"s_height":0,"s_ratio":0,"fc_imp_chk":-1,"fc_time_chk":-1,"os_name":"-","model":"-","hardware":"-","mm_isp":"-","mm_asn":0,"prizm":0,"psycle":0,"connexion":0},
           dco_mode: "v2"
           //#DATA: DCO AI: END
		}
	},		   
		   
	{
		alias:"bstvr",
		settings:{
			dco_best_variation:"clinical.*",
		},
		dco:null
	},
	{
		alias:"clstr",
		settings:{
			
		},
		
		//#DATA: CLUSTERS AI
		clusters:
			{
				clusters_ai_id:0,
				clusters_ai_version:0,
				clusters_ai_features:null,
				clusters_ai_clusters:null,
				clusters_ai_templates:null,
				clusters_ai_defaults:null
			},

		//#DATA: CLUSTERS AI: END
	},
	{
		alias:"rndplus",
		dco:null,
		clusters:null
	}
];
var adxcel_default_line	= adxcel_lines[0];
var adxcel_selected_line = adxcel_default_line;
var ua = navigator.userAgent.toLowerCase();
if(!adxcel_selected_line){
	adxcel_selected_line = adxcel_default_line;
}	
adxcel_selected_line.settings.rev = adxcel_selected_line.dco.revision;
var adxcel_line_bestvar = adxcel_lines[1];
var adxcel_line_cluster = adxcel_lines[2];
var adxcel_line_rndplus = adxcel_lines[3];
//#MULTI LINES: END

//SETTINGS
window.adxcel_settings = {
	//beeswax_tag_id: ["purchase",0, "signup",0, "registration",0, "lead",0, "content",0, "misc",0],
	//beeswax_segment_keys: [],
	//beeswax_user_id_type: null,
	//beeswax_account_id:null
	
	//TODO 3/11
	tag_script_pattern: "663367.js",
	
	//TODO 4/11
	item_id: 663367,
	ga_adname: "663367",
	ga_account: "ua-00052325-91753475312441",
	pnd_ctrk: null,
	pixid: "03db4a80-c719-4e44-a083-3282e53bd65c",
	
	//TODO 5/11
	defaultClickTag: "https://ad.doubleclick.net/ddm/trackclk/N51801.4766585DV3601-BANNERS/B32301022.407636189;dc_trk_aid=618550713;dc_trk_cid=238493083;dc_dbm_token=__DC_DBM_TOKEN__;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=;gdpr=__GDPR__;gdpr_consent=__GDPR_CONSENT_755__;gpp=__GPP_STRING_755__;gpp_sid=__GPP_SID__;ltd=;dc_tdv=1",
	
	frame_base: "https://cf.artsai.com/campaigns/claritas/assets/",
	debug_frame_base: "https://cf.artsai.com/campaigns/claritas/assets/",
	
	//TODO 7/11
	//variations
	"variations": [
		["gas", 100, 
			[
				[
					["A0", 1]
				]
			]
		],
		["hybrid", 0, 
			[
				[
					["A0", 1]
				]
			]
		]
	] //variations
	,
	
	//TODO 8/11
	use_bimp: false,
	trackers: {
		imp: ["https://ad.doubleclick.net/ddm/trackimp/N51801.4766585DV3601-BANNERS/B32301022.407636189;dc_trk_aid=618550713;dc_trk_cid=238493083;ord=[timestamp];dc_dbm_token=__DC_DBM_TOKEN__;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=;gdpr=__GDPR__;gdpr_consent=__GDPR_CONSENT_755__;gpp=__GPP_STRING_755__;gpp_sid=__GPP_SID__;ltd=;dc_tdv=1?",
			"https://pixel.adsafeprotected.com/rfw/st/1493775/83387741/skeleton.gif?gdpr=__GDPR__&gdpr_consent=__GDPR_CONSENT_278__&gdpr_pd=__GDPR_PD__&bundleId=__BUNDLE_ID__&bidurl=__SOURCE_URL_ENC__"],
		fclick: "",
		dest: ""
	},

	//TODO 8+/11
	domain_mapping:{
		"cfg":"cfg.arttrk.com"
	},

	system_trackers: [
			{ events: "imp1", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%%SETTINGS_PIX_ID%" },
			{ events: "dest", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "fclick", pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%%SETTINGS_PIX_ID%" },
			{ events: "error", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=error&msg=%ENC_U1_LABEL%" },
			{ events: "view", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "show_native", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "show_omid", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "omid_not_supp", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "show", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" },
			{ events: "show_unmsrble", 	pixel: "https://arttrk.com/pixel/?ad_log=%GA_CODE%&src=%CATEGORY%&tag=%ACTION%&msg=%ENC_U1_LABEL%" }
		],
	
	inc_wfxzp:false,
	inc_segm:true,
	inc_aip:true,
	inc_zip5:true,
	use_slots:false,
	
	msgAddonProps: ["msg_addon"],
	msgAddon:null,
	
	//engine:"tag_core_pnd_v1.js",
	engine: "",
	
	"rev":1,
	//exception, static, random, dco,bstvr,clustters, rnd+
	revisions:[1,2,3,99,5,7,4],
	//TODO 9/11
	revisionsWeights:[0,0,0,0,0,0,100],
	revisionCompare_variation: null,
	revisionsWeightsSkipUpdate:true,
	revisionsWeightsMode:"a/b best",

	defaultTargeting: "",

	ga_accountByVars: {
		//one for all - need single table for opts
	},
	
	dataByCondition: [
		{
			"defaultTargeting": "web",
			"condition": {
				"osin": null,
				"platformin": ["web"]
			},
			"type":"targeting"
		},
		
		{
			"defaultTargeting": "ios_app",
			"condition": {
				"osin": ["ios"],
				"platformin": ["app"]
			},
			"type":"targeting"
		},
		{
			"defaultTargeting": "adr_app",
			"condition": {
				"osin": ["adr"],
				"platformin": ["app"]
			},
			"type":"targeting"
		},
		{
		  "defaultClickTag": "",
		  "condition": {
		   "zipin": [
		   /* 56358,
			56353*/
		   ]
		  }
		 }
	],

	clickTagByVars: {
//		"gas":"",
//		"hybrid":""
	},
	defaultCampaign: "", //e.g. t=123,
	campaignsByVars: {
		//
	},
	banner_url: "",
	def_adxvrs: "gas|hybrid",
	modes: ["0"],

	adxvrs: [],

	useClickPrepend: true, // true by default
	useOpenSafari: false,
	usePhone: false,	// false by default
	variation_settings: {
		static: {
			mode: 0
		}
	},

	//{{dco
	dco: null,
	//}}dco

	//variations_fixed
	"variations_fixed": [
	] //variations_fixed
	,

	//variations_exclude
	"variations_exclude": ["hybrid.A0"
	] //variations_exclude
	,
	dco_ai_excludes: {templates:[1],combinations: {1: [{0: [0]}]}},


	targeting: {
		settings: {
			"web": {},
			"ios_app": {},
			"adr_app": {}
		},
		content: {
			//
		}
	},

	trackURLByVars: {
		//"static": ""
	},
	
	scripttrackers: {
		//imp: "",
		//fclick: ""
	},

	scriptTrackURLByVars: {
		//"static.A0": "",
		//"static": ["",""]
	},

	iframeTrackURLByVars: {
		//"static.A0": "",
		//"static": ["",""]
	},
	
	animContent: {}
	
};
window.adxcel_settings.variations_raw = window.adxcel_settings.variations;
window.adxcel_settings.revisions[3] = window.adxcel_settings.rev;

if(window.adxcel_settings.system_trackers){
	window.adxcel_settings.system_trackers.forEach(function(rec){
		if(rec.pixel){
			var prop = "%SETTINGS_PIX_ID%";
			var value = window.adxcel_settings.pixid;
			rec.pixel = rec.pixel.replace( prop, (value?("&pixid="+value):"") );
		}
	});
}


//adxcel_settings_raw in createAd

//CONTENT
var app = {content:{}};
window.adxcel_settings.content = app.content;
	
	app.content.gas = [
	{
		alias: "A",
		description: "Image",
		templateName: "Template 1: Gas",
		vars: [
		{
			alias: "0",
			description: "Gas",
			content: {
	"#image_gas728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/gas_bndl/Image_1_gas728_v1.jpg" },
	"#foreground_gas728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/gas_bndl/Foreground_gas728_v1.png" },
	"#headline_gas728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/gas_bndl/Headline_11_gas728_v1.png" }
			}
		}
		]
	}
	]; //app.content.gas
	app.content.hybrid = [
	{
		alias: "A",
		description: "Image",
		templateName: "Template 2: Hybrid",
		vars: [
		{
			alias: "0",
			description: "Hybrid",
			content: {
	"#image_hybrid728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/hybrid_bndl/Image_1_hybrid728_v1.jpg" },
	"#foreground_hybrid728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/hybrid_bndl/Foreground_hybrid728_v1.png" },
	"#headline_hybrid728_v1": { "style": { "display": "inline" }, "data-src": "motion_mazda_bndl_v4/hybrid_bndl/Headline_11_hybrid728_v1.png" }
			}
		}
		]
	}
	]; //app.content.hybrid



//
//platform check
function getPlatform() {
	var idfa = UrlParam("idfa", ""),
		device_id = UrlParam("device_id", ""),
		ua = navigator.userAgent.toLowerCase(),
		platform = "web";	
	if (ua.indexOf("android") > -1) {
		platform = "app";
	} else if (ua.match(/iphone/i)) {
		platform = "app";
	} else if (ua.match(/ipod/i)) {
		platform = "app";
	} else if (ua.match(/ipad/i)) {
		platform = "app";
	}
	return platform;
};
window.platform = getPlatform();

function UrlParamFrom (name, _default, href) {
	var value = null;
	//web dco -- part 1
	if(name == "ctp" && window.platform == "web"){
		var si = href.indexOf("ctp=");
		var ei = href.indexOf("&adurl=", si + 1 );
		if(si != -1 && ei != -1 && ei > si){
			si += 4;
			value = href.substr(si, ei-(si)) + "&adurl=";
		}else{
			//if encoded
			ei = href.indexOf(encodeURIComponent("&adurl="), si + 1 );
			if(si != -1 && ei != -1 && ei > si){
				si += 4;
				value = href.substr(si, ei-(si)) + encodeURIComponent("&adurl=");
			}
		}
		if(value){
			return value;
		}else{
			name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
			var regexS = "[\\?&]" + name + "=([^&#]*)";
			var regex = new RegExp(regexS);
			var results = regex.exec(href);
			if (results == null)
				return _default;
			else
				return results[1];
		}
	}else{
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regexS = "[\\?&]" + name + "=([^&#]*)";
		var regex = new RegExp(regexS);
		var results = regex.exec(href);
		if (results == null)
			return _default;
		else
			return results[1];
	}
};

function UrlParam (name, _default) {
	var scripts = document.getElementsByTagName("script");
	for (var i = 0, val; i < scripts.length; ++i) {
		var src = scripts[i].src;
		if (!src) continue;
		var ind = src.indexOf("?");
		var coresrc = (ind != -1) ? src.substr(0, ind) : src;
		if (coresrc.indexOf(adxcel_settings.tag_script_pattern) + adxcel_settings.tag_script_pattern.length == coresrc.length) {
			if (!window.url_request && scripts[i].src) {
				var parts = scripts[i].src.split("?", 2);
				window.url_request = parts[1];
			}
			val = UrlParamFrom(name, _default, scripts[i].src);
			if (val !== _default)
				return val;
		}
	}
	return _default;
};


//LAYOUT
window.adxcel_settings.smartad_active = false;

adxcel_settings.animContent = {
	static: ""
};

//	adxcel_str += '<div id="' + adxcel_id + 'enginebox" style="position:absolute; dysplay:none; width:1px; height:1px; left:0px; top:0px;"></div>';

var adxcel_str = "";

//dfp 272

//where to
var user_device_id = UrlParam("device_id", UrlParam("consumer_id", ""));
if (user_device_id == "andr" || (user_device_id && user_device_id != "__GAID__")) {
	adxcel_str += '<div id="' + adxcel_id + 'animbox" style="position:absolute; width:748px; height:110px; left:0px; top:0px;"></div>';
	adxcel_str += '<div id="' + adxcel_id + 'enginebox" style="position:absolute; dysplay:none; width:1px; height:1px; left:0px; top:0px;"></div>';
} else {
	adxcel_str += '<div id="' + adxcel_id + 'animbox" style="position:absolute; width:728px; height:90px; left:0px; top:0px;"></div>';
	adxcel_str += '<div id="' + adxcel_id + 'enginebox" style="position:absolute; dysplay:none; width:1px; height:1px; left:0px; top:0px;"></div>';
}

var nature = UrlParam("nature", "");
//where to
adxcel_str += '<A id="' + adxcel_id + 'href" target="_blank">';

var local_is_debug = UrlParam("debug", "");
local_is_debug = local_is_debug == "1" || local_is_debug == "true"
if(window.adxcel_settings.use_bimp && !local_is_debug){
	adxcel_str += '<img style="display:none; overflow:hidden; position:absolute; width:1px; height:1px;" src="'+'https://arttrk.com/pixel/?ad_log='+window.adxcel_settings.ga_account+'&src=&tag=bimp&msg='+'"/>';
}

adxcel_str += '<div id="' + adxcel_id + 'hrefbox" style="display:none; overflow:hidden; position:absolute; width:728px; height:90px; ';
//ADSWIZZ AUDIO have display container greater by 20px, so left/top:10px added.
adxcel_str += (nature == "adswizz") ? 'left:10px; top:10px; opacity:1">' : 'left:0px; top:0px; opacity:1">';
adxcel_str += '<div id="' + adxcel_id + 'container" style="overflow:hidden; position:absolute; width:728px; height:90px; left:0px; top:0px; opacity:1">';

//TODO 11/11
//gas
var anim_str = "";
anim_str += '<style type="text/css">';
anim_str += '.scale_image { -webkit-transform-origin: top left; -webkit-transform: scale(0.5, 0.5); transform-origin: top left; transform: scale(0.5, 0.5); width: 1456px !important; height: 180px !important; }';
anim_str += '@font-face { font-family: "mazdamedium"; src: url("https://cf.artsai.com/campaigns/claritas/assets/motion_mazda_bndl_v4/MazdaType-Medium.otf"); font-display: swap; }';
anim_str += '@font-face { font-family: "mazdabold"; src: url("https://cf.artsai.com/campaigns/claritas/assets/motion_mazda_bndl_v4/MazdaType-Bold.otf"); font-display: swap; }';
anim_str += '.class_hide { display: none !important; opacity: 0; }';
anim_str += '.class_show { display: block !important; opacity: 1; }';
anim_str += '.class_flex { display: flex !important; }';
anim_str += '.class_flex_show { opacity: 1 !important; }';
anim_str += '.class_hide_zindex { z-index: -50 !important; }';
anim_str += '.class_show_zindex { z-index: 50 !important; }';
anim_str += '.draw_dark { color: #000000 !important; }';
anim_str += '.class_collapse { width: 0px !important; height: 0px !important; }';
anim_str += '.border_dark { border: 1px solid #000000 !important; }';
anim_str += '.border_dark:hover { border: 1px solid #000000 !important; background: rgba(0,0,0,.9) !important; color: #ffffff !important; }';
anim_str += '.show_element { display: flex !important; opacity: 1 !important; }';
anim_str += '.hide_element { opacity: 0 !important; }';
anim_str += '* { margin: 0px; padding: 0px; border: 0px; outline: none; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; -moz-user-select: none; -webkit-user-select: none; user-select: none; }';
anim_str += 'div, img { margin: 0px; padding: 0px; border: 0px; outline: none; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; display: block; }';
anim_str += '.wrapper_animation_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; overflow: hidden; -webkit-transform-origin: 0px 0px; }';
anim_str += '.image_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
anim_str += '.foreground_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
anim_str += '.headline_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
/* button */
anim_str += '.wrapper_button_gas728_v1 { position: absolute; width: 90px; height: 24px; left: 600px; top: 33px; overflow: hidden; -webkit-animation: "wrapper_button_gas728_v1" 10000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; display: flex; align-items: start; justify-content: center; }';
anim_str += '.link_button_gas728_v1 { width: 260px; height: 24px; left: 0px; top: 0px; overflow: hidden; text-decoration: none !important; }';
anim_str += '.button_gas728_v1 { width: 260px; height: 24px; left: 0px; top: 0px; overflow: hidden; -webkit-animation: "wrapper_button_gas728_v1" 10000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; border: 1px solid #ffffff; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 12px; line-height: 24px; text-transform: uppercase; justify-content: center; letter-spacing: 2px; -webkit-border-radius: 4px; border-radius: 4px; }';
anim_str += '.button_gas728_v1:hover { border: 1px solid #ffffff; color: #000000; background: rgba(255,255,255,.9) }';
//anim_str += '@-webkit-keyframes wrapper_button_gas728_v1 { 0% { width: 0px; } 54% { width: 0px; } 55% { width: 144px; } 100% { width: 144px; } }';
//anim_str += '@-webkit-keyframes link_button_gas728_v1 { 0% { opacity: 0; } 55% { opacity: 0; } 60% { opacity: 1; } 100% { opacity: 1; } }';
/* legal */
anim_str += '.wrapper_legal_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; background: #2b2b2b; z-index: 200; }';
anim_str += '.inner_legal_1_gas728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; display: flex; justify-content: center; align-items: center; }';
anim_str += '.wrapper_legal_button_gas728_v1 { position: absolute; width: 30px; height: 13px; left: 695px; top: 75px; background: none; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 8px; line-height: 13px; letter-spacing: 1px; text-align: center; text-transform: uppercase; cursor: pointer; }';
anim_str += '.wrapper_legal_text_11_gas728_v1 { position: absolute; width: 758px; left: 0px; top: 0px; padding: 5px 85px 5px 5px; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 10px; letter-spacing: 1px; display: flex !important; justify-content: center; align-items: center; -webkit-animation: "wrapper_headline_11_gas728_v1" 14000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; flex-direction: column; overflow: auto; }';
anim_str += '.wrapper_legal_close_gas728_v1 { position: absolute; top: 7px; left: 705px; width: 20px; height: 20px; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 12px; line-height: 20px; letter-spacing: 1px; text-align: center; text-transform: uppercase; cursor: pointer; }';
anim_str += '.wrapper_legal_text_11_gas728_v1 p { margin: 3px 0px 3px 0px; }';
/* scrollbar */
anim_str += '.wrapper_scrollbar_gas728_v1 { position: absolute; left: 685px; top: 4px; width: 2px; background: #949494; height: 82px; }';
anim_str += '.scrollbar_gas728_v1 { position : absolute; left: -3px; top: 0px; height: 22px; border-radius: 4px; width: 8px; background-color: #f8f8f8; border: 1px solid transparent; cursor: pointer; }';
anim_str += '</style>';
adxcel_settings.animContent.gas = anim_str;
adxcel_str += '<div id="' + adxcel_id + '_wrapper_animation_gas728_v1" style="display:inline" class="wrapper_animation_gas728_v1">';

	adxcel_str += '<img id="' + adxcel_id + '_image_gas728_v1" style="display:none" class="image_gas728_v1 scale_image">';
	adxcel_str += '<img id="' + adxcel_id + '_foreground_gas728_v1" style="display:none" class="foreground_gas728_v1 scale_image">';
	adxcel_str += '<img id="' + adxcel_id + '_headline_gas728_v1" style="display:none" class="headline_gas728_v1 scale_image">';

adxcel_str += '</div>';
//gas

//hybrid
var anim_str = "";
anim_str += '<style type="text/css">';
anim_str += '.scale_image { -webkit-transform-origin: top left; -webkit-transform: scale(0.5, 0.5); transform-origin: top left; transform: scale(0.5, 0.5); width: 1456px !important; height: 180px !important; }';
anim_str += '@font-face { font-family: "mazdamedium"; src: url("https://cf.artsai.com/campaigns/claritas/assets/motion_mazda_bndl_v4/MazdaType-Medium.otf"); font-display: swap; }';
anim_str += '@font-face { font-family: "mazdabold"; src: url("https://cf.artsai.com/campaigns/claritas/assets/motion_mazda_bndl_v4/MazdaType-Bold.otf"); font-display: swap; }';
anim_str += '.class_hide { display: none !important; opacity: 0; }';
anim_str += '.class_show { display: block !important; opacity: 1; }';
anim_str += '.class_flex { display: flex !important; }';
anim_str += '.class_flex_show { opacity: 1 !important; }';
anim_str += '.class_hide_zindex { z-index: -50 !important; }';
anim_str += '.class_show_zindex { z-index: 50 !important; }';
anim_str += '.draw_dark { color: #000000 !important; }';
anim_str += '.class_collapse { width: 0px !important; height: 0px !important; }';
anim_str += '.border_dark { border: 1px solid #000000 !important; }';
anim_str += '.border_dark:hover { border: 1px solid #000000 !important; background: rgba(0,0,0,.9) !important; color: #ffffff !important; }';
anim_str += '.show_element { display: flex !important; opacity: 1 !important; }';
anim_str += '.hide_element { opacity: 0 !important; }';
anim_str += '* { margin: 0px; padding: 0px; border: 0px; outline: none; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; -moz-user-select: none; -webkit-user-select: none; user-select: none; }';
anim_str += 'div, img { margin: 0px; padding: 0px; border: 0px; outline: none; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; display: block; }';
anim_str += '.wrapper_animation_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; overflow: hidden; -webkit-transform-origin: 0px 0px; }';
anim_str += '.image_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
anim_str += '.foreground_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
anim_str += '.headline_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; }';
/* button */
anim_str += '.wrapper_button_hybrid728_v1 { position: absolute; width: 90px; height: 24px; left: 600px; top: 33px; overflow: hidden; -webkit-animation: "wrapper_button_hybrid728_v1" 10000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; display: flex; align-items: start; justify-content: center; }';
anim_str += '.link_button_hybrid728_v1 { width: 260px; height: 24px; left: 0px; top: 0px; overflow: hidden; text-decoration: none !important; }';
anim_str += '.button_hybrid728_v1 { width: 260px; height: 24px; left: 0px; top: 0px; overflow: hidden; -webkit-animation: "wrapper_button_hybrid728_v1" 10000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; border: 1px solid #ffffff; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 12px; line-height: 24px; text-transform: uppercase; justify-content: center; letter-spacing: 2px; -webkit-border-radius: 4px; border-radius: 4px; }';
anim_str += '.button_hybrid728_v1:hover { border: 1px solid #ffffff; color: #000000; background: rgba(255,255,255,.9) }';
//anim_str += '@-webkit-keyframes wrapper_button_hybrid728_v1 { 0% { width: 0px; } 54% { width: 0px; } 55% { width: 144px; } 100% { width: 144px; } }';
//anim_str += '@-webkit-keyframes link_button_hybrid728_v1 { 0% { opacity: 0; } 55% { opacity: 0; } 60% { opacity: 1; } 100% { opacity: 1; } }';
/* legal */
anim_str += '.wrapper_legal_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; background: #2b2b2b; z-index: 200; }';
anim_str += '.inner_legal_1_hybrid728_v1 { position: absolute; width: 728px; height: 90px; left: 0px; top: 0px; display: flex; justify-content: center; align-items: center; }';
anim_str += '.wrapper_legal_button_hybrid728_v1 { position: absolute; width: 30px; height: 13px; left: 695px; top: 75px; background: none; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 8px; line-height: 13px; letter-spacing: 1px; text-align: center; text-transform: uppercase; cursor: pointer; }';
anim_str += '.wrapper_legal_text_11_hybrid728_v1 { position: absolute; width: 758px; left: 0px; top: 0px; padding: 5px 85px 5px 5px; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 10px; letter-spacing: 1px; display: flex !important; justify-content: center; align-items: center; -webkit-animation: "wrapper_headline_11_hybrid728_v1" 14000ms cubic-bezier(0.33, 1, 0.68, 1) 1 forwards; flex-direction: column; overflow: auto; }';
anim_str += '.wrapper_legal_close_hybrid728_v1 { position: absolute; top: 7px; left: 705px; width: 20px; height: 20px; text-align: center; color: #ffffff; font-family: "mazdamedium", "Arial" !important; font-size: 12px; line-height: 20px; letter-spacing: 1px; text-align: center; text-transform: uppercase; cursor: pointer; }';
anim_str += '.wrapper_legal_text_11_hybrid728_v1 p { margin: 3px 0px 3px 0px; }';
/* scrollbar */
anim_str += '.wrapper_scrollbar_hybrid728_v1 { position: absolute; left: 685px; top: 4px; width: 2px; background: #949494; height: 82px; }';
anim_str += '.scrollbar_hybrid728_v1 { position : absolute; left: -3px; top: 0px; height: 22px; border-radius: 4px; width: 8px; background-color: #f8f8f8; border: 1px solid transparent; cursor: pointer; }';
anim_str += '</style>';
adxcel_settings.animContent.hybrid = anim_str;
adxcel_str += '<div id="' + adxcel_id + '_wrapper_animation_hybrid728_v1" style="display:inline" class="wrapper_animation_hybrid728_v1">';

	adxcel_str += '<img id="' + adxcel_id + '_image_hybrid728_v1" style="display:none" class="image_hybrid728_v1 scale_image">';
	adxcel_str += '<img id="' + adxcel_id + '_foreground_hybrid728_v1" style="display:none" class="foreground_hybrid728_v1 scale_image">';
	adxcel_str += '<img id="' + adxcel_id + '_headline_hybrid728_v1" style="display:none" class="headline_hybrid728_v1 scale_image">';

adxcel_str += '</div>';
//hybrid

adxcel_str += '</div>';
adxcel_str += '</div>';

//overlay
adxcel_str += '<div id="' + adxcel_id + 'overlay" style="display:inline; overflow:hidden; position:absolute; width:728px; height:90px; left:0px; top:0px; opacity:0.0;background:#FFFFFF;"></div>';


adxcel_str += '</A>';
///////////////////////////////////////////////////////////////////////////////////////////////////////////
//q1w2e3r4
adxcel_str += '<div id="' + adxcel_id + '_wrapper_button_gas728_v1" style="display:none" class="wrapper_button_gas728_v1">';
adxcel_str += '<a id="' + adxcel_id + '_link_button_gas728_v1" data-wrapper="gas" data-hrefbox="1" data-initiator="gas" href="" target="_blank" style="display:flex" class="link_button_gas728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_button_gas728_v1" data-hrefbox="1" data-initiator="gas" style="display:flex" class="button_gas728_v1">';
adxcel_str += '</div>';
adxcel_str += '</a>';
adxcel_str += '</div>';

/* legal gas begin */
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_button_gas728_v1" data-wrapper="gas_legal_button" style="display:none" class="wrapper_legal_button_gas728_v1">Legal</div>';
/* legal gas end */
/* begin wrapper legal */
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_gas728_v1" data-wrapper="gas_legal_text" style="display:none" class="wrapper_legal_gas728_v1 class_hide class_hide_zindex">';

adxcel_str += '<div id="' + adxcel_id + '_inner_legal_1_gas728_v1" style="display:inline" class="inner_legal_1_gas728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_text_11_gas728_v1" style="display:inline" class="wrapper_legal_text_11_gas728_v1"><p>1.9% Annual Percentage Rate (APR) available for 60 months on approved credit only for very well-qualified customers when financing a new 2025 Mazda CX-50 through Mazda Financial Services at participating Mazda Dealers. Not all customers will qualify for credit approval or advertised APR. Amount of down payment and other factors may affect qualification. Dealer contribution may vary and could affect purchase price and amount to be financed. 60 months at $17.48 per month per $1,000 financed with $0 down at participating Mazda Dealers. Tax, title, license, other options, loan origination fees and dealer fees may apply. APR offer only available for dealers in the United States regardless of buyer&rsquo;s residency. Restrictions may apply; void where prohibited. This offer is only available on participating Mazda Dealer&rsquo;s current inventory, which is subject to availability. Offer ends 9/30/25 and you must take delivery prior to expiration of offer. See participating Mazda Dealer for complete details. The trade name "Mazda Financial Services" and the Mazda and Mazda Financial Services logos are owned by Mazda Motor Corporation (Mazda) or its affiliates and are licensed to Toyota Motor Credit Corporation (TMCC). Retail installment accounts may be owned by TMCC, Toyota Financial Savings Bank d/b/a MobilityOne Financial (M1F), or their respective securitization affiliates. Lease accounts may be owned by Toyota Lease Trust (TLT), MobilityOne Lease Trust (M1LT), or their respective securitization affiliates. TMCC is the servicer for accounts owned by TMCC, M1F, TLT, M1LT, and their respective securitization affiliates. Mazda is solely responsible for its products and services and promotional statements. Mazda is not affiliated with TMCC, M1F, TLT, M1LT, or their affiliates. Retail accounts and leases through Mazda Financial Services are subject to credit approval by TMCC or M1F.<br><br>$1,000 Customer Cash available on a new 2025 Mazda CX-50. Offer available in lieu of Mazda Financial Services special finance or special lease programs. No cash value. Offer only available at dealers in the United States regardless of buyer&rsquo;s residency. Restrictions may apply; void where prohibited. Offer is only available on participating Mazda Dealer&rsquo;s current inventory, which is subject to availability. Offer ends 9/30/25 and you must take delivery prior to expiration of offer. See participating Mazda Dealer for complete details.</p>';
adxcel_str += '</div>';
adxcel_str += '<div id="' + adxcel_id + '_wrapper_scrollbar_gas728_v1" class="wrapper_scrollbar_gas728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_scrollbar_gas728_v1" class="scrollbar_gas728_v1">';
adxcel_str += '</div></div>';
adxcel_str += '</div>';

adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_close_gas728_v1" style="display:inline" class="wrapper_legal_close_gas728_v1">x</div>';
adxcel_str += '</div>';
/* end wrapper legal */



adxcel_str += '<div id="' + adxcel_id + '_wrapper_button_hybrid728_v1" style="display:none" class="wrapper_button_hybrid728_v1">';
adxcel_str += '<a id="' + adxcel_id + '_link_button_hybrid728_v1" data-wrapper="hybrid" data-hrefbox="1" data-initiator="hybrid" href="" target="_blank" style="display:flex" class="link_button_hybrid728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_button_hybrid728_v1" data-hrefbox="1" data-initiator="hybrid" style="display:flex" class="button_hybrid728_v1">';
adxcel_str += '</div>';
adxcel_str += '</a>';
adxcel_str += '</div>';


/* legal gas begin */
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_button_hybrid728_v1" data-wrapper="hybrid_legal_button" style="display:none" class="wrapper_legal_button_hybrid728_v1">Legal</div>';
/* legal hybrid end */
/* begin wrapper legal */
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_hybrid728_v1" data-wrapper="hybrid_legal_text" style="display:none" class="wrapper_legal_hybrid728_v1 class_hide class_hide_zindex">';

adxcel_str += '<div id="' + adxcel_id + '_inner_legal_1_hybrid728_v1" style="display:inline" class="inner_legal_1_hybrid728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_text_11_hybrid728_v1" style="display:inline" class="wrapper_legal_text_11_hybrid728_v1"><p>1.9% Annual Percentage Rate (APR) available for 60 months on approved credit only for very well-qualified customers when financing a new 2025 Mazda CX-50 Hybrid through Mazda Financial Services at participating Mazda Dealers. Not all customers will qualify for credit approval or advertised APR. Amount of down payment and other factors may affect qualification. Dealer contribution may vary and could affect purchase price and amount to be financed. 60 months at $17.48 per month per $1,000 financed with $0 down at participating Mazda Dealers. Tax, title, license, other options, loan origination fees and dealer fees may apply. APR offer only available for dealers in the United States regardless of buyer&rsquo;s residency. Restrictions may apply; void where prohibited. This offer is only available on participating Mazda Dealer&rsquo;s current inventory, which is subject to availability. Offer ends 9/30/25 and you must take delivery prior to expiration of offer. See participating Mazda Dealer for complete details. The trade name "Mazda Financial Services" and the Mazda and Mazda Financial Services logos are owned by Mazda Motor Corporation (Mazda) or its affiliates and are licensed to Toyota Motor Credit Corporation (TMCC). Retail installment accounts may be owned by TMCC, Toyota Financial Savings Bank d/b/a MobilityOne Financial (M1F), or their respective securitization affiliates. Lease accounts may be owned by Toyota Lease Trust (TLT), MobilityOne Lease Trust (M1LT), or their respective securitization affiliates. TMCC is the servicer for accounts owned by TMCC, M1F, TLT, M1LT, and their respective securitization affiliates. Mazda is solely responsible for its products and services and promotional statements. Mazda is not affiliated with TMCC, M1F, TLT, M1LT, or their affiliates. Retail accounts and leases through Mazda Financial Services are subject to credit approval by TMCC or M1F.<br><br>$1,000 Customer Cash available on a new 2025 Mazda CX-50 Hybrid. Offer available in lieu of Mazda Financial Services special finance or special lease programs. No cash value. Offer only available at dealers in the United States regardless of buyer&rsquo;s residency. Restrictions may apply; void where prohibited. Offer is only available on participating Mazda Dealer&rsquo;s current inventory, which is subject to availability. Offer ends 9/30/25 and you must take delivery prior to expiration of offer. See participating Mazda Dealer for complete details.</p>';
adxcel_str += '</div>';
adxcel_str += '<div id="' + adxcel_id + '_wrapper_scrollbar_hybrid728_v1" class="wrapper_scrollbar_hybrid728_v1">';
adxcel_str += '<div id="' + adxcel_id + '_scrollbar_hybrid728_v1" class="scrollbar_hybrid728_v1">';
adxcel_str += '</div></div>';
adxcel_str += '</div>';

adxcel_str += '<div id="' + adxcel_id + '_wrapper_legal_close_hybrid728_v1" style="display:inline" class="wrapper_legal_close_hybrid728_v1">x</div>';
adxcel_str += '</div>';
/* end wrapper legal */
///////////////////////////////////////////////////////////////////////////////////////////////////////////
adxcel_str += '</div>';
document.write(adxcel_str);


window.adxcel_id = adxcel_id;
window.adxcel_messaging_support = false;

//ENGINE
setTimeout(function(){
	//show layout in any case
	var hrefbox = document.getElementById(adxcel_id + "hrefbox");
	if(hrefbox) hrefbox.style.display="inline";
	var container = document.getElementById(adxcel_id + "container");
	if(container) container.style.display="inline";
	
},2000);
function tryIncludeAdxcelTagEngine(cnt){
	if(cnt){
		var engine = document.createElement("SCRIPT");
		engine.src = window.adxcel_settings.engine;
		cnt.appendChild(engine);
	}
}

var settings = window.adxcel_settings;
if(settings.engine && false){	
	var cnt = document.getElementById(adxcel_id + "enginebox");
	if(!cnt){
		setTimeout(function(){
			var cnt = document.getElementById(adxcel_id + "enginebox");
			if(!cnt) cnt = document.body;
			if(cnt){
				tryIncludeAdxcelTagEngine(cnt);
			}
		},1000);
	}else{
		tryIncludeAdxcelTagEngine(cnt);
	}
}


//----------------------------------
//#INCLUDE ENGINE
window.adxcel_tag_engine = "ibmv1.0.9";
window.adxcel_tag_engine_review = "20211020.1";
if(!window.adxcel_time0){
	window.adxcel_time0 = new Date().getTime();
}
if(!window.adxcel_time_stamps){
	window.adxcel_time_stamps = [];
}
//1
window.adxcel_time_stamps.push(new Date().getTime() - window.adxcel_time0);

if(window.__ad___macros_data || window.adxcel_macros_data){
	window.adxcel_macros_data = window.__ad___macros_data ? window.__ad___macros_data : window.adxcel_macros_data;
	var mcrs_data = {};
	for(var prop in window.adxcel_macros_data){
		mcrs_data[prop.replace(/\\/g,"")] = window.adxcel_macros_data[prop];
	}
	window.adxcel_macros_data = mcrs_data;
}

if(window.ibm_ad_data){
	window.ibm_data_str = [];
	var  props = ["cnd","temp","dynght","cxtg_str"];
	for(var prop in window.ibm_ad_data){
		if(props.indexOf(prop)>-1){
			window.ibm_data_str.push("\"" + window.ibm_ad_data[prop]+"\"");
		}
	}
	window.ibm_data_str = window.ibm_data_str.join(",");
}

//#MODULE: ADOBE
if(window.__ad___adobe_data){window.adxcel_adobe_data = window.__ad___adobe_data;}
if(window.__ad___adobe_hash){window.adxcel_adobe_hash = window.__ad___adobe_hash;}
if(window.adxcel_adobe_data && window.adxcel_adobe_data.length>0){
	window.adxcel_adobe_data_str = [];
	window.adxcel_adobe_data.forEach(function(value){
		window.adxcel_adobe_data_str.push("\"" + value + "\"");
	});
	window.adxcel_adobe_data_str = window.adxcel_adobe_data_str.join(",");
}
//#MODULE: ADOBE: EN

//#MODULE: DV360
if(window.__ad___dv360_data){window.adxcel_dv360_data = window.__ad___dv360_data;}
if(window.__ad___dv360_hash){window.adxcel_dv360_hash = window.__ad___dv360_hash}
if(window.adxcel_dv360_data && window.adxcel_dv360_data.length>0){
	window.adxcel_dv360_data_str = [];
	window.adxcel_dv360_data.forEach(function(value){
		window.adxcel_dv360_data_str.push("\"" + value + "\"");
	});
	window.adxcel_dv360_data_str = window.adxcel_dv360_data_str.join(",");
}
if(window.__ad___dv360_auction_data){window.adxcel_dv360_auction_data = window.__ad___dv360_auction_data;}
if(window.adxcel_dv360_auction_data && window.adxcel_dv360_auction_data.length>0){
	window.adxcel_dv360_auction_data_str = [];
	window.adxcel_dv360_auction_data.forEach(function(value){
		window.adxcel_dv360_auction_data_str.push("\"" + value + "\"");
	});
	window.adxcel_dv360_auction_data_str = window.adxcel_dv360_auction_data_str.join(",");
}
//#MODULE: DV360: END

//#MODULE: XANDR
if(window.__ad___xandr_data){window.adxcel_xandr_data = window.__ad___xandr_data;}
if(window.__ad___xandr_hash){window.adxcel_xandr_hash = window.__ad___xandr_hash;}
if(window.adxcel_xandr_data && window.adxcel_xandr_data.length>0){
	window.adxcel_xandr_data_str = [];
	window.adxcel_xandr_data.forEach(function(value){
		window.adxcel_xandr_data_str.push("\"" + value + "\"");
	});
	window.adxcel_xandr_data_str = window.adxcel_xandr_data_str.join(",");
}
//#MODULE: XANDR: END

//#MODULE: TTD
if(window.__ad___ttd_data){window.adxcel_ttd_data = window.__ad___ttd_data;}
if(window.__ad___ttd_hash){window.adxcel_ttd_hash = window.__ad___ttd_hash;}
if(window.adxcel_ttd_data && window.adxcel_ttd_data.length>0){
	window.adxcel_ttd_data_str = [];
	window.adxcel_ttd_data.forEach(function(value){
		window.adxcel_ttd_data_str.push("\"" + value + "\"");
	});
	window.adxcel_ttd_data_str = window.adxcel_ttd_data_str.join(",");
}
//#MODULE: TTD: END



//#MODULE: MEDIAMATH_MACROS
if(window.mediamath_tag_params){
	window.adxcel_tag_params = window.mediamath_tag_params;
	
	window.mediamath_data_str = []
	
	var props_excluded = ["clickTag"];
	var props = [];
	for(var prop in window.mediamath_tag_params){
		if(prop && props_excluded.indexOf(prop)==-1){
			props.push(prop);
		}
	}
	props.sort();
	var is_debug = UrlParam("debug", "");
	if(is_debug=="1"||is_debug=="true"){
		console.log("mediamath props:");
		console.log(props.join(","));
	}
	for(var i=0; i<props.length; i++){
		var value = window.mediamath_tag_params[props[i]];
		window.mediamath_data_str.push("\"" + value + "\"");
	}
	window.mediamath_data_str = window.mediamath_data_str.join(",");
	
	var hashCode = function(s){
	  var vl = "";
	  try{
		  vl = s.split("").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)
	  }catch(e){
		  
	  }
	  return vl;              
	}
	window.mediamath_data_hash = hashCode(window.mediamath_data_str);	
	
}
//#MODULE: MEDIAMATH_MACROS: END

//override
function UrlParamFrom (name, _default, href) {
	var value = null;
	//web dco -- part 1
	if(name == "ctp" && window.platform == "web"){
		var si = href.indexOf("ctp=");
		var ei = href.indexOf("&adurl=", si + 1 );
		if(si != -1 && ei != -1 && ei > si){
			si += 4;
			value = href.substr(si, ei-(si)) + "&adurl=";
		}else{
			//if encoded
			ei = href.indexOf(encodeURIComponent("&adurl="), si + 1 );
			if(si != -1 && ei != -1 && ei > si){
				si += 4;
				value = href.substr(si, ei-(si)) + encodeURIComponent("&adurl=");
			}
		}
		if(value){
			return value;
		}else{
			name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
			var regexS = "[\\?&]" + name + "=([^&#]*)";
			var regex = new RegExp(regexS);
			var results = regex.exec(href);
			if (results == null)
				return _default;
			else
				return results[1];
		}
	}else{
		name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
		var regexS = "[\\?&]" + name + "=([^&#]*)";
		var regex = new RegExp(regexS);
		var results = regex.exec(href);
		if (results == null)
			return _default;
		else
			return results[1];
	}
};

//override
function UrlParam (name, _default) {
	if(window.adxcel_tag_params && window.adxcel_tag_params[name]){
		return window.adxcel_tag_params[name];
	}
	if(window.__ad___tag_params && window.__ad___tag_params[name]){
		return window.__ad___tag_params[name];
	}
	var scripts = document.getElementsByTagName("script");
	for (var i = 0, val; i < scripts.length; ++i) {
		var src = scripts[i].src;
		if (!src) continue;
		var ind = src.indexOf("?");
		var coresrc = (ind != -1) ? src.substr(0, ind) : src;
		if (coresrc.indexOf(adxcel_settings.tag_script_pattern) + adxcel_settings.tag_script_pattern.length == coresrc.length) {
			if (!window.url_request && scripts[i].src) {
				var parts = scripts[i].src.split("?", 2);
				window.url_request = parts[1];
			}
			val = UrlParamFrom(name, _default, scripts[i].src);
			if (val !== _default)
				return val;
		}
	}
	return _default;
};

//#MODULE: BEESWAX_MACROS
if(window.__ad___beeswax_data){window.adxcel_beeswax_data = window.__ad___beeswax_data;}
if(window.__ad___beeswax_hash){window.adxcel_beeswax_hash = window.__ad___beeswax_hash;}
if(window.adxcel_beeswax_data && window.adxcel_beeswax_data.length>0){
	window.adxcel_beeswax_data_str = [];
	window.adxcel_beeswax_data.forEach(function(value){
		//window.adxcel_beeswax_data_str.push("["+value+"]");
		window.adxcel_beeswax_data_str.push("\"" + value + "\"");
	});
	window.adxcel_beeswax_data_str = window.adxcel_beeswax_data_str.join(",");
}
//#MODULE: BEESWAX_MACROS: END


//UAParser:
//navigator.userAgent
var userAgent = navigator ? navigator.userAgent : null;
(function(window,undefined){"use strict";var LIBVERSION="0.7.20",EMPTY="",UNKNOWN="?",FUNC_TYPE="function",UNDEF_TYPE="undefined",OBJ_TYPE="object",STR_TYPE="string",MAJOR="major",MODEL="model",NAME="name",TYPE="type",VENDOR="vendor",VERSION="version",ARCHITECTURE="architecture",CONSOLE="console",MOBILE="mobile",TABLET="tablet",SMARTTV="smarttv",WEARABLE="wearable",EMBEDDED="embedded";var util={extend:function(regexes,extensions){var mergedRegexes={};for(var i in regexes){if(extensions[i]&&extensions[i].length%2===0){mergedRegexes[i]=extensions[i].concat(regexes[i])}else{mergedRegexes[i]=regexes[i]}}return mergedRegexes},has:function(str1,str2){if(typeof str1==="string"){return str2.toLowerCase().indexOf(str1.toLowerCase())!==-1}else{return false}},lowerize:function(str){return str.toLowerCase()},major:function(version){return typeof version===STR_TYPE?version.replace(/[^\d\.]/g,"").split(".")[0]:undefined},trim:function(str){return str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}};var mapper={rgx:function(ua,arrays){var i=0,j,k,p,q,matches,match;while(i<arrays.length&&!matches){var regex=arrays[i],props=arrays[i+1];j=k=0;while(j<regex.length&&!matches){matches=regex[j++].exec(ua);if(!!matches){for(p=0;p<props.length;p++){match=matches[++k];q=props[p];if(typeof q===OBJ_TYPE&&q.length>0){if(q.length==2){if(typeof q[1]==FUNC_TYPE){this[q[0]]=q[1].call(this,match)}else{this[q[0]]=q[1]}}else if(q.length==3){if(typeof q[1]===FUNC_TYPE&&!(q[1].exec&&q[1].test)){this[q[0]]=match?q[1].call(this,match,q[2]):undefined}else{this[q[0]]=match?match.replace(q[1],q[2]):undefined}}else if(q.length==4){this[q[0]]=match?q[3].call(this,match.replace(q[1],q[2])):undefined}}else{this[q]=match?match:undefined}}}}i+=2}},str:function(str,map){for(var i in map){if(typeof map[i]===OBJ_TYPE&&map[i].length>0){for(var j=0;j<map[i].length;j++){if(util.has(map[i][j],str)){return i===UNKNOWN?undefined:i}}}else if(util.has(map[i],str)){return i===UNKNOWN?undefined:i}}return str}};var maps={browser:{oldsafari:{version:{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}}},device:{amazon:{model:{"Fire Phone":["SD","KF"]}},sprint:{model:{"Evo Shift 4G":"7373KT"},vendor:{HTC:"APA",Sprint:"Sprint"}}},os:{windows:{version:{ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"}}}};var regexes={browser:[[/(opera\smini)\/([\w\.-]+)/i,/(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,/(opera).+version\/([\w\.]+)/i,/(opera)[\/\s]+([\w\.]+)/i],[NAME,VERSION],[/(opios)[\/\s]+([\w\.]+)/i],[[NAME,"Opera Mini"],VERSION],[/\s(opr)\/([\w\.]+)/i],[[NAME,"Opera"],VERSION],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]*)/i,/(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i,/(?:ms|\()(ie)\s([\w\.]+)/i,/(rekonq)\/([\w\.]*)/i,/(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon)\/([\w\.-]+)/i],[NAME,VERSION],[/(konqueror)\/([\w\.]+)/i],[[NAME,"Konqueror"],VERSION],[/(trident).+rv[:\s]([\w\.]+).+like\sgecko/i],[[NAME,"IE"],VERSION],[/(edge|edgios|edga|edg)\/((\d+)?[\w\.]+)/i],[[NAME,"Edge"],VERSION],[/(yabrowser)\/([\w\.]+)/i],[[NAME,"Yandex"],VERSION],[/(puffin)\/([\w\.]+)/i],[[NAME,"Puffin"],VERSION],[/(focus)\/([\w\.]+)/i],[[NAME,"Firefox Focus"],VERSION],[/(opt)\/([\w\.]+)/i],[[NAME,"Opera Touch"],VERSION],[/((?:[\s\/])uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i],[[NAME,"UCBrowser"],VERSION],[/(comodo_dragon)\/([\w\.]+)/i],[[NAME,/_/g," "],VERSION],[/(windowswechat qbcore)\/([\w\.]+)/i],[[NAME,"WeChat(Win) Desktop"],VERSION],[/(micromessenger)\/([\w\.]+)/i],[[NAME,"WeChat"],VERSION],[/(brave)\/([\w\.]+)/i],[[NAME,"Brave"],VERSION],[/(qqbrowserlite)\/([\w\.]+)/i],[NAME,VERSION],[/(QQ)\/([\d\.]+)/i],[NAME,VERSION],[/m?(qqbrowser)[\/\s]?([\w\.]+)/i],[NAME,VERSION],[/(BIDUBrowser)[\/\s]?([\w\.]+)/i],[NAME,VERSION],[/(2345Explorer)[\/\s]?([\w\.]+)/i],[NAME,VERSION],[/(MetaSr)[\/\s]?([\w\.]+)/i],[NAME],[/(LBBROWSER)/i],[NAME],[/xiaomi\/miuibrowser\/([\w\.]+)/i],[VERSION,[NAME,"MIUI Browser"]],[/;fbav\/([\w\.]+);/i],[VERSION,[NAME,"Facebook"]],[/safari\s(line)\/([\w\.]+)/i,/android.+(line)\/([\w\.]+)\/iab/i],[NAME,VERSION],[/headlesschrome(?:\/([\w\.]+)|\s)/i],[VERSION,[NAME,"Chrome Headless"]],[/\swv\).+(chrome)\/([\w\.]+)/i],[[NAME,/(.+)/,"$1 WebView"],VERSION],[/((?:oculus|samsung)browser)\/([\w\.]+)/i],[[NAME,/(.+(?:g|us))(.+)/,"$1 $2"],VERSION],[/android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i],[VERSION,[NAME,"Android Browser"]],[/(sailfishbrowser)\/([\w\.]+)/i],[[NAME,"Sailfish Browser"],VERSION],[/(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i],[NAME,VERSION],[/(dolfin)\/([\w\.]+)/i],[[NAME,"Dolphin"],VERSION],[/((?:android.+)crmo|crios)\/([\w\.]+)/i],[[NAME,"Chrome"],VERSION],[/(coast)\/([\w\.]+)/i],[[NAME,"Opera Coast"],VERSION],[/fxios\/([\w\.-]+)/i],[VERSION,[NAME,"Firefox"]],[/version\/([\w\.]+).+?mobile\/\w+\s(safari)/i],[VERSION,[NAME,"Mobile Safari"]],[/version\/([\w\.]+).+?(mobile\s?safari|safari)/i],[VERSION,NAME],[/webkit.+?(gsa)\/([\w\.]+).+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[[NAME,"GSA"],VERSION],[/webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i],[NAME,[VERSION,mapper.str,maps.browser.oldsafari.version]],[/(webkit|khtml)\/([\w\.]+)/i],[NAME,VERSION],[/(navigator|netscape)\/([\w\.-]+)/i],[[NAME,"Netscape"],VERSION],[/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,/(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)$/i,/(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,/(links)\s\(([\w\.]+)/i,/(gobrowser)\/?([\w\.]*)/i,/(ice\s?browser)\/v?([\w\._]+)/i,/(mosaic)[\/\s]([\w\.]+)/i],[NAME,VERSION]],cpu:[[/(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i],[[ARCHITECTURE,"amd64"]],[/(ia32(?=;))/i],[[ARCHITECTURE,util.lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[ARCHITECTURE,"ia32"]],[/windows\s(ce|mobile);\sppc;/i],[[ARCHITECTURE,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i],[[ARCHITECTURE,/ower/,"",util.lowerize]],[/(sun4\w)[;\)]/i],[[ARCHITECTURE,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+[;l]))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i],[[ARCHITECTURE,util.lowerize]]],device:[[/\((ipad|playbook);[\w\s\),;-]+(rim|apple)/i],[MODEL,VENDOR,[TYPE,TABLET]],[/applecoremedia\/[\w\.]+ \((ipad)/],[MODEL,[VENDOR,"Apple"],[TYPE,TABLET]],[/(apple\s{0,1}tv)/i],[[MODEL,"Apple TV"],[VENDOR,"Apple"]],[/(archos)\s(gamepad2?)/i,/(hp).+(touchpad)/i,/(hp).+(tablet)/i,/(kindle)\/([\w\.]+)/i,/\s(nook)[\w\s]+build\/(\w+)/i,/(dell)\s(strea[kpr\s\d]*[\dko])/i],[VENDOR,MODEL,[TYPE,TABLET]],[/(kf[A-z]+)\sbuild\/.+silk\//i],[MODEL,[VENDOR,"Amazon"],[TYPE,TABLET]],[/(sd|kf)[0349hijorstuw]+\sbuild\/.+silk\//i],[[MODEL,mapper.str,maps.device.amazon.model],[VENDOR,"Amazon"],[TYPE,MOBILE]],[/android.+aft([bms])\sbuild/i],[MODEL,[VENDOR,"Amazon"],[TYPE,SMARTTV]],[/\((ip[honed|\s\w*]+);.+(apple)/i],[MODEL,VENDOR,[TYPE,MOBILE]],[/\((ip[honed|\s\w*]+);/i],[MODEL,[VENDOR,"Apple"],[TYPE,MOBILE]],[/(blackberry)[\s-]?(\w+)/i,/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]*)/i,/(hp)\s([\w\s]+\w)/i,/(asus)-?(\w+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/\(bb10;\s(\w+)/i],[MODEL,[VENDOR,"BlackBerry"],[TYPE,MOBILE]],[/android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone|p00c)/i],[MODEL,[VENDOR,"Asus"],[TYPE,TABLET]],[/(sony)\s(tablet\s[ps])\sbuild\//i,/(sony)?(?:sgp.+)\sbuild\//i],[[VENDOR,"Sony"],[MODEL,"Xperia Tablet"],[TYPE,TABLET]],[/android.+\s([c-g]\d{4}|so[-l]\w+)(?=\sbuild\/|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[MODEL,[VENDOR,"Sony"],[TYPE,MOBILE]],[/\s(ouya)\s/i,/(nintendo)\s([wids3u]+)/i],[VENDOR,MODEL,[TYPE,CONSOLE]],[/android.+;\s(shield)\sbuild/i],[MODEL,[VENDOR,"Nvidia"],[TYPE,CONSOLE]],[/(playstation\s[34portablevi]+)/i],[MODEL,[VENDOR,"Sony"],[TYPE,CONSOLE]],[/(sprint\s(\w+))/i],[[VENDOR,mapper.str,maps.device.sprint.vendor],[MODEL,mapper.str,maps.device.sprint.model],[TYPE,MOBILE]],[/(htc)[;_\s-]+([\w\s]+(?=\)|\sbuild)|\w+)/i,/(zte)-(\w*)/i,/(alcatel|geeksphone|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]*)/i],[VENDOR,[MODEL,/_/g," "],[TYPE,MOBILE]],[/(nexus\s9)/i],[MODEL,[VENDOR,"HTC"],[TYPE,TABLET]],[/d\/huawei([\w\s-]+)[;\)]/i,/(nexus\s6p)/i],[MODEL,[VENDOR,"Huawei"],[TYPE,MOBILE]],[/(microsoft);\s(lumia[\s\w]+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/[\s\(;](xbox(?:\sone)?)[\s\);]/i],[MODEL,[VENDOR,"Microsoft"],[TYPE,CONSOLE]],[/(kin\.[onetw]{3})/i],[[MODEL,/\./g," "],[VENDOR,"Microsoft"],[TYPE,MOBILE]],[/\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?:?(\s4g)?)[\w\s]+build\//i,/mot[\s-]?(\w*)/i,/(XT\d{3,4}) build\//i,/(nexus\s6)/i],[MODEL,[VENDOR,"Motorola"],[TYPE,MOBILE]],[/android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i],[MODEL,[VENDOR,"Motorola"],[TYPE,TABLET]],[/hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i],[[VENDOR,util.trim],[MODEL,util.trim],[TYPE,SMARTTV]],[/hbbtv.+maple;(\d+)/i],[[MODEL,/^/,"SmartTV"],[VENDOR,"Samsung"],[TYPE,SMARTTV]],[/\(dtv[\);].+(aquos)/i],[MODEL,[VENDOR,"Sharp"],[TYPE,SMARTTV]],[/android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,/((SM-T\w+))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,TABLET]],[/smart-tv.+(samsung)/i],[VENDOR,[TYPE,SMARTTV],MODEL],[/((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,/(sam[sung]*)[\s-]*(\w+-?[\w-]*)/i,/sec-((sgh\w+))/i],[[VENDOR,"Samsung"],MODEL,[TYPE,MOBILE]],[/sie-(\w*)/i],[MODEL,[VENDOR,"Siemens"],[TYPE,MOBILE]],[/(maemo|nokia).*(n900|lumia\s\d+)/i,/(nokia)[\s_-]?([\w-]*)/i],[[VENDOR,"Nokia"],MODEL,[TYPE,MOBILE]],[/android[x\d\.\s;]+\s([ab][1-7]\-?[0178a]\d\d?)/i],[MODEL,[VENDOR,"Acer"],[TYPE,TABLET]],[/android.+([vl]k\-?\d{3})\s+build/i],[MODEL,[VENDOR,"LG"],[TYPE,TABLET]],[/android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i],[[VENDOR,"LG"],MODEL,[TYPE,TABLET]],[/(lg) netcast\.tv/i],[VENDOR,MODEL,[TYPE,SMARTTV]],[/(nexus\s[45])/i,/lg[e;\s\/-]+(\w*)/i,/android.+lg(\-?[\d\w]+)\s+build/i],[MODEL,[VENDOR,"LG"],[TYPE,MOBILE]],[/(lenovo)\s?(s(?:5000|6000)(?:[\w-]+)|tab(?:[\s\w]+))/i],[VENDOR,MODEL,[TYPE,TABLET]],[/android.+(ideatab[a-z0-9\-\s]+)/i],[MODEL,[VENDOR,"Lenovo"],[TYPE,TABLET]],[/(lenovo)[_\s-]?([\w-]+)/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/linux;.+((jolla));/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/((pebble))app\/[\d\.]+\s/i],[VENDOR,MODEL,[TYPE,WEARABLE]],[/android.+;\s(oppo)\s?([\w\s]+)\sbuild/i],[VENDOR,MODEL,[TYPE,MOBILE]],[/crkey/i],[[MODEL,"Chromecast"],[VENDOR,"Google"]],[/android.+;\s(glass)\s\d/i],[MODEL,[VENDOR,"Google"],[TYPE,WEARABLE]],[/android.+;\s(pixel c)[\s)]/i],[MODEL,[VENDOR,"Google"],[TYPE,TABLET]],[/android.+;\s(pixel( [23])?( xl)?)[\s)]/i],[MODEL,[VENDOR,"Google"],[TYPE,MOBILE]],[/android.+;\s(\w+)\s+build\/hm\1/i,/android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,/android.+(mi[\s\-_]*(?:a\d|one|one[\s_]plus|note lte)?[\s_]*(?:\d?\w?)[\s_]*(?:plus)?)\s+build/i,/android.+(redmi[\s\-_]*(?:note)?(?:[\s_]*[\w\s]+))\s+build/i],[[MODEL,/_/g," "],[VENDOR,"Xiaomi"],[TYPE,MOBILE]],[/android.+(mi[\s\-_]*(?:pad)(?:[\s_]*[\w\s]+))\s+build/i],[[MODEL,/_/g," "],[VENDOR,"Xiaomi"],[TYPE,TABLET]],[/android.+;\s(m[1-5]\snote)\sbuild/i],[MODEL,[VENDOR,"Meizu"],[TYPE,MOBILE]],[/(mz)-([\w-]{2,})/i],[[VENDOR,"Meizu"],MODEL,[TYPE,MOBILE]],[/android.+a000(1)\s+build/i,/android.+oneplus\s(a\d{4})\s+build/i],[MODEL,[VENDOR,"OnePlus"],[TYPE,MOBILE]],[/android.+[;\/]\s*(RCT[\d\w]+)\s+build/i],[MODEL,[VENDOR,"RCA"],[TYPE,TABLET]],[/android.+[;\/\s]+(Venue[\d\s]{2,7})\s+build/i],[MODEL,[VENDOR,"Dell"],[TYPE,TABLET]],[/android.+[;\/]\s*(Q[T|M][\d\w]+)\s+build/i],[MODEL,[VENDOR,"Verizon"],[TYPE,TABLET]],[/android.+[;\/]\s+(Barnes[&\s]+Noble\s+|BN[RT])(V?.*)\s+build/i],[[VENDOR,"Barnes & Noble"],MODEL,[TYPE,TABLET]],[/android.+[;\/]\s+(TM\d{3}.*\b)\s+build/i],[MODEL,[VENDOR,"NuVision"],[TYPE,TABLET]],[/android.+;\s(k88)\sbuild/i],[MODEL,[VENDOR,"ZTE"],[TYPE,TABLET]],[/android.+[;\/]\s*(gen\d{3})\s+build.*49h/i],[MODEL,[VENDOR,"Swiss"],[TYPE,MOBILE]],[/android.+[;\/]\s*(zur\d{3})\s+build/i],[MODEL,[VENDOR,"Swiss"],[TYPE,TABLET]],[/android.+[;\/]\s*((Zeki)?TB.*\b)\s+build/i],[MODEL,[VENDOR,"Zeki"],[TYPE,TABLET]],[/(android).+[;\/]\s+([YR]\d{2})\s+build/i,/android.+[;\/]\s+(Dragon[\-\s]+Touch\s+|DT)(\w{5})\sbuild/i],[[VENDOR,"Dragon Touch"],MODEL,[TYPE,TABLET]],[/android.+[;\/]\s*(NS-?\w{0,9})\sbuild/i],[MODEL,[VENDOR,"Insignia"],[TYPE,TABLET]],[/android.+[;\/]\s*((NX|Next)-?\w{0,9})\s+build/i],[MODEL,[VENDOR,"NextBook"],[TYPE,TABLET]],[/android.+[;\/]\s*(Xtreme\_)?(V(1[045]|2[015]|30|40|60|7[05]|90))\s+build/i],[[VENDOR,"Voice"],MODEL,[TYPE,MOBILE]],[/android.+[;\/]\s*(LVTEL\-)?(V1[12])\s+build/i],[[VENDOR,"LvTel"],MODEL,[TYPE,MOBILE]],[/android.+;\s(PH-1)\s/i],[MODEL,[VENDOR,"Essential"],[TYPE,MOBILE]],[/android.+[;\/]\s*(V(100MD|700NA|7011|917G).*\b)\s+build/i],[MODEL,[VENDOR,"Envizen"],[TYPE,TABLET]],[/android.+[;\/]\s*(Le[\s\-]+Pan)[\s\-]+(\w{1,9})\s+build/i],[VENDOR,MODEL,[TYPE,TABLET]],[/android.+[;\/]\s*(Trio[\s\-]*.*)\s+build/i],[MODEL,[VENDOR,"MachSpeed"],[TYPE,TABLET]],[/android.+[;\/]\s*(Trinity)[\-\s]*(T\d{3})\s+build/i],[VENDOR,MODEL,[TYPE,TABLET]],[/android.+[;\/]\s*TU_(1491)\s+build/i],[MODEL,[VENDOR,"Rotor"],[TYPE,TABLET]],[/android.+(KS(.+))\s+build/i],[MODEL,[VENDOR,"Amazon"],[TYPE,TABLET]],[/android.+(Gigaset)[\s\-]+(Q\w{1,9})\s+build/i],[VENDOR,MODEL,[TYPE,TABLET]],[/\s(tablet|tab)[;\/]/i,/\s(mobile)(?:[;\/]|\ssafari)/i],[[TYPE,util.lowerize],VENDOR,MODEL],[/[\s\/\(](smart-?tv)[;\)]/i],[[TYPE,SMARTTV]],[/(android[\w\.\s\-]{0,9});.+build/i],[MODEL,[VENDOR,"Generic"]]],engine:[[/windows.+\sedge\/([\w\.]+)/i],[VERSION,[NAME,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)/i],[[NAME,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,/(icab)[\/\s]([23]\.[\d\.]+)/i],[NAME,VERSION],[/rv\:([\w\.]{1,9}).+(gecko)/i],[VERSION,NAME]],os:[[/microsoft\s(windows)\s(vista|xp)/i],[NAME,VERSION],[/(windows)\snt\s6\.2;\s(arm)/i,/(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s\w]*)/i,/(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i],[NAME,[VERSION,mapper.str,maps.os.windows.version]],[/(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i],[[NAME,"Windows"],[VERSION,mapper.str,maps.os.windows.version]],[/\((bb)(10);/i],[[NAME,"BlackBerry"],VERSION],[/(blackberry)\w*\/?([\w\.]*)/i,/(tizen)[\/\s]([\w\.]+)/i,/(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|sailfish|contiki)[\/\s-]?([\w\.]*)/i],[NAME,VERSION],[/(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]*)/i],[[NAME,"Symbian"],VERSION],[/\((series40);/i],[NAME],[/mozilla.+\(mobile;.+gecko.+firefox/i],[[NAME,"Firefox OS"],VERSION],[/(nintendo|playstation)\s([wids34portablevu]+)/i,/(mint)[\/\s\(]?(\w*)/i,/(mageia|vectorlinux)[;\s]/i,/(joli|[kxln]?ubuntu|debian|suse|opensuse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]*)/i,/(hurd|linux)\s?([\w\.]*)/i,/(gnu)\s?([\w\.]*)/i],[NAME,VERSION],[/(cros)\s[\w]+\s([\w\.]+\w)/i],[[NAME,"Chromium OS"],VERSION],[/(sunos)\s?([\w\.\d]*)/i],[[NAME,"Solaris"],VERSION],[/\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]*)/i],[NAME,VERSION],[/(haiku)\s(\w+)/i],[NAME,VERSION],[/cfnetwork\/.+darwin/i,/ip[honead]{2,4}(?:.*os\s([\w]+)\slike\smac|;\sopera)/i],[[VERSION,/_/g,"."],[NAME,"iOS"]],[/(mac\sos\sx)\s?([\w\s\.]*)/i,/(macintosh|mac(?=_powerpc)\s)/i],[[NAME,"Mac OS"],[VERSION,/_/g,"."]],[/((?:open)?solaris)[\/\s-]?([\w\.]*)/i,/(aix)\s((\d)(?=\.|\)|\s)[\w\.])*/i,/(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms|fuchsia)/i,/(unix)\s?([\w\.]*)/i],[NAME,VERSION]]};var UAParser=function(uastring,extensions){if(typeof uastring==="object"){extensions=uastring;uastring=undefined}if(!(this instanceof UAParser)){return new UAParser(uastring,extensions).getResult()}var ua=uastring||(window&&window.navigator&&window.navigator.userAgent?window.navigator.userAgent:EMPTY);var rgxmap=extensions?util.extend(regexes,extensions):regexes;this.getBrowser=function(){var browser={name:undefined,version:undefined};mapper.rgx.call(browser,ua,rgxmap.browser);browser.major=util.major(browser.version);return browser};this.getCPU=function(){var cpu={architecture:undefined};mapper.rgx.call(cpu,ua,rgxmap.cpu);return cpu};this.getDevice=function(){var device={vendor:undefined,model:undefined,type:undefined};mapper.rgx.call(device,ua,rgxmap.device);return device};this.getEngine=function(){var engine={name:undefined,version:undefined};mapper.rgx.call(engine,ua,rgxmap.engine);return engine};this.getOS=function(){var os={name:undefined,version:undefined};mapper.rgx.call(os,ua,rgxmap.os);return os};this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}};this.getUA=function(){return ua};this.setUA=function(uastring){ua=uastring;return this};return this};UAParser.VERSION=LIBVERSION;UAParser.BROWSER={NAME:NAME,MAJOR:MAJOR,VERSION:VERSION};UAParser.CPU={ARCHITECTURE:ARCHITECTURE};UAParser.DEVICE={MODEL:MODEL,VENDOR:VENDOR,TYPE:TYPE,CONSOLE:CONSOLE,MOBILE:MOBILE,SMARTTV:SMARTTV,TABLET:TABLET,WEARABLE:WEARABLE,EMBEDDED:EMBEDDED};UAParser.ENGINE={NAME:NAME,VERSION:VERSION};UAParser.OS={NAME:NAME,VERSION:VERSION};if(typeof exports!==UNDEF_TYPE){if(typeof module!==UNDEF_TYPE&&module.exports){exports=module.exports=UAParser}exports.UAParser=UAParser}else{if(typeof define==="function"&&define.amd){define(function(){return UAParser})}else if(window){window.UAParser=UAParser}}var $=window&&(window.jQuery||window.Zepto);if(typeof $!==UNDEF_TYPE&&!$.ua){var parser=new UAParser;$.ua=parser.getResult();$.ua.get=function(){return parser.getUA()};$.ua.set=function(uastring){parser.setUA(uastring);var result=parser.getResult();for(var prop in result){$.ua[prop]=result[prop]}}}})(typeof window==="object"?window:this);
var adxcel_device_vendor_replacements = [
	//["Xiaomi", "XiaoMi"],
	["Sony[Ericsson]", "SonyEricsson"],
	["ASUS", "Asus"],
	["motorola", "Motorola"],
	["RCA", "RCA Tablets"]
];
var uaParser= new UAParser(userAgent);
var adxcel_device = uaParser.getDevice(); 
if(adxcel_device && adxcel_device.vendor){
	adxcel_device_vendor_replacements.forEach(function(arr){
		if( adxcel_device.vendor == arr[0]){
			 adxcel_device.vendor = arr[1];
		}
	});
}
var adxcel_os = uaParser.getOS();

//DCO:Logit
//#ENGINE: DCO AI
//aggStrategy
function BinaryFeature(name, mapping, unknownKey) {
    var self = this;

    self.name = name;
    self.mapping = mapping;
    self.unknownKey = unknownKey;

    if (self.mapping) {
        self.width = Object.keys( mapping ).length;
    }

    self.extract = function (x) {
        x = x[self.name];

        if (!(x in self.mapping)) {
            x = self.unknownKey;
        }

        return (x in self.mapping) ? [1, self.mapping[x]] : null;
    }
}

var FeatureTypes = [BinaryFeature];

function Logit(features, coefs, bias) {
    var self = this;

    self.features = features;
    self.coefs = coefs;
    self.bias = bias;

    self.predict = function (x) {
        var offset = 0;
        var score = self.bias;
        self.features.forEach(function (f)  {
            var f_value = f.extract(x);
            if (f_value) {
                score += f_value[0] * self.coefs[offset + f_value[1]];
            }
            offset += f.width;
        });
        return 1/(1+Math.exp(-score));
    };
}

function DCOModel(features, logits, strategy) {
    var self = this;

    self.features = features; 
    
    self.logits = logits; 

    self.defaults = window.dco_defaults ? window.dco_defaults : {'device_brand':'','mm_dma':0,'mm_zip':'','mm_city':'','yob':0,'os_major':-1,'bswx_page':'','bswx_domain':'','bswx_referrer':'','bswx_site_id':'','bswx_site_name':'','bswx_app_bundle':'','bswx_app_id':'','bswx_app_name':'','bswx_app_store_url':'','bswx_placement_id':'','bswx_inventory_source':'','bswx_exchange_handle':'','bswx_rewarded':''};

    self.scores = [];
    
    self.strategy = strategy;

    self.features = self.features.map(function (args) {
        var params = args[1];
        params.push(self.defaults[params[0]]);
        return new (Function.prototype.bind.apply(FeatureTypes[args[0]], [null].concat(params)));
    });
    
    self.aggStrategy = {
        mult: function (x) {
			x = x.filter(function(v) {return v !== null;});
			if (x.length === 0) {
				return 0;
			}

			return x.reduce(function (prev, cur) { return cur * prev; }, 1);
		},
		mean: function (x) {
			x = x.filter(function(v) {return v !== null;});
			if (x.length === 0) {
				return 0;
			}

			return x.reduce(function (prev, cur) {return cur + prev;}) / x.length;
		},
		max: function (x) {
			x = x.filter(function(v) {return v !== null;});
			if (x.length === 0) {
				return 0;
			}

			return Math.max.apply(null, x);
		}
    };
    
    self.getVariation = function(imp,excludes){
		if(self.strategy == "aver"){
			self.aggStrategy = self.aggStrategy['mean'];
			return self.getVariationByStrategy(imp,excludes);
		}else if(self.strategy == "max"){
			self.aggStrategy = self.aggStrategy['max'];
			return self.getVariationByStrategy(imp,excludes);
		}else if(self.strategy == "mult"){
			self.aggStrategy = self.aggStrategy['mult'];
			return self.getVariationByStrategy(imp,excludes);
		}else{
			return self.getVariationOrig(imp,excludes);
		}
	};

	self.getVariationByStrategy = function (imp, excludes) {
        excludes = excludes || {templates: [], elements: {}, combinations: {}};
        excludes.templates = excludes.templates || [];
        excludes.elements = excludes.elements || {};
        excludes.combinations = excludes.combinations || {};

        var maxScore = 0;
        var bestScores = null;
        var bestVariation = null;
		
		var exc_tmplts = [];
		if(excludes.templates){
			for(var i=0; i<excludes.templates.length; i++){
				if(excludes.templates[i]){
					//exc_tmplts.push(i);
					exc_tmplts.push(parseInt(excludes.templates[i]));
				}
			}
		}
		var selectedTemplateID = self._classify(self.logits.root, imp, exc_tmplts);
		window.template_scores = self.scores;
		if(window.adxcel_is_verbose){
			console.log("--- templateID:" + selectedTemplateID);		  
			console.log("		scores: " + window.template_scores);
		}
		
        for (var node in self.logits) {
            if (node === 'root') {
              continue;
            }

            var templateID = node;
            //if (templateID in excludes.templates) {
			if (excludes.templates && Array.isArray(excludes.templates) &&  excludes.templates.indexOf(parseInt(templateID)) != -1) {
				continue;
            }
			
			//#PATCH:selectedTemplateID
			if(adxcel_settings.dco_ai_excludes && adxcel_settings.dco_ai_excludes.templates&& adxcel_settings.dco_ai_excludes.templates.length>0){
				//
			}else{
				if(selectedTemplateID && templateID != selectedTemplateID){
					continue;
				}
			}

            var templateElementExcludes = excludes.elements[templateID] || {};
            var templateCombinationExcludes = excludes.combinations[templateID] || [];

            self.scores = [];
            var pattern = (templateID in self.logits) ? self.logits[templateID].map(function (ctx, idx) {
                var excl = (templateElementExcludes[idx] || []).slice();
                for (var i = 0; i < templateCombinationExcludes.length; ++i) {
                    var combination = templateCombinationExcludes[i];
                    if (Math.max.apply(null, Object.keys(combination)) === idx) {
                        excl = excl.concat(combination[idx]);
                    }
                }

                var elementID = self._classify(ctx, imp, excl);
                var elementID_ = parseInt(elementID);

                templateCombinationExcludes = templateCombinationExcludes.filter(function (combination) {
                    return !(combination[idx] && combination[idx].indexOf(elementID_) === -1);
                });

                return elementID;
            }).join('') : '*';

            var scoreAgg = self.aggStrategy(self.scores);
            if (scoreAgg > maxScore) {
                maxScore = scoreAgg;
                bestScores = self.scores;
                bestVariation = {
                    templateID: templateID,
                    pattern: pattern
                };
            }
        }

        if (bestScores) {
            self.scores = [maxScore].concat(bestScores);
            if(window.adxcel_is_verbose){ 
				console.log("self.scores : " + self.scores);
			}
			if(window.template_scores){
				self.scores = window.template_scores.concat(self.scores);
			}
			if(window.adxcel_is_verbose){ 
				console.log("++ scores : " + self.scores);
			}
			self.scores = self.scores.map(function (x) {
                return x ? x.toFixed(3) : x;
            });
        } else {
			if(window.adxcel_is_verbose){ 
				console.log("self.scores : " + self.scores);
			}
            //bestVariation = {templateID: self._classify(self.logits.root, imp, excludes.templates), pattern: '*'};
			var exc_tmplts = [];
			if(excludes.templates){
				for(var i=0; i<excludes.templates.length; i++){
					if(excludes.templates[i]){
						exc_tmplts.push(i);
					}
				}
			}
			bestVariation = {templateID: self._classify(self.logits.root, imp, exc_tmplts), pattern: '*'};
			if(window.adxcel_is_verbose){ 
				console.log("self.scores : " + self.scores);
			}
			if(window.template_scores){
				self.scores = window.template_scores.concat(self.scores);
			}
			if(window.adxcel_is_verbose){ 
				console.log("++ scores : " + self.scores);
			}
        }

        return bestVariation;
    };
    
    self.getVariationOrig = function (imp, excludes) {
        excludes = excludes || {templates: [], elements: {}, combinations: {}};
        excludes.templates = excludes.templates || [];
        excludes.elements = excludes.elements || {};
        excludes.combinations = excludes.combinations || {};


        var templateID = self._classify(self.logits.root, imp, excludes.templates);
        var templateElementExcludes = excludes.elements[templateID] || {};
        var templateCombinationExcludes = excludes.combinations[templateID] || [];

        var pattern = (templateID in self.logits) ? self.logits[templateID].map(function (ctx, idx) {
            var excl = (templateElementExcludes[idx] || []).slice();
            for (var i = 0; i < templateCombinationExcludes.length; ++i) {
                var combination = templateCombinationExcludes[i];
                if (Math.max.apply(null, Object.keys(combination)) === idx) {
                    excl = excl.concat(combination[idx]);
                }
            }

            var elementID = self._classify(ctx, imp, excl);
            var elementID_ = parseInt(elementID);

            templateCombinationExcludes = templateCombinationExcludes.filter(function (combination) {
                return !(combination[idx] && combination[idx].indexOf(elementID_) === -1);
            });

            return elementID;
        }).join('') : '*';
        
        self.scores = self.scores.map(function (x) {
                return x ? x.toFixed(3) : x;
            });

        return {templateID: templateID, pattern: pattern};
    };

    self.compileVariation = function (variation, templates) {
        if (!variation) {
            variation = {templateID: self._rand(templates.length), pattern: '*'};
        }

        var template = templates[variation.templateID];
        var templateElements = template[2];

        if (variation.pattern === '*') {
            variation.pattern = templateElements.map(function () {return '**';}).join('');
        }

        var templateName = template[0];
        return [templateName].concat(variation.pattern.match(/.{2}/g).map(function (component, index) {
            var elements = templateElements[index];

            if (component === '**') {
                var totalWeight = elements.reduce(function (accumulator, element) {return accumulator + element[1]}, 0);
                return self._selectByMonteCarlo(elements, Math.random() * totalWeight)[0];
            }

            return elements[parseInt(component)][0];
        })).join('.');
    };

    self._classify = function (ctx, imp, excludes) {
        excludes = excludes || [];

        var bestProb = 0;
        var bestIdx = null;
        var mks = [];

        Object.keys(ctx).forEach(function (idx) {
            var idx_ = parseInt(idx);
            if (excludes.indexOf(idx_) >= 0) {
                return;
            }

            var model = ctx[idx];

            var prob = 0;
            switch (model[2]) {
                case 'L':
                    var logit = new Logit(self.features, model[0], model[1]);
                    prob = logit.predict(imp);
                    break;

                default:
                    mks.push([idx, model[2]]);
                    break;
            }

            if (bestProb < prob) {
                bestProb = prob;
                bestIdx = idx;
            }
        });

        if (mks.length > 0) {
            var varItem = self._selectByMonteCarlo(mks, Math.random());
            if (varItem) {
                self.scores.push(null);
                return varItem[0];
            }
        }

        self.scores.push((1000*bestProb));

        return bestIdx;
    };

    self._selectByMonteCarlo = function(values, r, weightGetter) {
        weightGetter = weightGetter || function (value) {return value[1]};

        var accumulatedWeight = 0;
        for (var i = 0; i < values.length; ++i) {
            var value = values[i];
            accumulatedWeight += weightGetter(value);
            if (r < accumulatedWeight) {
                return value;
            }
        }

        return null;
    };

    self._rand = function(max) {
        return Math.floor(Math.random() * max);
    };
}


function DCOModelClusters() {
    var self = this;

    self.defaults = window.clusters_ai_defaults;
    self.features =  window.clusters_ai_features;
    self.logits = {};
    self.clusters = window.clusters_ai_clusters;
   

    self.scores = [];
    self.distances = [];

    self.features = self.features.map(function (args) {
        var params = args[1];
        params.push(self.defaults[params[0]]);
        return new (Function.prototype.bind.apply(FeatureTypes[args[0]], [null].concat(params)));
    });

    self.getVariationByCluster = function (imp) {
      var offset = 0;

      imp = self.features.map(function (f)  {
        var f_value = f.extract(imp);

        if (f_value) {
          f_value = f_value[1] + offset;
        }

        offset += f.width;
        return f_value;
      });

      self.distances = self.clusters.map(function (c)  {
        return self.calcHammingDistance(c[0], imp);
      });
      /*if(window.adxcel_is_debug){
      	console.log('distances:', self.distances);
      }*/
      
      var match = null;
      var minDist = 1000;
      var clusterID = 0;
      self.clusters.forEach(function (c, i) {
        if (self.distances[i] < minDist) {
          match = c;
          minDist = self.distances[i];
          clusterID = i;
        }
      });
      
      /*if(window.adxcel_is_debug){
      	console.log('matched cluster id:', clusterID);
      }*/
      
      self.cluster_id = clusterID;

      return {templateID: match[1], pattern: match[2]};
    };

    self.calcHammingDistance = function (a, b) {
      var overlap = {};

      a.forEach(function (x) {
        overlap[x] = 1;
      });

      b.forEach(function (x) {
        if (x in overlap) {
          delete overlap[x];
        } else {
          overlap[x] = 1;
        }
      });

      return Object.keys(overlap).length;
    };

    self.getVariation = function (imp, excludes) {
        excludes = excludes || {templates: [], elements: {}, combinations: {}};
        excludes.templates = excludes.templates || [];
        excludes.elements = excludes.elements || {};
        excludes.combinations = excludes.combinations || {};

        var templateID = self._classify(self.logits.root, imp, excludes.templates);
        var templateElementExcludes = excludes.elements[templateID] || {};
        var templateCombinationExcludes = excludes.combinations[templateID] || [];

        var pattern = (templateID in self.logits) ? self.logits[templateID].map(function (ctx, idx) {
            var excl = (templateElementExcludes[idx] || []).slice();
            for (var i = 0; i < templateCombinationExcludes.length; ++i) {
                var combination = templateCombinationExcludes[i];
                if (Math.max.apply(null, Object.keys(combination)) === idx) {
                    excl = excl.concat(combination[idx]);
                }
            }

            var elementID = self._classify(ctx, imp, excl);
            var elementID_ = parseInt(elementID);

            templateCombinationExcludes = templateCombinationExcludes.filter(function (combination) {
                return !(combination[idx] && combination[idx].indexOf(elementID_) === -1);
            });

            return elementID;
        }).join('') : '*';

        return {templateID: templateID, pattern: pattern};
    };

    self.compileVariation = function (variation, templates) {
        if (!variation) {
            variation = {templateID: self._rand(templates.length), pattern: '*'};
        }

        var template = templates[variation.templateID];
        var templateElements = template[2];

        if (variation.pattern === '*') {
            variation.pattern = templateElements.map(function () {return '**';}).join('');
        }

        var templateName = template[0];
        return [templateName].concat(variation.pattern.match(/.{2}/g).map(function (component, index) {
            var elements = templateElements[index];

            if (component === '**') {
                var totalWeight = elements.reduce(function (accumulator, element) {return accumulator + element[1]}, 0);
                return self._selectByMonteCarlo(elements, Math.random() * totalWeight)[0];
            }

            return elements[parseInt(component)][0];
        })).join('.');
    };

    self._classify = function (ctx, imp, excludes) {
        excludes = excludes || [];

        var bestProb = 0;
        var bestIdx = null;
        var mks = [];

        Object.keys(ctx).forEach(function (idx) {
            var idx_ = parseInt(idx);
            if (excludes.indexOf(idx_) >= 0) {
                return;
            }

            var model = ctx[idx];

            var prob = 0;
            switch (model[2]) {
                case 'L':
                    var logit = new Logit(self.features, model[0], model[1]);
                    prob = logit.predict(imp);
                    //console.log(idx, 1000*prob);
                    break;

                default:
                    mks.push([idx, model[2]]);
                    break;
            }

            if (bestProb < prob) {
                bestProb = prob;
                bestIdx = idx;
            }
        });

        if (mks.length > 0) {
            var varItem = self._selectByMonteCarlo(mks, Math.random());
            if (varItem) {
                self.scores.push(null);
                return varItem[0];
            }
        }

        self.scores.push((1000*bestProb).toFixed(3));

        return bestIdx;
    };

    self._selectByMonteCarlo = function(values, r, weightGetter) {
        weightGetter = weightGetter || function (value) {return value[1]};

        var accumulatedWeight = 0;
        for (var i = 0; i < values.length; ++i) {
            var value = values[i];
            accumulatedWeight += weightGetter(value);
            if (r < accumulatedWeight) {
                return value;
            }
        }

        return null;
    };

    self._rand = function(max) {
        return Math.floor(Math.random() * max);
    };
}
//#ENGINE: DCO AI: END

//dco ai
function createUserImp(){
	
	var profile = adxcel_settings.profile;
	var geo = adxcel_settings.user_geo;
	var dco_na_filers = window.dco_na_filers;
	var getDefVal = function(key, def_v){
		//def_v
		var value = dco_na_filers && dco_na_filers.hasOwnProperty(key)
						? dco_na_filers[key]
						: def_v;
		return value;
	}
		
	var usr_imp = {
		iid:				adxcel_settings.item_id ? adxcel_settings.item_id : getDefVal("iid", 0),
		utmtr: 				parseInt(adxcel_getTimeTermIndex( new Date() )),
		var_ind_1: 			profile ? (parseInt(profile.lv[0])) : -1,
		var_ind_2: 			profile ? (parseInt(profile.lv[1])) : -1, 
		var_ind_3: 			profile ? (parseInt(profile.lv[2])) : -1,
		device_brand: 		(adxcel_device && adxcel_device.vendor) ? adxcel_device.vendor : "Generic", 
		os_major: 			(adxcel_os && adxcel_os.version) ? ( adxcel_os.version.indexOf(".")>0 ? adxcel_os.version.split(".").shift() : adxcel_os.version.split("_").shift() )  : -1, 
		yob: 				profile ? (profile.yob ? parseInt(profile.yob) : 0) : 0, 
		gender: 			profile ? (profile.gender ? parseInt(profile.gender) : 0) : 0, 
		fc_imp_chk: 		profile ? dcoAIFCImpToIndex(profile.impressions) : -1, 
		fc_time_chk: 		profile ? dcoAIFCTimeToIndex(profile.localtime) : -1, 
		click_count_chk: 	profile ? dcoAIClickCountToIndex(profile.clicks) : -1, 
		var_ind_last_click: profile ? (profile.lc ? parseInt(profile.lc) : 0) : -1,
		mm_dma: 			geo ? (geo.dma ? geo.dma : 0 ) : getDefVal("mm_dma", 0),
		mm_zip:				geo ? (geo.zip ? geo.zip : "" ) : "",
		mm_city: 			geo ? (geo.city ? geo.city : "" ) : "",
		
		tmpl_1: 			profile ? (parseTemplateIndex(profile.lv[0])) : -1,
		tmpl_2: 			profile ? (parseTemplateIndex(profile.lv[1])) : -1,
		tmpl_3: 			profile ? (parseTemplateIndex(profile.lv[2])) : -1,
		
		tmpl_last_click:	profile ? (parseTemplateIndex(profile.lc ? parseInt(profile.lc) : 0)) : -1,
		uage: adxcel_getAgeTermIndex(window.adxcel_get_user.age),
		ugndr: adxcel_getGenderTermIndex(window.adxcel_get_user.gender),
		udma: isNaN(parseInt(window.adxcel_get_user.am_geo))? 0 : parseInt(window.adxcel_get_user.am_geo)
		
		

	
	};
	
	//PatchTagContentCreateUserScreenUCTX
	try{
		usr_imp.ucxt = window.adxcel_ucxt_data? window.adxcel_ucxt_data : 0;
		usr_imp.s_width = (window.screen && window.screen.width ) ? window.screen.width : getDefVal("s_width", 0);
		usr_imp.s_height = (window.screen && window.screen.height ) ? window.screen.height : getDefVal("s_height", 0);
		//usr_imp.s_ratio = (usr_imp.s_width>0 && usr_imp.s_height>0) ? (usr_imp.s_width/usr_imp.s_height).toFixed(2) : getDefVal("s_ratio", "-1.0");
		usr_imp.s_ratio = (usr_imp.s_width>0 && usr_imp.s_height>0) ? parseFloat((usr_imp.s_width/usr_imp.s_height).toFixed(2)) : getDefVal("s_ratio", "-1.0");
		usr_imp.s_size = usr_imp.s_width+"x"+usr_imp.s_height;
	}catch(e){
		usr_imp.exception_uctx = e.toString().substr(0,40)+"...";
	}
	//PatchTagContentCreateUserScreenUCTX/end
	
	//PatchTagContentCreateUserISP
	try{	
		var data = window.adxcel_isp_data;
		if(data){
			for(var prop in data){
				if(data[prop] && (typeof data[prop] == "string")){
					usr_imp["mm_"+prop] = data[prop].replace(/ /g, "_");
				}else{
					usr_imp["mm_"+prop] = data[prop];
				}
			}
			if(!usr_imp.hasOwnProperty("mm_isp")){
				usr_imp["mm_isp"] = getDefVal("mm_isp", "-");
    		}
			if(!usr_imp.hasOwnProperty("mm_asn")){
				usr_imp["mm_asn"] = getDefVal("mm_asn", 0);
    		}
		}else{
			usr_imp["mm_isp"] = getDefVal("mm_isp", "-");
    		usr_imp["mm_asn"] = getDefVal("mm_asn", 0);
		}
	}catch(e){
		usr_imp.exception_isp = e.toString().substr(0,40)+"...";
	}
	//PatchTagContentCreateUserISP/end

	return usr_imp;
}
function parseTemplateIndex(var_ind){
	var tmpl_ind = -1;
	var_ind = parseInt(var_ind);
	if(isNaN(var_ind)){
		//	
	}if(var_ind == 0){
		tmpl_ind = 0;
	}else{
		//to string and exctract 1st char
		var str = var_ind.toString();
		tmpl_ind = parseInt(str.substr(0, ((str.length%2)==0?2:1 )));
	}
	return tmpl_ind;
}

function addBeeswaxUserdata(user_imp){
	try{
		if(window.adxcel_beeswax_data && window.adxcel_beeswax_hash){
			var props = ['bswx_page',
							'bswx_domain',
							'bswx_referrer',
							'bswx_site_id',
							'bswx_site_name',
							'bswx_app_bundle',
							'bswx_app_id',
							'bswx_app_name',
							'bswx_app_store_url',
							'bswx_placement_id',
							'bswx_inventory_source',
							'bswx_exchange_handle',
							'bswx_rewarded'];
			for(var i=0; i<props.length;i++){
				if(i < window.adxcel_beeswax_data.length
					&& window.adxcel_beeswax_data[i]){
					user_imp[props[i]] = window.adxcel_beeswax_data[i].replace(/ /g, "_");
				}
			}
		}
	}catch(e){
		//
	}
}

function addTTDUserdata(user_imp){
	try{
		if(window.adxcel_ttd_data && window.adxcel_ttd_hash){
			var props = ['bswx_site_id'];
			for(var i=0; i<props.length;i++){
				if(i < window.adxcel_ttd_data.length
					&& window.adxcel_ttd_data[i]){
					user_imp[props[i]] = window.adxcel_ttd_data[i].replace(/ /g, "_");
				}
			}
		}
	}catch(e){
		//
	}
}


function addDevAtlUserdata(user_imp){
	try{
		var dco_na_filers = window.dco_na_filers;
		var getDefVal = function(key, def_v){
			//def_v
			var value = dco_na_filers.hasOwnProperty(key)
							? dco_na_filers[key]
							: def_v;
			return value;
		}		
		if(window.adxcel_devatl_data){
			
			
			var devatl = window.adxcel_devatl_data;
			var props = {
						"hardware":devatl["primaryHardwareType"]?devatl["primaryHardwareType"]:devatl["hardware"],
						"model":devatl["model"],
						"os_name":devatl["osName"],
						"os_version":devatl["osVersion"]};
			for(var prop in props){
				var val = props[prop];
				if(val){
					val = val.replace(/ /g, "_");
				}else{
					val = getDefVal(prop, "-");
				}
				
				//val = val ? val : getDefVal(prop, "-");
				
				user_imp[prop] = val;
			}
		}else{
			var props = {
				"hardware":getDefVal("hardware", "-"),
				"model":getDefVal("model", "-"),
				"os_name":getDefVal("os_name", "-"),
				"os_version":getDefVal("os_version", "-")
			};
			for(var prop in props){
				user_imp[prop] = props[prop];
			}
		
		}
	}catch(e){
		console.log(e);
	}
}

function addWeatherUserdata(user_imp, as_data){
	if(as_data){
		try{
			var wfxzp_map = window.adxcel_settings.profile.wfxzp_map ? window.adxcel_settings.profile.wfxzp_map : {}
			for(var prop in wfxzp_map){
				user_imp[prop] = 1;
			}
		}catch(e){
			console.log(e)
		}
	}else{
		try{
			var wfxzp_map = window.adxcel_settings.profile.wfxzp_map ? window.adxcel_settings.profile.wfxzp_map : {}
			for(var prop in wfxzp_map){
				user_imp[prop] = 1;
			}
		}catch(e){
			console.log(e)
		}
	}
}

function addSegmentsUserdata(user_imp){
	try{
		var segments = window.adxcel_settings.profile.segments ? window.adxcel_settings.profile.segments : []
		for(var i=0; i<segments.length; i++){
			user_imp["s_"+segments[i]] = 1;
		}
	}catch(e){
		console.log(e)
	}
	
	try{
		var oracle_segments = window.adxcel_settings.profile.oracle_segments ? window.adxcel_settings.profile.oracle_segments : []
		if(oracle_segments && oracle_segments.length>0){
			user_imp["oracle_segments"] = oracle_segments.join(",");
		}
	}catch(e){
		console.log(e);
	}
	
	try{
		var prizm_segment = window.adxcel_settings.profile.prizm_segment ? window.adxcel_settings.profile.prizm_segment : null
		if(prizm_segment && prizm_segment["segment"]){
			user_imp["prizm"] = prizm_segment["segment"];
		}else{
			if(window.dco_na_filers && window.dco_na_filers.hasOwnProperty('prizm')){
				user_imp["prizm"] = window.dco_na_filers['prizm'];
			}else{
				user_imp["prizm"] = 0;
			}
		}
	}catch(e){
		console.log(e)
	}
	
	try{
		//prizm groups
		if(window.adxcel_settings.profile && window.adxcel_settings.profile.prizm_group){
			user_imp["prizm_group"] = window.adxcel_settings.profile.prizm_group;
		}
		
		//zip5
		if(window.adxcel_settings.profile && window.adxcel_settings.profile.prizm_zip5){
			for(var prop in window.adxcel_settings.profile.prizm_zip5){
				user_imp["prz_"+prop] = window.adxcel_settings.profile.prizm_zip5[prop];
			}
		}
	}catch(e){
		console.log(e)
	}
		
}

function dcoScoresSlotToRevision(slot, rev){
	var start = (window.adxcel_settings && window.adxcel_settings.dco_rev_start) ? window.adxcel_settings.dco_rev_start : 10;
	rev = start + slot;
	return rev;
}

function dealWithDCOAI(dco_templates, dco_excludes, user, dco_strategy){
	
	if(!dco_ai_features || !dco_ai_logits){
		return null;
	}
	
	var dcoAIModel = new DCOModel(dco_ai_features, dco_ai_logits, dco_strategy);
			
	var user_imp = createUserImp(true);
	addTTDUserdata(user_imp);
	addBeeswaxUserdata(user_imp);
	addDevAtlUserdata(user_imp);
	addWeatherUserdata(user_imp);
	addSegmentsUserdata(user_imp);
	
	if(window.adxcel_is_verbose){
		console.log("user_imp:");
		console.log(JSON.stringify(user_imp));
	}

	var dco_variation = dcoAIModel.getVariation(user_imp, dco_excludes);
	
	if(window.adxcel_is_verbose){
		console.log("SCORES:");
		console.log(dcoAIModel.scores);
	}
	
	//???
	adxcel_settings_raw.variations.forEach(function(template){
		template[1] = null;
	});
	dco_templates = dco_templates ? dco_templates : adxcel_settings_raw.variations; 
	
	var dco_variation = dcoAIModel.compileVariation(dco_variation, dco_templates);
	
	dco_ai_model_scores = dcoAIModel.scores;
	
	if(adxcel_settings.dco_slots 
		&& dco_ai_thresholds && dco_ai_thresholds.length>0){
		//var score = dco_ai_model_scores ? dco_ai_model_scores.find(function(sc){return (sc && sc>0);}) : 0;
		var score = dco_ai_model_scores ? dco_ai_model_scores[0] : 0;
		if(score == null){
			dco_ai_model_scores_slot = -1;
		}else{
			score = score ? score : 0;
			var thresholds = dco_ai_thresholds;
			var slots = thresholds.length;
			var found_slot = 0;
			for(var i=0;i<thresholds.length;i++){
				found_slot = i;
				if(score < thresholds[i]){
					break;
				}
			} 
			var dco_slots = adxcel_settings.dco_slots;
			var slot_value = found_slot;
			if(slots > dco_slots){
				slot_value = found_slot/(slots) * dco_slots;	
			}		
			dco_ai_model_scores_slot = Math.floor(slot_value);
			dco_ai_model_scores_slot_raw = dco_ai_model_scores_slot+"/"+dco_slots + "-" + found_slot + "/" + slots+"-" + Math.round(found_slot/slots*100)+"%";
			}
	}else{
		dco_ai_model_scores_slot = -1; //10 -1 = 9
		dco_ai_model_scores_slot_raw = "";
	}
	
	//TODO if valid + other cases (exclude) + fixed rule
	var adxcl_var = null;
	if(dco_variation){
		//adxcl_var = dco_variation;
		
		//if not excluded
		//exclude variations
    	var excls = adxcel_settings.variations_exclude;
    	if(excls && excls.length>0){
    		for(i=0; i<excls.length; i++){
    			excls[i] = (typeof excls[i] == RegExp) ? excls[i] : new RegExp(excls[i]);
    		}
			var vr = dco_variation;
			var pass = window.adxcel_passConditions(vr, excls);
			if(pass){
				//excluded
			}else{
				adxcl_var = dco_variation;
			}    		
    	}else{
    		adxcl_var = dco_variation;
    	}		
	}
	
	return adxcl_var;
}
function dealWithDCOAIClusters(dco_templates, dco_excludes, user, dco){
	
	var dcoAIModel = new DCOModelClusters();
			
	var user_imp = createUserImp(true);
	addBeeswaxUserdata(user_imp);
	addDevAtlUserdata(user_imp);
	addWeatherUserdata(user_imp);
	addSegmentsUserdata(user_imp);

	var dco_variation = dcoAIModel.getVariationByCluster(user_imp);
	
	if (dco == null){
		window.dco_ai_clusters_id = dcoAIModel.cluster_id;
		window.dco_ai_clusters_dist = JSON.stringify(dcoAIModel.distances);
		
		if(window.adxcel_is_verbose){
			console.log("CLUSTER:");
			console.log(dcoAIModel.cluster_id);
			console.log(dcoAIModel.distances);
		}
		
		//???
		adxcel_settings_raw.variations.forEach(function(template){
			template[1] = null;
		});
		dco_templates = dco_templates ? dco_templates : adxcel_settings_raw.variations; 
		
		var dco_variation = dcoAIModel.compileVariation(dco_variation, dco_templates);
		
		var adxcl_var = dco_variation;
	}else{
		dco_templates = dco_templates ? dco_templates : adxcel_settings_raw.variations;
		//dco logic
		//indeed already initialized
		window.dco_ai_features = dco.dco_ai_features;
		window.dco_ai_logits = dco.dco_ai_logits;
		var dco_strategy = dco.dco_strategy;
		if(dco_excludes){
			//
		}else{
			dco_excludes = {}	
		}
		if(dco_templates){
			dco_excludes.templates = dco_excludes.templates || []
			for(var i=0; i<dco_templates.length; i++){
				if(dco_variation.templateID != i){
					//dco_excludes.templates.push(i);
					dco_excludes.templates[i]=1;
				}
			}
		}	
		window.dco_cluster_to_logits = true
		adxcl_var = dealWithDCOAI(dco_templates, dco_excludes, user, dco_strategy)
	}
	
	return adxcl_var;
}




function dcoAIFCImpToIndex(impressions){
	var ind = 0;
	if(!impressions){
		return ind;
	}
	impressions = parseInt(impressions);
	if(isNaN(impressions)){
		ind = -1;
	}else if(impressions>0 && impressions <=5 ){
		ind = 1;
	}else if(impressions>5 && impressions <= 10 ){
		ind = 2;
	}else if(impressions>10 && impressions <= 20 ){
		ind = 3;
	}else if(impressions>20){
		ind = 4;
	}
	return ind;
}

function dcoAIFCTimeToIndex(localtime){
	var ind = -1;
	if(!localtime){
		ind = 7;
		return ind;
	}
	
	localtime = parseInt(localtime);
	var dt = new Date();
	var currenttime = dt.getTime(); 
	var diff = currenttime - localtime;
	 
	if(isNaN(diff)){
		ind = -1;
	}else if(diff < 60000){
		ind = 0;
	}else if(diff < 10*60000){
		ind = 1;
	}else if(diff < 30*60000){
		ind = 2;
	}else if(diff < 60*60000){
		ind = 3;
	}else if(diff < 3*60*60000){
		ind = 4;
	}else if(diff < 24*60*60000){
		ind = 5;
	}else if(diff >= 24*60*60000){
		ind = 6;
	}
	return ind;
}

function dcoAIClickCountToIndex(clicks){
	var ind = 0;
	if(!clicks){
		return ind;
	}
	
	clicks = parseInt(clicks);
	
	if(isNaN(clicks)){
		ind = -1;
	}else if(clicks <= 3){
		ind = 1;
	}else if(clicks <=6 ){
		ind = 2;
	}else if(clicks > 6 ){
		ind = 3;
	}
	
	return ind;
}
//dco ai:end



function shuffle(o) {
	for (var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
	return o;
}
window.lkey = "14507061711892451";
var Base64__keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
var Base64__keyStr_arr = Base64__keyStr.split("");
eval(function (p, a, c, k, e, d) { e = function (c) { return (c < a ? '' : e(parseInt(c / a))) + ((c = c % a) > 35 ? String.fromCharCode(c + 29) : c.toString(36)) }; if (!''.replace(/^/, String)) { while (c--) { d[e(c)] = k[c] || e(c) } k = [function (e) { return d[e] }]; e = function () { return '\\w+' }; c = 1 }; while (c--) { if (k[c]) { p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]) } } return p }('5 C={b:S,R:x(e){5 t="";5 n,r,i,s,o,u,a;5 f=0;e=C.I(e);z(f<e.w){n=e.d(f++);r=e.d(f++);i=e.d(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&B)<<2|i>>6;a=i&k;c(D(r)){u=a=v}p c(D(i)){a=v}t=t+h.b.j(s)+h.b.j(o)+h.b.j(u)+h.b.j(a)}y t},L:x(e){5 t="";5 n,r,i;5 s,o,u,a;5 f=0;e=e.G(/[^A-K-O-9\\+\\/\\=]/g,"");z(f<e.w){s=h.b.q(e.j(f++));o=h.b.q(e.j(f++));u=h.b.q(e.j(f++));a=h.b.q(e.j(f++));n=s<<2|o>>4;r=(o&B)<<4|u>>2;i=(u&3)<<6|a;t=t+8.7(n);c(u!=v){t=t+8.7(r)}c(a!=v){t=t+8.7(i)}}t=C.F(t);y t},I:x(e){5 t="";Q(5 n=0;n<e.w;n++){5 r=e.d(n);c(r<l){t+=8.7(r)}p c(r>T&&r<V){t+=8.7(r>>6|U);t+=8.7(r&k|l)}p{t+=8.7(r>>H|J);t+=8.7(r>>6&k|l);t+=8.7(r&k|l)}}y t},F:x(e){5 t="";5 n=0;5 r=N=m=0;z(n<e.w){r=e.d(n);c(r<l){t+=8.7(r);n++}p c(r>M&&r<J){m=e.d(n+1);t+=8.7((r&P)<<6|m&k);n+=2}p{m=e.d(n+1);E=e.d(n+2);t+=8.7((r&B)<<H|(m&k)<<6|E&k);n+=3}}y t}}', 58, 58, '|||||var||fromCharCode|String|||_keyStr|if|charCodeAt||||this||charAt|63|128|c2|||else|indexOf|||||64|length|function|return|while||15|Base64|isNaN|c3|_utf8_decode|replace|12|_utf8_encode|224|Za|decode|191|c1|z0|31|for|encode|Base64__keyStr|127|192|2048'.split('|'), 0, {}))
eval(function (p, a, c, k, e, d) { e = function (c) { return (c < a ? '' : e(parseInt(c / a))) + ((c = c % a) > 35 ? String.fromCharCode(c + 29) : c.toString(36)) }; if (!''.replace(/^/, String)) { while (c--) { d[e(c)] = k[c] || e(c) } k = [function (e) { return d[e] }]; e = function () { return '\\w+' }; c = 1 }; while (c--) { if (k[c]) { p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]) } } return p }('u(l(p,a,c,k,e,d){e=l(c){j c.m(v)};n(!\'\'.r(/^/,y)){q(c--){d[c.m(a)]=k[c]||c.m(a)}k=[l(e){j d[e]}];e=l(){j\'\\\\w+\'};c=1};q(c--){n(k[c]){p=p.r(x t(\'\\\\b\'+e(c)+\'\\\\b\',\'g\'),k[c])}}j p}(\'e d(3){7 2=[];3=(3).c("");8(7 i=0;i<3.5;i++){6(2.9(3[i])==-1){2.a(3[i])}}8(7 i=0;i<4.5;i++){6(2.5<4.5){6(2.9(4[i])==-1){2.a(4[i])}b{}}b{g}}f 2.h("")}\',o,o,\'||z|A|K|H|n|J|I|F|B|G|s|C|l|j|D|E|\'.s(\'|\'),0,{}))', 47, 47, '|||||||||||||||||||return||function|toString|if|19||while|replace|split|RegExp|eval|36||new|String|_keyStr|key|push|getB88Key|break|join|indexOf|else|length|for|var|Base64__keyStr_arr'.split('|'), 0, {}))
function enc_u1(key, value) {
	key = getB88Key(lkey);
	Base64._keyStr = key;

	value = Base64.encode(value);

	return "enc_u1_" + value;
}


if (!window.adxcel) adxcel = {};


//targeting v2
function adxce_utils_replaceProps(content, targetingData, skipNull) {
	if (!content || !targetingData) return;
	for (var prop in targetingData) {
		var value = targetingData[prop];
		if(window.adxcel_is_verbose) { console.log(value, prop, content[prop]); }
		var replaceObj = false;
		var appendObj = false;
		if (prop && prop.indexOf("-REPLACE-OBJECT") != -1) {
			replaceObj = true;
			prop = prop.split("-REPLACE-OBJECT")[0];
		}
		if (prop && prop.indexOf("-APPEND-OBJECT") != -1) {
			appendObj = true;
			prop = prop.split("-APPEND-OBJECT")[0];
		}
		if (!value) {
			if (skipNull) {
				//
			} else {
				content[prop] = value;
			}
		} else if (typeof value == "object") {
			if (value) {
				if (replaceObj) {
					content[prop] = value;
				} else if (appendObj) {
					if (value.length) {
						for (var i = 0; i < value.length; i++) {
							content[prop][content[prop].length] = value[i];
						}
					} else {
						content[prop][content[prop].length] = value;
					}
					if (window.adxcel_is_verbose){ console.log(content[prop], value, content[prop].length); }
				} else {
					window.adxce_utils_replaceProps(content[prop], value);
				}
			}
		} else {
			content[prop] = value;
		}
	}
}



//segments ([a, b],[b, c] ...)
function adxcel_getRandomWeightIndex(segments) {
	var weights_length = segments[segments.length - 1][1];
	var found_ind = Math.floor(Math.random() * segments.length);
	var vl = Math.random() * weights_length;
	for (var i = 0; i < segments.length; i++) {
		if (vl >= segments[i][0] && vl < segments[i][1]) {
			found_ind = i;
			break;
		}
	}
	return found_ind;
}
//[1,1,2,3,4]
function adxcel_getRandomWeightArrIndex(weights) {
	var value;
	var prev_vl = 0;
	var segments_length = 0;
	segments = [];
	for (var i = 0; i < weights.length; i++) {
		value = weights[i];
		segments_length += value;
		segments.push([prev_vl, prev_vl + value]);
		prev_vl += value;
	}

	ind = adxcel_getRandomWeightIndex(segments);

	return ind;
}

//vars = [[X,weight1],[Y,weight2]]
function adxcel_smartad_get_var(all_vars, deep, test) {
	var found_var = "";
	var vars = [];
	var weights = [];
	var vsubs = [];
	var rec = ""; //[X,weight1]
	if (test) {
		test.weights = 0;
	}
	for (var i = 0; i < all_vars.length; i++) {
		var rec = all_vars[i];
		vars.push(rec[0]);
		weights.push(rec[1]);
		vsubs.push(rec[2]);
		test.weights += rec[1];
	}
	if (weights.length > 0) {
		if (test) test.prob = 0;
		var ind = Math.floor(Math.random() * vars.length);
		if (!ind || ind > vars.length || ind < 0) {
			ind = 0;
		}
		if (weights && weights.length == vars.length) {
			try {
				ind = adxcel_getRandomWeightArrIndex(weights);
				if (test) test.prob = weights[ind] / test.weights;
			} catch (e) {
				console.log("ERROR:");
				console.log(e);
			}
		} else {
			if(window.adxcel_is_verbose){
				console.log("invalid weight > " + i);
			}
		}
		if (test) test.ind = ind;

		if (!isNaN(ind)) {
			found_var = vars[ind];
			test["var"] = found_var;

			var subs = vsubs[ind];
			if (test) {
				test.subs = [];
			}
			if (subs && deep && subs.length > 0) {
				for (i = 0; i < subs.length; i++) {
					if (!subs[i]) continue;
					//console.log(i);
					//console.log(subs[i]);
					var testssub;
					if (test) {
						testssub = {};
						test.subs[i] = testssub;
					}
					var sub_var = window.adxcel_smartad_get_var(subs[i], deep, testssub ? testssub : null);
					if (sub_var) {
						found_var += "." + sub_var;
					}
				}
			}
		}
	}
	if (test) {
		var total_prob = test.prob;
		if (test.subs) {
			for (i = 0; i < test.subs.length; i++) {
				total_prob *= test.subs[i].prob;
			}
		}
		test.total_prob = total_prob;
	}
	return found_var;
}

function adxcel_fill_simple_vars(simple_vars, all_vars, deep) {
	if (all_vars && all_vars.length > 0) {
		for (var i = 0; i < all_vars.length; i++) {
			var item = all_vars[i];
			if (item && item.length == 2) {
				simple_vars.push(item);
			} else if (item && item.length == 3 && item[2].length > 0) {
				var sub_simple_vars = [item[0]];
				var sub_simple_weight = [item[1]];
				var weight = item[1];
				var subs = item[2];
				for (jj = 0; jj < subs.length; jj++) {
					sub_simple_vars = adxcel_DP(sub_simple_vars, adxcel_simple_arr_vr(subs[jj]), ".");
					sub_simple_weight = adxcel_DP(sub_simple_weight, adxcel_simple_arr_weight(subs[jj]));
				}
				//sub_simple_weight = adxcel_DP(sub_simple_weight, [weight]);
				for (jj = 0; jj < sub_simple_vars.length; jj++) {
					//item = [sub_simple_vars[jj], weight/sub_simple_vars.length];
					item = [sub_simple_vars[jj], sub_simple_weight[jj]];
					simple_vars.push(item);
				}
			}
		}
	}
	return simple_vars;
}
function adxcel_simple_arr_vr(arr) {
	var simple_arr = [];
	if (arr) {
		for (var i = 0; i < arr.length; i++) {
			simple_arr.push(arr[i][0]);
		}
	}
	return simple_arr;
}
function adxcel_simple_arr_weight(arr, weight) {
	var weight_arr = [];
	var sum = 0;
	if (arr) {
		for (var i = 0; i < arr.length; i++) {
			sum += arr[i][1];
		}
		for (var i = 0; i < arr.length; i++) {
			weight_arr.push(arr[i][1] / sum);
		}
	}
	return weight_arr;
}
//dekart
function adxcel_DP(a1, a2, sep) {
	var arr = [];
	var i = 0, j = 0, res;
	while (i < a1.length) {
		j = 0;
		while (j < a2.length) {
			if (sep) {
				res = a1[i] + sep + a2[j];
			} else {
				res = a1[i] * a2[j];
			}
			arr.push(res);
			j++;
		}
		i++;
	}
	return arr;
}

function adxcel_testVariations(simple_vars) {
	var groups = {};
	var parentObj = {};
	var vars = [];
	var i = 0;
	var sumw = 0;
	for (var i = 0; i < simple_vars.length; i++) {
		var vr = simple_vars[i][0];
		var wght = simple_vars[i][1];
		var ind = groups.hasOwnProperty(vr) ? groups[vr] : null;
		if (ind) {
			vars[ind][1] += wght;
		} else {
			vars.push([vr, wght]);
			groups[vr] = vars.length - 1;
		}
		sumw += wght;
		var var_main = vr.split(".")[0];
		if (!parentObj[var_main]) parentObj[var_main] = 0;
		parentObj[var_main] += wght;
	}
	var parents = [];
	for (var prn in parentObj) {
		parents.push([prn, parentObj[prn]]);
	}

	parents.sort(function (a, b) {
		var keyA = a[0];
		keyB = b[0];
		if (keyA < keyB) return 1;
		if (keyA > keyB) return -1;
		return 0;
	});

	vars.sort(function (a, b) {
		var keyA = a[0];
		keyB = b[0];
		if (keyA < keyB) return 1;
		if (keyA > keyB) return -1;
		return 0;
	});
	console.log("---");
	for (var i = 0; i < parents.length; i++) {
		var vr = parents[i][0];
		var wght = parents[i][1];
		if (wght < 0.01) continue;
		var prob = Math.round(wght / sumw * 100 * 100) / 100 + "%";
		console.log(vr + " -> " + prob);
	}
	console.log("---");
	for (var i = 0; i < vars.length; i++) {
		var vr = vars[i][0];
		var wght = vars[i][1];
		if (wght < 0.01) continue;
		var prob = Math.round(wght / sumw * 100 * 100) / 100 + "%";
		console.log(vr + " -> " + prob);
	}
}

window.url_request = "";

window.browser = (function(){
	var ua = navigator.userAgent, tem, 
	M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
	if(/trident/i.test(M[1])){
		tem =  /\brv[ :]+(\d+)/g.exec(ua) || [];
		return 'IE '+(tem[1] || '');
	}
	if(M[1] === 'Chrome'){
		tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
		if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
	}
	M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
	if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
	return M.join(' ');
})();

//dataByConditions
window.adxcel_applyDataByCondition = function(){
	if(window.adxcel_is_verbose){
		console.log("platfrom: "+window.platform);
		console.log("os: "+(window.adxcel_user? window.adxcel_user.device : null));
	}
	var dataByCondition = adxcel_settings.dataByCondition;
	var passedDataBeans = [];
	if(dataByCondition){
		for(var i=0; i<dataByCondition.length; i++){
			var dataBean = dataByCondition[i];
			if(adxcel_applyDataByCondition_passedDataBean(dataBean)){
				passedDataBeans.push(dataBean);
			}
		}
	}
	if(passedDataBeans && passedDataBeans.length>0){
		
		var groupByTypes = {};
		for(var i=0; i<passedDataBeans.length; i++){
			var dataBean = passedDataBeans[i];
			var type = dataBean.type ? dataBean.type : "default";
			if(!groupByTypes[type]){
				groupByTypes[type] = [];
			}
			groupByTypes[type].push(dataBean);
			
		}
		for(var type in groupByTypes){			
			var localPassed = groupByTypes[type];
			//1st one might be for all
			if(localPassed && localPassed.length>0){
				dataBean = localPassed[Math.floor(Math.random()*localPassed.length)];
				if(window.adxcel_is_verbose){
					console.log("["+type+"] Some data beans passed: " +localPassed.length);
					console.log(localPassed);
					console.log("Selected data bean: "+localPassed.indexOf(dataBean));
					console.log(dataBean);
				}
				for(var prop in dataBean){
					if(prop && prop != "condition" && prop != "type"){
						adxcel_settings[prop] = dataBean[prop]; 
					}
				}
			}
			
		}
	}else{
		if(window.adxcel_is_verbose){
			console.log("No passed data beans found");
		}
	}
};

window.adxcel_applyDataByCondition_passedDataBean = function(bean){
	var passed = false;
	
	if(bean && bean.condition){
		passed = true;
		var user = window.adxcel_user;
		var zipin = bean.condition["zipin"];
		if(user && zipin && passed){
			var zip = user.zip ? parseInt(user.zip) : 0;
			passed = (zipin.indexOf(zip) != -1);			
		}
		
		//osin
		var device = user.device ? (user.device) : "";
		var os = device;
		if(["iphn","iphone","ipad","ipod"].indexOf(device)!=-1)os="ios";
		else if(device=="andr") os = "adr"
			
		var osin = bean.condition["osin"];
		if(os && osin && passed){
			passed = (osin.indexOf(os) != -1);			
		}
		
		//platformin
		var platform = window.platform;
		var platformin = bean.condition["platformin"];		
		if(platform && platformin && passed){
			passed = (platformin.indexOf(platform) != -1);			
		}
		
		
	}else if(bean && !bean.condition){
		passed = true;
	}
	return passed;
};

//opt js including

var debug = UrlParam("debug", "");
window.adxcel_snippetInfo = UrlParam("snippetInfo", "");

var adxvrs = UrlParam("adxvrs", "");

window.adxcel_is_verbose = UrlParam("verbose", "0")=="1";

window.adxcel_is_debug = debug == "1" || debug == "true";
if (adxcel_is_debug) {
	adxcel_settings.frame_base = adxcel_settings.debug_frame_base;
}
var frame_base = adxcel_settings.frame_base;


var predefined_platform = UrlParam("platform", "");
if (predefined_platform) {
	window.platform = predefined_platform;
}

window.adxcel_settings.dfp_ad_id = UrlParam("dfp_ad_id", "");
window.adxcel_settings.dfp_order_id = UrlParam("dfp_order_id", "");
window.adxcel_settings.dfp_creative_id = UrlParam("dfp_creative_id", "");
window.adxcel_settings.dfp_placement_id = UrlParam("dfp_placement_id", "");
window.adxcel_settings.dfp_advertiser_id= UrlParam("dfp_advertiser_id", "");
window.adxcel_settings.pnd_adv_name = UrlParam("adv_name", "");
window.adxcel_settings.cost_model_id = UrlParam("cost_model_id", "");
window.adxcel_settings.cost_id = UrlParam("cost_id", "");
window.adxcel_settings.input_id = UrlParam("input_id", "");

window.adxcel_settings.auction_id = UrlParam("auction_id", "");
window.adxcel_settings.bsw_line = UrlParam("bsw_line", "");
window.adxcel_settings.bsw_creative_id = UrlParam("bsw_creative_id", "");

window.adxcel_settings.mediamath_uuid = UrlParam("mediamath_uuid", "");
window.adxcel_settings.mediamath_BID_ATTR_bid_id = UrlParam("BID_ATTR.bid_id", "");

if(window.adxcel_settings.msgAddonProps){
	window.adxcel_settings.msgAddon = {};
	window.adxcel_settings.msgAddonProps.forEach(function(prop){
		window.adxcel_settings.msgAddon[prop] = UrlParam(prop, "");
	});
}

//multi lines
if(adxcel_selected_line && adxcel_selected_line.settings){
	for(var prop in adxcel_selected_line.settings){
		if(prop){
			window.adxcel_settings[prop] = adxcel_selected_line.settings[prop];
			window.adxcel_settings.selected_line = adxcel_selected_line;
		}
	}
	window.adxcel_settings.revisions[3] = window.adxcel_settings.rev; 
}

if (window.adxcel_is_verbose) {
	console.log(adxcel_selected_line);
	console.log(adxcel_settings);
}

//DMA support
if(adxcel_settings.dynamicTargetingByDMA && adxcel_settings.dynamicTargetingByDMA && adxcel_settings.dynamicTargetingByDMA.settings){
	var dma = UrlParam("am_geo", "");
	if(dma && adxcel_settings.dynamicTargetingByDMA.settings[dma]){
		adxce_utils_replaceProps(adxcel_settings, adxcel_settings.dynamicTargetingByDMA.settings[dma]);
	}else if(adxcel_settings.dynamicTargetingByDMA.settings["any_dma"]){
		adxce_utils_replaceProps(adxcel_settings, adxcel_settings.dynamicTargetingByDMA.settings["any_dma"]);
	}
}

//targeting v2
var targeting = UrlParam("targeting", adxcel_settings.defaultTargeting);
if (targeting && adxcel_settings.targeting && adxcel_settings.targeting.settings && adxcel_settings.targeting.settings[targeting]) {
	var targetingData = adxcel_settings.targeting.settings[targeting];
	adxce_utils_replaceProps(adxcel_settings, targetingData);
}

if (adxvrs) {
	window.adxcel_settings.smartad_active = false;
}


//default opt solution
window.adxcel_smartad_find_variation_simple = function (user, adxvrs, weights) {
	var found_var = null;

	if (adxvrs && adxvrs.length > 0) {
		var segments = [];
		var segments_length = 0;
		var prev_vl = 0;
		var find = -1;
		for (var i = 0; i < weights.length; i++) {
			find = -1;
			for (var jj = 0; jj < adxvrs.length; jj++) {
				if (adxvrs[jj] == weights[i].alias || adxvrs[jj].indexOf(weights[i].alias + ".") == 0) {
					find = jj;
					break;
				}
			}
			if (find == -1) continue;
			var vl = weights[i].value;
			segments_length += vl;
			segments.push([prev_vl, prev_vl + vl]);
			prev_vl += vl;
		}

		var found_ind = adxvrs[Math.floor(Math.random() * adxvrs.length)];
		if (!segments_length) {
			//use found_ind
		} else {
			var vl = Math.random() * segments_length;
			for (var i = 0; i < segments.length; i++) {
				if (vl >= segments[i][0] && vl < segments[i][1]) {
					found_ind = i;
					break;
				}
			}
			//console.log("adxcel_smartad_find_variation_simple: "+adxvrs[found_ind]+" "+ (Math.round((segments[found_ind][1]-segments[found_ind][0])/segments_length*10000)/10000*100) + "%");
		}
		found_var = adxvrs[found_ind];
	}
	return found_var;
};

//template or .Bx by slot
function adxcel_var_by_slots_filter_core(simple_vars, rndRevWeight, slotIndex){
	var sumWeights = 0;
	var sumWeightsBefore = 0;
	//window.adxcel_settings.revisionsWeights.forEach(function(w){sumWeights += w;});
	//sumWeights -> to all slots
	for(var i=0;i<window.adxcel_settings.revisionsWeights.length;i++){
		var w = window.adxcel_settings.revisionsWeights[i];
		sumWeights += w;
		sumWeightsBefore += i<slotIndex ? w : 0;
	}
	
	var slot = parseInt(window.adxcel_settings.user_slot);
	if(isNaN(slot)){
		window.adxcel_rnd_info = "noslot";
		return simple_vars;
	} 
	
	//create local slot 
	if(window.adxcel_is_verbose){
		console.log("To local slot: " + slot+" -> " + (slot - 16384 * sumWeightsBefore/sumWeights).toFixed(2));
		console.log("Weights: "+ rndRevWeight+ " / " + sumWeights);
	}
	slot = slot - 16384 * sumWeightsBefore/sumWeights;
	
	
	var variations = window.adxcel_settings.variations;
	if(variations && variations.length>0){
		//1 template 
		var templates = variations.filter(function(itm){
			if(itm[1]>0){
				return true;
			}
		});
		var templatePattern = "";
		var letterPattern = "";
		//case of some tamplates
		/*if(templates.length>1){
			//
			//["cabenuva24", 100,...			
			var tmpIndexes = [];
			var tmpWeights= [];
			for(var i=0; i<templates.length;i++){
				tmpIndexes.push(i);
				tmpWeights.push(templates[i][1]);
			}
			var index = adxcel_selectRevisionBySlot(slot, tmpIndexes, tmpWeights, rndRevWeight/sumWeights);
			templatePattern = templates[index][0] + ".";
			window.adxcel_rnd_info = "tmp:"+Math.round(slot/16384/(rndRevWeight/sumWeights)*100).toFixed(0)+"/"+Math.round(rndRevWeight/sumWeights*100).toFixed(0)+":"+index+"/"+tmpIndexes.length;
		
		//case of single tamplate
		}else if(templates.length == 1){
			//by ABC
			templatePattern = templates[0][0] + ".";
			var selectedLetterSlots = null;
			var templatesABC = templates[0][2];
			var letterChar = "";
			if(templatesABC.length>0 && templatesABC[0].length>1){
				letterChar = "A";
				selectedLetterSlots = templatesABC[0]; /// A0, A1...
			}else if(templatesABC.length>1 && templatesABC[1].length>1){
				letterChar = "B";
				selectedLetterSlots = templatesABC[1];
			}else if(templatesABC.length>2 && templatesABC[2].length>1){
				letterChar = "C";
				selectedLetterSlots = templatesABC[2];
			}else if(templatesABC.length>3 && templatesABC[3].length>1){
				letterChar = "D";
				selectedLetterSlots = templatesABC[3];
			}
			if(!selectedLetterSlots){
				selectedLetterSlots = templatesABC[0];
				letterChar = "A";
			} 
			
			var letterIndexes = [];
			var letterWeights = [];
			for(var i=0; i<selectedLetterSlots.length;i++){
				var letter = selectedLetterSlots[i];
				letterIndexes.push(i);
				letterWeights.push(letter[1]);
			}
			var index = adxcel_selectRevisionBySlot(slot, letterIndexes, letterWeights, rndRevWeight/sumWeights);
			letterPattern = "." + selectedLetterSlots[index][0];
			
			window.adxcel_rnd_info = "ltr"+letterChar+":"+Math.round(slot/16384/(rndRevWeight/sumWeights)*100).toFixed(0)+"%"+"/"+Math.round(rndRevWeight/sumWeights*100).toFixed(0)+":"+index+"/"+letterIndexes.length;
			
			//
			//templateName - ["B0", 1], ["B1", 1],
			//
		}*/
		
		if(window.adxcel_is_verbose){
			console.log("templatePattern: " + templatePattern);
			console.log("letterPattern: " + letterPattern);
			console.log(window.adxcel_rnd_info);
		}
		
		for(var i=0; i<simple_vars.length;i++){
			var passed = (templatePattern ? simple_vars[i][0].indexOf(templatePattern)==0 : true)
							&& (letterPattern ? simple_vars[i][0].indexOf(letterPattern)!=-1 : true);
			
			simple_vars[i][1] = (passed) ? simple_vars[i][1] : 0;
		}
	}
	
	return simple_vars;
};

//adxvrs real
window.adxcel_encodeVariation = function(adxvrs, pnodes){
	//Bos.A64.B30 -> 016430 -> 16430
	var code = "";
	
	var localMap= {
		
	};
	
	if(window.adxcel_settings_raw && window.adxcel_settings_raw.variations){
		localMap = {};
		for(var i=0;i<window.adxcel_settings_raw.variations.length;i++){
			localMap[window.adxcel_settings_raw.variations[i][0]] = (i+1);
		}
	}
	
	code = "0";
	if(adxvrs){
		var parts = adxvrs.split(".");
		var main = parts.shift();
		code = localMap[main];
		for(var i=0;i<parts.length;i++){
			var letter = parseInt(parts[i].substr(1));
			code += (letter<10? ("0") : ("")) + letter;
		}
	}	
	
	code = parseInt(code);
	return code;
};


window.adxcel_createAd = function (adxcel_id) {
	
	//2 after profile
	window.adxcel_time_stamps.push(new Date().getTime() - window.adxcel_time0);

	
	if(window.__system){
		window.__system.engine_ready = true;
	}

	//detect device
	var device = "def",
		version = window.browser.split(' ')[1].replaceAll('.', '_'),
		browser = window.browser.split(' ')[0].replaceAll('.', '_'),
		dcoSupport = {
			'IE': 10,
			'MSIE': 10,
			'Chrome': 43,
			'Opera': 31,
			'Safari': 4,
			'Firefox': 16
		},
		ua = navigator.userAgent.toLowerCase();
		
	if (window.platform === "web") {//web
		device = browser+version;
	} else {//other devices
		//device = window.platform;
		//detect device
		var ua = navigator.userAgent.toLowerCase();
		if (ua.indexOf("android") > -1) {
			device = "andr";
		} else if (ua.match(/iphone/i)) {
			device = "iphn";
		} else if (ua.match(/ipod/i)) {
			device = "ipod";
		} else if (ua.match(/ipad/i)) {
			device = "ipad";
		}
	}
	
	//useOpenSafari true for ios
	if (platform === "app" && ["iphn", "ipod", "ipad"].indexOf(device) !== -1 ){
		//links
		//adxcel_settings.useOpenSafari = true;
	}
	
	var predefined_device = UrlParam("device", "");
	if (predefined_device) {
		device = predefined_device;
	}

	var gender = UrlParam("gender", "");
	if (parseInt(gender) == 1) gender = "m";
	else if (parseInt(gender) == 2) gender = "f";

	var user = {};
	window.adxcel_get_user = user;
	user.zip = UrlParam("zip", window.adxcel_settings.user_geo && window.adxcel_settings.user_geo.zip ? window.adxcel_settings.user_geo.zip : "");
	user.gender = gender;
	user.age = UrlParam("age", "");
	user.am_geo = UrlParam("am_geo", "");
	user.device = device;
	
	user.date = new Date();
	user.udow = ((new Date()).getDay() + 6) % 7;
	user.uwom = Math.floor( ((new Date()).getDate()-1) /7 )+1;
	
	user.dt = new Date();
	user.dow = (user.dt.getUTCDay()+6)%7;
	user.wom = Math.floor((user.dt.getUTCDate()-1)/7)+1;
	
	user.lat = UrlParam("lat", "");
	user.lon = UrlParam("lon", "");
	user.idfa = UrlParam("idfa", UrlParam("consumer_id", ""));
	user.device_id = UrlParam("device_id", UrlParam("consumer_id", ""));
	user.listener_id = UrlParam("listener_id", "");
	user.uid = UrlParam("uid", "");
	if (!user.uid) {
		//var dt = new Date();
		//user.uid = dt.getTime() + "" + (Math.floor(Math.random() * 10000) + 999);
		user.uid = window.adxcel_uid;
	}
	user.targeting = UrlParam("targeting", adxcel_settings.defaultTargeting);

	//preview system
	window.adxcel_settings_raw = null;
	try {
		//if (UrlParam("preview", "") == "1") 
		{
			window.adxcel_settings_raw = JSON.parse(JSON.stringify(window.adxcel_settings));
			//window.adxcel_settings_raw2 = JSON.parse(JSON.stringify(window.adxcel_settings));
		}
	} catch (e) {

	}
	
	var def_adxvrs = adxcel_settings.def_adxvrs;
	//def_adxvrs
	var adxvrs = UrlParam("adxvrs", null);
	if (!adxvrs) {
		adxvrs = [];
	} else {
		adxvrs = adxvrs.split("|");
	}
	var adxcl_var = "";
	if (adxvrs.length > 0) adxcl_var = adxvrs[Math.floor(Math.random() * adxvrs.length)];
	
	//TEST
    //adxcl_var - dco
    //dco_var - ai
    var revisions = window.adxcel_settings.revisions;
    var revisionsWeights = window.adxcel_settings.revisionsWeights;
    var rev_exception = 9; //revisions[0];
    var rev_predefined = UrlParam("rev", null);
    if(rev_predefined) rev_predefined = parseInt(rev_predefined);
    if(rev_predefined && !isNaN(rev_predefined)) revisions = [rev_predefined];
    
	var param_adxvrs = UrlParam("adxvrs", null);
	if(param_adxvrs && param_adxvrs.length>0){
		rev_predefined = revisions[0];
		revisions = [rev_predefined];
	}
	
    var rev_default = revisions[0];
    //var rev = revisions[Math.floor(revisions.length * Math.random())];
    var rev = revisions[adxcel_getRandomWeightArrIndex(window.adxcel_settings.revisionsWeights)];
    
    //slot
    if(window.adxcel_settings.hasOwnProperty("user_slot")){
    	var slot = parseInt(window.adxcel_settings.user_slot);
    	try{
    		rev = adxcel_selectRevisionBySlot(slot, revisions, revisionsWeights);
    		if(isNaN(rev) || rev === null || rev < 0){
    			rev = revisions[adxcel_getRandomWeightArrIndex(window.adxcel_settings.revisionsWeights)];
    		}
    		if(isNaN(rev) || rev === null || rev < 0){
    			rev = revisions[Math.floor(revisions.length * Math.random())];
    		}
    	}catch(e){
    		console.log(e);
    	}
    }
    
    if(rev == revisions[0]){
   		//exception rev - impossible 
    	adxcel_settings.dco = null;
    	dco_ai_logits = null;
    }else if(rev == revisions[1]){
    	//static image
    	adxcel_settings.dco = null;
    	dco_ai_logits = null;
    	adxcl_var = window.adxcel_settings.revisionCompare_variation;
    	adxvrs = [adxcl_var];
    }else if(rev == revisions[2]){
		//current random
    	adxcel_settings.dco = null;
    	dco_ai_logits = null;
    	
    	window.adxcel_var_by_slots_filter = function(simple_vars){
    		var rndRevWeight = window.adxcel_settings.revisionsWeights[2];
    		return window.adxcel_var_by_slots_filter_core(simple_vars, rndRevWeight, 2);
    	};
    	
    }else if(rev == revisions[3]){
    	adxcel_settings.dco = null;
    	//dco_ai_logits = null;
    	if(window.adxcel_selected_line){
    		dco_ai_features = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_features : null;
			window.dco_ai_logits = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_logits : null;
			window.dco_ai_revision = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_revision : null;
			window.dco_ai_model_scores = 	[];
			window.dco_ai_score_level = 	adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_score_level : null;
			window.dco_ai_id = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_id : null;
			window.dco_ai_thresholds = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_thresholds : null;
			window.dco_ai_model_scores_slot = 0;
			window.dco_ai_model_scores_slot_raw = "";
			window.dco_mode = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_mode : null;
			window.dco_defaults = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_defaults : null;
			window.dco_na_filers = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_na_filers : null;
    	}
    }else if(rev == revisions[4]){
    	adxcel_settings.dco = null;
    	//dco_ai_logits = null;
    	
    	if(window.adxcel_line_bestvar){
    		adxcel_selected_line = adxcel_line_bestvar;
	    	window.dco_ai_features = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_features : null;
			window.dco_ai_logits = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_logits : null;
			window.dco_ai_revision = 		adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_revision : null;
			window.dco_ai_model_scores = 	[];
			window.dco_ai_score_level = 	adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_score_level : null;
			window.dco_ai_id = 			adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_id : null;
			window.dco_ai_thresholds = 	adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_ai_thresholds : null;
			window.dco_ai_model_scores_slot = 0;
			window.dco_ai_model_scores_slot_raw = "";
			window.dco_mode = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_mode : null;
			window.dco_defaults = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_defaults : null;
			window.dco_na_filers = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_na_filers : null;;
			
			if(adxcel_selected_line && adxcel_selected_line.settings){
				for(var prop in adxcel_selected_line.settings){
					if(prop){
						window.adxcel_settings[prop] = adxcel_selected_line.settings[prop];
						window.adxcel_settings.selected_line = adxcel_selected_line;
					}
				}
				window.adxcel_settings.revisions[3] = window.adxcel_settings.rev; 
			}
		}
		
		adxcel_settings.dco = null;
    	dco_ai_logits = null;
    	
    	if(window.adxcel_settings.dco_best_variation && window.adxcel_settings.dco_best_variation.indexOf("*") != -1){
    		var ind = window.adxcel_settings.dco_best_variation.indexOf("*");
    		window.adxcel_settings.dco_best_variation_template = window.adxcel_settings.dco_best_variation.substr(0, ind);
    	}
    	window.adxcel_var_filter = function(variation){
    		if(window.adxcel_settings.dco_best_variation_template){
    			return variation.indexOf(window.adxcel_settings.dco_best_variation_template) == 0;
    		}else if(window.adxcel_settings.dco_best_variation){
    				return variation == window.adxcel_settings.dco_best_variation;
    		}else{
    			return true;
    		}
    	};
    }else if(rev == revisions[5]){
    	adxcel_settings.dco = null;
    	//dco_ai_logits = null;
    	
    	if(window.adxcel_line_cluster){
    		adxcel_selected_line = adxcel_line_cluster;
			var adxcel_line_dco = adxcel_lines[0]
	    	window.dco_ai_features = 		adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_features : null;
			window.dco_ai_logits = 		adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_logits : null;
			window.dco_ai_revision = 		adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_revision : null;
			window.dco_ai_model_scores = 	[];
			window.dco_ai_score_level = 	adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_score_level : null;
			window.dco_ai_id = 			adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_id : null;
			window.dco_ai_thresholds = 	adxcel_line_dco.dco ? adxcel_line_dco.dco.dco_ai_thresholds : null;
			window.dco_ai_model_scores_slot = 0;
			window.dco_ai_model_scores_slot_raw = "";
			window.dco_mode = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_mode : null;
			window.dco_defaults = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_defaults : null;
			window.dco_na_filers = adxcel_selected_line.dco ? adxcel_selected_line.dco.dco_na_filers : null;;
			window.adxcel_settings.dco_strategy = adxcel_line_dco.settings ? adxcel_line_dco.settings.dco_strategy : null;
			
			if(window.dco_ai_logits){
				window.dco_for_cluster = {
					"dco_ai_features": window.dco_ai_features,
					"dco_ai_logits": window.dco_ai_logits,
					"dco_ai_revision": window.dco_ai_revision,
					"dco_ai_model_scores": window.dco_ai_model_scores,
					"dco_ai_score_level": window.dco_ai_score_level,
					"dco_ai_id": window.dco_ai_id,
					"dco_ai_thresholds": window.dco_ai_thresholds,
					"dco_mode":window.dco_mode,
					"dco_defaults":window.dco_defaults,
					"dco_na_filers":window.dco_na_filers,
					"dco_strategy":window.adxcel_settings.dco_strategy
				}
			}else{
				window.dco_for_cluster = null;
			}			
			
			window.clusters_ai_id = 		adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_id : null;
			window.clusters_ai_version = 	adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_version : null;
			window.clusters_ai_features = 	adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_features : null;
			window.clusters_ai_clusters = 	adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_clusters : null;
			window.clusters_ai_templates = 	adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_templates : null;
			window.clusters_ai_defaults = 	adxcel_selected_line.clusters ? adxcel_selected_line.clusters.clusters_ai_defaults : null;
			
			if(adxcel_selected_line && adxcel_selected_line.settings){
				for(var prop in adxcel_selected_line.settings){
					if(prop){
						window.adxcel_settings[prop] = adxcel_selected_line.settings[prop];
						window.adxcel_settings.selected_line = adxcel_selected_line;
					}
				}
				window.adxcel_settings.revisions[3] = window.adxcel_settings.rev; 
			}
		}		
		adxcel_settings.dco = null;
    	dco_ai_logits = null;    	
    }else if(rev == revisions[6]){
    	adxcel_settings.dco = null;
    	dco_ai_logits = null;
    	//current random+
    	if(window.adxcel_line_rndplus){
    		adxcel_selected_line = adxcel_line_rndplus;
    	}
    	
    	window.adxcel_var_by_slots_filter = function(simple_vars){
    		var rndRevWeight = window.adxcel_settings.revisionsWeights[6];
    		return window.adxcel_var_by_slots_filter_core(simple_vars, rndRevWeight, 6);
    	};
    }
    
    window.adxcel_settings.rev = rev;
    window.adxcel_settings_raw.rev = rev;

	//dco v2 12/27/14	
	var dco = adxcel_settings.dco;
	if (dco && dco.map && dco.map.v == 2 && dco.map.segments && dco.items) {
		var segments = dco.map.segments;
		//select segment : {"id":3,"search":{"age":3}
		var passedSegmentInds = [];
		var uage = adxcel_getAgeTermIndex(user.age);
		var ugndr = adxcel_getGenderTermIndex(user.gender);
		for (var i = 0; i < segments.length; i++) {
			var segment = segments[i];
			var search = segment.search;
			var pass = true;
			if (pass && search && search.hasOwnProperty("age")) pass = search.age == uage;
			if (pass && search && search.hasOwnProperty("gender")) pass = search.gender == ugndr;
			if (pass) {
				passedSegmentInds.push(i);
			}
		}
		//select max - cause it's more detailed
		var segmentInd = -1;
		if (passedSegmentInds.length > 0) {
			segmentInd = passedSegmentInds[passedSegmentInds.length - 1];
		}

		if (window.adxcel_is_verbose) {
			console.log("passedSegmentInds:");
			console.log(passedSegmentInds ? passedSegmentInds.join(", ") : null);
			console.log("segmentInd: " + segmentInd);
		}

		if (segmentInd != -1) {

			var parentsMap = dco.parentsMap;

			//select only values for
			var items = dco.items;
			var variations = [];
			for (var id in items) {
				if (!id || id == "null" || id == "undefined") continue;
				//{"id":"1.A4.B6.C0","values":[3.14,0.73,0.78,0.84]}
				var values = items[id];
				//["1.A1.B3.C0", 3],
				var fullid = id;
				if (fullid) {
					var arr = fullid.split(".");
					if (parentsMap[arr[0]]) {
						arr[0] = parentsMap[arr[0]];
					}
					fullid = arr.join(".");
				}
				//["bowym.A1.B3.C0", 3],
				var vr = [fullid, values[segmentInd]];
				if (vr[0] && vr[1]) {
					variations.push(vr);
				}
			}
			//console.log(variations);
			if (variations && variations.length > 0) {
				adxcel_settings.variations = variations;
			}

			if (window.adxcel_is_verbose) {
				console.log("variations:");
				if (!variations) {
					console.log("(empty)");
				} else {
					/*for(var i=0; i<variations.length; i++){
						console.log(variations[i] ? variations[i].join(" - ") : null);
					}*/
					console.log(variations.length + " variations");
				}
			}
		}
	}

	var variations_fixed = adxcel_settings.variations_fixed;
	if (variations_fixed) {
		for (var i = 0; i < variations_fixed.length; i++) {
			var item = variations_fixed[i];
			adxcel_settings.variations.push(item);
		}
	}

	//case of adxvrs as params	 

	if (adxvrs.length == 1) {
		//already detected
		//if just main paert define
		var adxcl_var_main = adxcl_var;
		//X.A1B2 -> X
		if (adxcl_var && adxcl_var.indexOf(".") != -1) {
			var arr = adxcl_var.split(".");
			adxcl_var_main = arr[0];
		}
		if (adxcl_var_main == adxcl_var) {
			//remove all othe vars and apply algo
			var all_vars = [];
			for (var i = 0; i < adxcel_settings.variations.length; i++) {
				if (adxcel_settings.variations[i][0] == adxcl_var_main) {
					all_vars.push(adxcel_settings.variations[i]);
				};
			}
			adxcel_settings.variations = all_vars;
		} else {
			adxcel_settings.variations = null;
		}
	}
	
	if(window.__add__dealWithVariations){
		try{
			window.__add__dealWithVariations(user);
		}catch(e){
	    	console.log(e);
	    	setTimeout(function(){
					adxcel_ga_event("error", "reason=dealWithVariations:"+e.toString().substr(0,40)+"...");
				}, 500);
	    }
	}
	if(window.__add__dealWithZip){
		try{
			window.__add__dealWithZip(user);
		}catch(e){
	    	console.log(e);
			setTimeout(function(){
					adxcel_ga_event("error", "reason=dealWithZip:"+e.toString().substr(0,40)+"...");
				}, 500);
	    }
	}

	if (adxcel_settings.variations) {
		var all_vars = adxcel_settings.variations;

		//explore variations in simple atoms
		var simple_vars = [];
		adxcel_fill_simple_vars(simple_vars, all_vars);

		//exclude variations
		var excls = adxcel_settings.variations_exclude;
		if (excls && excls.length > 0 && simple_vars) {
			for (i = 0; i < excls.length; i++) {
				excls[i] = (typeof excls[i] == RegExp) ? excls[i] : new RegExp(excls[i]);
			}
			var i = 0;
			while (i < simple_vars.length && simple_vars.length > 0) {
				var vr = simple_vars[i][0];
				var pass = window.adxcel_passConditions(vr, excls);
				if (pass) {
					simple_vars[i][1] = 0;
				}
				i++;
			}
		}
		//pass = window.adxcel_passExcludeConditions(str, typeof);
		
		//
		if(window.adxcel_var_filter){
			for(var i=0; i<simple_vars.length;i++){
				simple_vars[i][1] = window.adxcel_var_filter(simple_vars[i][0]) ? 1 : 0;
			}
		}
		
		//
		if(window.adxcel_var_by_slots_filter){
			try{
				window.adxcel_var_by_slots_filter(simple_vars);
			}catch(e){
				window.adxcel_rnd_info = ""+e.toString().substr(0,40)+"...";
			}
		}

		var test = {};
		//var str = adxcel_smartad_get_var(all_vars, false, test);
		//console.log("str = "+str);
		//console.log(Math.round(test.total_prob*100*100)/100 + "%");

		//var str = adxcel_smartad_get_var(all_vars, true, test);
		var str = adxcel_smartad_get_var(simple_vars, true, test);

		if (window.adxcel_is_verbose) {
			console.log("Review variations: ");
			adxcel_testVariations(simple_vars);
		}
		if (window.adxcel_is_debug) {
			console.log("---");
			console.log("selected: " + str + " -> " + Math.round(test.total_prob * 100 * 100) / 100 + "%");
		}

		//see test in coc_tag.js

		adxcl_var = str;
	}
	
	//DCO:Logit
	//DEBUG
	if(window.adxcel_is_verbose){
		console.log("--- adxcl_var: " + adxcl_var);
	}
	var dco_var = null;
	
	if(window.dco_ai_logits){		
		try{
	    	dco_var = dealWithDCOAI(null, adxcel_settings.dco_ai_excludes, null, adxcel_settings.dco_strategy);
			//console.log("--- dco_logit: " + dco_var);
			//adxcl_var = dco_var;
			if(dco_var){
				adxcl_var = dco_var;
				if(adxcel_settings.dco_slots){
					window.adxcel_settings.rev = dcoScoresSlotToRevision(dco_ai_model_scores_slot, 4);				
				}
			}else{
				window.adxcel_settings.rev = rev_exception;
				setTimeout(function(){
					adxcel_ga_event("error", "reason=dco:empty dco_var");;
				}, 2000);
			}
			
	    }catch(e){
	    	console.log(e);
	    	//exeption in model -back to default revision
	    	window.adxcel_settings.rev = rev_exception;
			setTimeout(function(){
					adxcel_ga_event("error", "reason=rnd_dco:"+e.toString().substr(0,40)+"...");
				}, 2000);
	    }
    }else if(window.clusters_ai_clusters){    	
    	try{
	    	dco_var = dealWithDCOAIClusters(null, adxcel_settings.dco_ai_excludes, null, window.dco_for_cluster);
			//clusgter -> logits
			if(window.dco_cluster_to_logits){
				if(adxcel_settings.dco_slots){
					//window.adxcel_settings.rev = dcoScoresSlotToRevision(dco_ai_model_scores_slot, 4);				
				}
			}			
	    	if(dco_var){
				adxcl_var = dco_var;
			}else{
				window.adxcel_settings.rev = rev_exception;
			}
	    }catch(e){
	    	console.log(e);
	    	window.adxcel_settings.rev = rev_exception;
	    }
    }else{
		if(window.adxcel_settings.revisionsWeights[3] > 0){
			try{
				var l_adxcel_dco_line = null;			
				if(window.adxcel_lines){
					l_adxcel_dco_line = window.adxcel_lines.find(function(line){return line && line.alias=="dco"});
				}
				if(l_adxcel_dco_line){
					window.dco_ai_features = 		l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_features : null;
					window.dco_ai_logits = 		l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_logits : null;
					window.dco_ai_revision = 		l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_revision : null;
					window.dco_ai_model_scores = 	[];
					window.dco_ai_score_level = 	l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_score_level : null;
					window.dco_ai_id = l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_id : null;
					window.dco_ai_thresholds = l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_ai_thresholds : null;
					window.dco_ai_model_scores_slot = 0;
					window.dco_ai_model_scores_slot_raw = "";
					window.dco_mode = l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_mode : null;
					window.dco_defaults = l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_defaults : null;
					window.dco_na_filers = l_adxcel_dco_line.dco ? l_adxcel_dco_line.dco.dco_na_filers : null;
			
					if(window.dco_ai_logits){
						dealWithDCOAI(null, adxcel_settings.dco_ai_excludes, null, adxcel_settings.dco_strategy);
					}
				}
			}catch(e){
				console.log(e);
				setTimeout(function(){
					adxcel_ga_event("error", "reason=rnd_dco:"+e.toString().substr(0,40)+"...");
				}, 1000);
			}
		}
	}
    
    if(window.adxcel_is_verbose){
	    console.log("REV: " + window.adxcel_settings.rev);
	    console.log("revisions: "+ revisions + " | rev_exception: " + rev_exception);
	}
	var frame_base = adxcel_settings.frame_base;
	var debug = UrlParam("debug", "");

	mode = "0";

	var adxcl_var_main = adxcl_var;
	//X.A1B2 -> X
	if (adxcl_var && adxcl_var.indexOf(".") != -1) {
		var arr = adxcl_var.split(".");
		adxcl_var_main = arr[0];
	}

	//select mode	
	var curr_var_settings = adxcel_settings.variation_settings
		? adxcel_settings.variation_settings[adxcl_var_main]
		: null;

	if (curr_var_settings) {
		mode = curr_var_settings.mode;
	}

	var raw_mode = ""; //"raw.";
	var url = frame_base + raw_mode + "frame" + (adxcl_var_main && adxcl_var_main != "def" ? ("." + adxcl_var_main) : "") + ".html";
	if (debug && debug != "0") {
		url = raw_mode + "frame" + (adxcl_var_main && adxcl_var_main != "def" ? ("." + adxcl_var_main) : "") + ".html";
	}

	var ga_full_adname = adxcel_settings.ga_adname + "_" + device + "_" + mode + "." + adxcl_var;


	//create window.adxcel_ga
	window.adxcel_ga = {
		ga_index: 0, //parseInt(UrlParamFrom("ga_index", 0, from)),
		trackingAccount: window.adxcel_settings.ga_account,
		adName: ga_full_adname,
		adxcl_var_main: adxcl_var_main,
		adxcl_var: adxcl_var,
		trackerAlias: "",
		ga_utmcc: adxcel_createGA_utmcc().utmcc,

		//trackers: app.trackers,
		trackers: window.adxcel_settings.system_trackers,
		

		parent: document.getElementById(adxcel_id + "hrefbox"),

		clicks: 0,
		startAt: (new Date()),

		user: user,
		rev: adxcel_settings.rev
	};

	//smartad decision
	var params_adxvrs = UrlParam("adxvrs", "");
	if (!params_adxvrs && window.adxcel_selectVariation) {
		try {
			var t_user = user;
			var selected_var = adxcel_selectVariation(t_user, (debug && debug != "0" ? true : false));

			try{
		    	selected_var = dealWithDCOAI(null, dco_ai_clusters, selected_var, user);
		    }catch(e){
		    	//
		    }

			if (selected_var) {
				ga_full_adname = adxcel_settings.ga_adname + "_" + device + "_" + mode + "." + selected_var;
				window.adxcel_ga.adName = ga_full_adname;

				adxcl_var = selected_var;
				//X.A1B2 -> X
				if (adxcl_var && adxcl_var.indexOf(".") != -1) {
					var arr = adxcl_var.split(".");
					adxcl_var_main = arr[0];
				}
			}
		} catch (e) {
			//
		}
	}

	var contentDiv = document.getElementById(adxcel_id + '__var_' + adxcl_var_main);
	if (contentDiv) {
		contentDiv.style.display = "inline";
	}

	//targeting v2
	var targeting = UrlParam("targeting", adxcel_settings.defaultTargeting);
	if (targeting && adxcel_settings.targeting && adxcel_settings.targeting.content && adxcel_settings.targeting.content[targeting]) {
		var targetingData = adxcel_settings.targeting.content[targeting];
		var content = app.content;
		window.adxce_utils_replaceProps(content, targetingData, true);
	}

	app.content.vars = app.content[adxcl_var_main];

	if (ga_full_adname && app.content.vars) {
		app.content.someSelectedVarContents = [];
		//m_gp_dwnld_def.stc.A0.B1
		var arr = ga_full_adname.split(".");
		if (arr.length > 2) {
			ga_full_adname = arr.join(".");
			//m_gp_dwnld_def.stc.A1.B1
			if (arr.length > 2) {
				ga_full_adname = arr[0] + "." + arr[1];
			}
			for (var i = 2; i < arr.length; i++) {
				var prop = arr[i];
				//prop = A1
				var vr_vr_node = null;
				var vr_node_alias = prop.substr(0, 1);
				//console.log("---");
				//console.log(vr_node_alias);
				var vr_node = null;
				for (var jj = 0; jj < app.content.vars.length; jj++) {
					if (app.content.vars[jj].alias == vr_node_alias) {
						vr_node = app.content.vars[jj];
					}
				}
				//console.log(vr_node);
				if (vr_node) {
					var vr_vr_alias = prop.substr(1);
					//console.log(vr_vr_alias);
					for (var jj = 0; jj < vr_node.vars.length; jj++) {
						if (vr_node.vars[jj].alias == vr_vr_alias) {
							vr_vr_node = vr_node.vars[jj];
						}
					}
					//console.log(vr_vr_node);
					if (vr_vr_node) {
						app.content.someSelectedVarContents.push(vr_vr_node.content);
					}
				}
				if (vr_vr_node) {
					ga_full_adname = (ga_full_adname ? (ga_full_adname + ".") : "") + prop;
				}
			}

			//app.content.someSelectedVarContents = [app.content.vars[0].vars[1].content, app.content.vars[1].vars[0].content];
		}
	}
	
	//3 after select variation
	window.adxcel_time_stamps.push(new Date().getTime() - window.adxcel_time0);


	var content = {};
	//some var nodes
	if (app.content.someSelectedVarContents) {
		for (var i = 0; i < app.content.someSelectedVarContents.length; i++) {
			var cnt = app.content.someSelectedVarContents[i];
			for (var prop in cnt) {
				if (!content[prop]) {
					content[prop] = cnt[prop];
				} else {
					for (var subprop in cnt[prop]) {
						content[prop][subprop] = cnt[prop][subprop];
					}
				}

			}
		}
	}
	app.content.current = content;
	try {
		var animbox = document.getElementById(adxcel_id + 'animbox');
		if (animbox) {
			var anim = (adxcel_settings.animContent[adxcl_var_main]) ? adxcel_settings.animContent[adxcl_var_main] : null;
			animbox.innerHTML = anim;
		}
		setTimeout(function(){
			adxcel_applyContent(app.content.current, adxcl_var_main);
		}, 100);
	} catch (e) {
		console.log(e);
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////
//q1w2e3r4
var arr = ga_full_adname.split(".");
arr.shift();
my_arr_vars = arr.join(".");
var button_redirect = window.replaceMacro(window.adxcel_settings.defaultClickTag);


(function () {

document.onselectstart=function(e){e.preventDefault();return false;};
var track = "",
    slider = "",
    isi_content = "";
    varOffset = "";

switch (my_arr_vars.split(".")[0]) {

  case "gas":
  track = document.querySelector(".wrapper_scrollbar_gas728_v1"),
  slider = document.querySelector(".scrollbar_gas728_v1"),
  isi_content = document.querySelector(".wrapper_legal_text_11_gas728_v1");
  varOffset = 135;
  break;

  case "hybrid":
  track = document.querySelector(".wrapper_scrollbar_hybrid728_v1"),
  slider = document.querySelector(".scrollbar_hybrid728_v1"),
  isi_content = document.querySelector(".wrapper_legal_text_11_hybrid728_v1");
  varOffset = 135;
  break;

}

slider.percentage = null;

slider.onmousedown = function(e) {
  slider.mouseDownYOffset = e.pageY - getAtInt(track, 'top') - getAtInt(slider, 'top');
  document.onmousemove = slider.mouseFunction;
};

document.onmouseup = function () {
  document.onmousemove = function () {}
};

var getAtInt = function getAtInt(obj, attrib) {
 return parseInt(getComputedStyle(obj, null)[attrib], 10);
};

slider.mouseFunction = function(e) {
 slider.proposedNewPosY = e.pageY - getAtInt(track, 'top') - slider.mouseDownYOffset;

  if (slider.proposedNewPosY < 0) {
    slider.style.top = 0;
  } else if (slider.proposedNewPosY > getAtInt(track, 'height') - getAtInt(slider, 'height')) {
    slider.style.top = getAtInt(track, 'height') - getAtInt(slider, 'height') + 'px';
  } else {
    slider.style.top = slider.proposedNewPosY + 'px';
  }

  slider.percentage = parseInt(( getAtInt(slider, 'top') / (getAtInt(track, 'height') - getAtInt(slider, 'height'))) *100, 10); 
  isi_content.style.top = "-" + (((getAtInt(isi_content, 'height'))/varOffset) * slider.percentage) + "px";

};

}());


switch (my_arr_vars.split(".")[0]) {

  case "gas":
  document.querySelector('[data-wrapper="gas_legal_button"]').style.display = "inline";
  document.querySelector('[data-wrapper="gas_legal_text"]').style.display = "inline";
  break;

  case "hybrid":
  document.querySelector('[data-wrapper="hybrid_legal_button"]').style.display = "inline";
  document.querySelector('[data-wrapper="hybrid_legal_text"]').style.display = "inline";
  break;

}


//begin gas
if (my_arr_vars.split(".")[0] === "gas") {

switch (my_arr_vars.split(".")[1]) {

  case "A0":
document.querySelector('div[id="' + adxcel_id + '_wrapper_button_gas728_v1"]').classList.add("class_flex");
document.querySelector('a[id="' + adxcel_id + '_link_button_gas728_v1"]').setAttribute("href", button_redirect);
document.querySelector('div[id="' + adxcel_id + '_button_gas728_v1"]').innerHTML = "See offer";
  break;

}

}
//end gas

//begin hybrid
if (my_arr_vars.split(".")[0] === "hybrid") {

switch (my_arr_vars.split(".")[1]) {

  case "A0":
document.querySelector('div[id="' + adxcel_id + '_wrapper_button_hybrid728_v1"]').classList.add("class_flex");
document.querySelector('a[id="' + adxcel_id + '_link_button_hybrid728_v1"]').setAttribute("href", button_redirect);
document.querySelector('div[id="' + adxcel_id + '_button_hybrid728_v1"]').innerHTML = "See offer";
  break;

}

}
//end hybrid


document.addEventListener("mouseover", function (event) {

if (event.target.matches("#" + adxcel_id + "_wrapper_legal_button_gas728_v1")) {
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.add("class_flex");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.add("class_flex_show");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.add("class_show_zindex");
};

if (event.target.matches("#" + adxcel_id + "_wrapper_legal_button_hybrid728_v1")) {
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.add("class_flex");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.add("class_flex_show");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.add("class_show_zindex");
};

})

document.addEventListener("click", function (event) {

if (event.target.matches("#" + adxcel_id + "_wrapper_legal_close_gas728_v1")) {
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.remove("class_flex");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.remove("class_flex_show");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_gas728_v1").classList.remove("class_show_zindex");
};

if (event.target.matches("#" + adxcel_id + "_wrapper_legal_close_hybrid728_v1")) {
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.remove("class_flex");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.remove("class_flex_show");
	document.querySelector("#" + adxcel_id + "_wrapper_legal_hybrid728_v1").classList.remove("class_show_zindex");
};

})

///////////////////////////////////////////////////////////////////////////////////////////////////////////


	var url = frame_base + raw_mode + "frame" + (adxcl_var_main && adxcl_var_main != "def" ? ("." + adxcl_var_main) : "") + ".html";
	if (debug && debug != "0") {
		url = raw_mode + "frame" + (adxcl_var_main && adxcl_var_main != "def" ? ("." + adxcl_var_main) : "") + ".html";
	}

	//main part

	url += "?instance_id=" + adxcel_id;
	url += "&rev=" + adxcel_settings.rev;
	if (user.uid) url += "&uid=" + user.uid;

	if (user.idfa) url += "&idfa=" + user.idfa;
	if (user.device_id) url += "&device_id=" + user.device_id;
	if (user.listener_id) url += "&listener_id=" + user.listener_id;

	if (gender) url += "&gender=" + gender;
	if (user.age) url += "&age=" + user.age;
	if (user.zip) url += "&zip=" + user.zip;
	if (user.am_geo) url += "&am_geo=" + user.am_geo;
	if (user.lat) url += "&lat=" + user.lat;
	if (user.lon) url += "&lon=" + user.lon;

	if (device != "def") url += "&device=" + device;
	url += "&mode=" + mode;

	var env = UrlParam("env", "");
	if (env) {
		url += "&env=" + env;
	} else {
		if (window.PandoraApp) {
			url += "&env=" + "pndr";
		}
	}

	if (adxcel_settings.useOpenSafari) {
		url += "&stng_usopnsfr=1";
	}

	var ga_account = adxcel_settings.ga_account;
	if (adxcel_settings.ga_accountByVars[adxcl_var]) {
		ga_account = adxcel_settings.ga_accountByVars[adxcl_var];
	}
	url += "&ga_account=" + ga_account;
	url += "&ga_full_adname=" + ga_full_adname;

	if (window.adxcel_ga && window.adxcel_ga.ga_utmcc) {
		url += "&ga_utmcc=" + encodeURIComponent(window.adxcel_ga.ga_utmcc);
		//+1 cause system_adxcel calls here
		url += "&ga_index=" + (window.adxcel_ga.ga_index + 1);
	}

	var campaign = adxcel_settings.defaultCampaign;
	if (adxcel_settings.campaignsByVars[adxcl_var]) {
		campaign = adxcel_settings.campaignsByVars[adxcl_var];
	}
	if (campaign) {
		url += "&campaign=" + encodeURIComponent(campaign);
	}

	//TODO main part of adxcl_var
	var clickTag = UrlParam("clickTag", "");
	if (!clickTag) {
		clickTag = adxcel_settings.defaultClickTag;
		if (adxcel_settings.clickTagByVars) {
			try {
				//try by full
				if (adxcel_settings.clickTagByVars[adxcl_var]) {
					clickTag = adxcel_settings.clickTagByVars[adxcl_var];
				} else {
					//by parent
					var paren_adxcl_var = adxcl_var;
					if (adxcl_var) {
						var adxcl_var_items = adxcl_var.split(".");
						paren_adxcl_var = adxcl_var_items[0];
					}
					if (adxcel_settings.clickTagByVars[paren_adxcl_var]) {
						clickTag = adxcel_settings.clickTagByVars[paren_adxcl_var];
					}
				}
			} catch (e) {
				//
			}
		}

		if (adxcel_settings.clickTagByModes) {
			try {
				if (adxcel_settings.clickTagByModes[mode]) {
					clickTag = adxcel_settings.clickTagByModes[mode];
				}
			} catch (e) {
				//
			}
		}
	}

	if (clickTag) {
		clickTag = clickTag.replace(/%VARIATION_MAIN%/g, adxcl_var_main);
		clickTag = clickTag.replace(/%VARIATION%/g, adxcl_var);
		//if (window.platform !== "web") {//web fix
			if(clickTag.indexOf("%") != -1){
				try {
					clickTag = decodeURIComponent(clickTag);
				} catch (e) {
					//console.log(e);
				}
			}
			url += "&clickTag=" + encodeURIComponent(clickTag);
		//}
	}
	
	window.runtime_clickTag = window.replaceMacro(clickTag);

	var clickTracker = UrlParam("clickurl", "");
	if (!clickTracker) clickTracker = UrlParam("click", "");
	if (clickTracker) {
		try {
			clickTracker = decodeURIComponent(clickTracker);
		} catch (e) {
			//
		}
	}
	if (clickTracker) url += "&clickTracker=" + encodeURIComponent(clickTracker);

	//millenium
	var ct = UrlParam("ct", "");
	if (ct) {
		ct = decodeURIComponent(ct);
		url += "&ct=" + encodeURIComponent(ct);
	}

	var ctp = "";
	window.adxcel_ct_wrapper = "";
	if (adxcel_settings.useClickPrepend) {
		//mojiva
		//click tag prepending
		ctp = UrlParam("ctp", "");
		//console.log(ctp);
		if (ctp) {
			
			//looks like macros was not populated
			/*if(ctp.indexOf("CLICK_URL") != -1){
				ctp = ""
				window.adxcel_origin_ctp = ctp;
				try{
					window.adxcel_origin_ctp = decodeURIComponent(ctp);
				}catch(e){
					//
				}
			}
			*/
			
			try{
				//if (user.platform != "web") {
					ctp = decodeURIComponent(ctp);
				//}
				url += "&ctp=" + encodeURIComponent(ctp);
				window.adxcel_ct_wrapper = ctp + "%DESTINATION_URL%";
			}catch(e){
				console.log("ctp: " + ctp);
				console.log(e);
			}
		}
	}
	
	//trackers
	try{
		var trClicks = UrlParam("clickTracker", "");
		if(trClicks){
			trClicks = trClicks.split("|");
			for(var i=0; i<trClicks.length; i++){trClicks[i] = decodeURIComponent(trClicks[i]); }
			if(window.adxcel_settings.trackers.fclick){
				if(typeof window.adxcel_settings.trackers.fclick === "string"){
					trClicks.push(window.adxcel_settings.trackers.fclick);
					window.adxcel_settings.trackers.fclick = trClicks;
				}else{
					window.adxcel_settings.trackers.fclick = window.adxcel_settings.trackers.fclick.concat(trClicks);
				}
			}else{
				window.adxcel_settings.trackers.fclick = trClicks;
			}
		}
		var trImps = UrlParam("impTracker", "");
		if(trImps){
			trImps = trImps.split("|");
			for(var i=0; i<trImps.length; i++){trImps[i] = decodeURIComponent(trImps[i]); }
			if(window.adxcel_settings.trackers.imp){
				if(typeof window.adxcel_settings.trackers.imp === "string"){
					trImps.push(window.adxcel_settings.trackers.imp);
					window.adxcel_settings.trackers.imp = trImps;
				}else{
					window.adxcel_settings.trackers.imp = window.adxcel_settings.trackers.imp.concat(trImps);
				}
			}else{
				window.adxcel_settings.trackers.imp = trImps;
			}
		}
		
	}catch(e){
		console.log("Issue with restoring trackers");
		console.log(e);
	}

	//mojiva impression tracker
	var iet = UrlParam("iet", "");
	if (iet) {
		iet = decodeURIComponent(iet);
		url += "&iet=" + encodeURIComponent(iet);
	}

	//dfp|admob
	var nature = UrlParam("nature", "");
	if (nature) {
		url += "&nature=" + encodeURIComponent(nature);
	}
	window.adxcel_ga.nature = nature;

	//main banner clickTag
	var bannerClick = clickTag;
	if (bannerClick) {
		var a = document.getElementById(adxcel_id + "link");
		if (a) {
			if (ctp) {
				bannerClick = ctp + bannerClick;
			} else if (ct) {
				//	
			}
			a.setAttribute("href", bannerClick);
		}
	}

	if (adxcel_settings && mode == "0") {
		var banner_url = adxcel_settings.banner_url;
		var banner = document.getElementById(adxcel_id + "_img0");
		if (banner) {
			if (banner_url) {
				banner.setAttribute("src", banner_url);
				setTimeout(function () { banner.style.display = "inline" }, 1000);
			} else {
				//depends on content
				//banner.style.display = "none";
			}
		}
	}

	//A logic
	var adxcelHref = document.getElementById(adxcel_id + "href");
	var someHrefs = adxcelHref ? [adxcelHref] : [];
	var matches = document.body.querySelectorAll("a[data-hrefbox='1']");
	if(matches && matches.length >0 ){
		for(var i=0;i<matches.length;i++){
			someHrefs.push(matches[i]);
		}
	}
	
	var adxcelHrefBox = document.getElementById(adxcel_id + "hrefbox");
	var adxcelOverlay = document.getElementById(adxcel_id + "overlay");

	//moved to frame, cause need full variation name
	if (mode == "0") {		
		adxcelTrackImpressions(adxcl_var);		
	}

	if (adxcelHref) {
		//addParsams method
		var url = window.replaceMacro(clickTag);
		var url_origin = url;
		var url_origin_need = false;
		//clickprepend
		if (window.adxcel_ct_wrapper) {
			if (window.adxcel_ga.nature != "dfp"
				&& window.adxcel_ct_wrapper.indexOf("doubleclick.net") == -1) {
				url = encodeURIComponent(url);
			}
			url = window.adxcel_ct_wrapper.split("%DESTINATION_URL%").join(url);
		}
		
		window.runtime_clickTag = url;
		
		//1.0.8_2
		if(window.adxcel_settings.trackers_try_skip_fclick){
			//fclick wrapping
			var rec = window.adxcel_ga.trackers.find(function(item){
				return item.events=="fclick";
			});
			if(rec && rec.pixel){
				fclick_url = rec.pixel;
				window.adxcel_settings.trackers_fclick_skip = true;
				
				var fclick_app = window.adxcel_ga;
				var ga_values_params = "";
				ga_values_params += "|m=" ;
				ga_values_params += "|initiator=" + "href";
				ga_values_params = window.adxcel_addUserSegmentParams(ga_values_params, "", false);
				fclick_url = fclick_url.replace(/%GA_CODE%/g, fclick_app.trackingAccount);
				fclick_url = fclick_url.replace(/%CATEGORY%/g, fclick_app.adName);
				fclick_url = fclick_url.replace(/%ACTION%/g, "fclick");
				fclick_url = fclick_url.replace(/%LABEL%/g, encodeURIComponent(ga_values_params));
				//fclick_url = fclick_url.replace(/%URL_REQ%/g, encodeURIComponent("|url_req=" + encodeURIComponent(window.url_request)));
				fclick_url = fclick_url.replace(/%PROB%/g, "");

				var user = window.adxcel_ga.user;
				fclick_url = fclick_url.replace(/%ENC_U1_GA_CODE%/, enc_u1(((user && user.uid) ? user.uid : ""), fclick_app.trackingAccount));
				fclick_url = fclick_url.replace(/%ENC_U1_CATEGORY%/, enc_u1(((user && user.uid) ? user.uid : ""), fclick_app.adName));
				fclick_url = fclick_url.replace(/%ENC_U1_LABEL%/, enc_u1(((user && user.uid) ? user.uid : ""), (ga_values_params)));
				
				fclick_url += "&url="+encodeURIComponent(url);
				
				window.adxcel_ga.href_length = fclick_url.length;
				url_origin_need = true;
				
				url = fclick_url;
				
			}
		}
		
		adxcelHref.setAttribute("href", url);
		if(url_origin_need && url_origin){
			adxcelHref.setAttribute("data-href-origin", url_origin);
		}
		
		/*
		if(window.adxcel_settings.clickMode == "force_rev"){
			window.adxcel_settings.trackerClickTag = url;
			adxcelHref.setAttribute("href", window.adxcel_settings.forceClickTag);
		}else{
			adxcelHref.setAttribute("href", url);
		}
		*/
		
		someHrefs.forEach(function(href){
			if(href != adxcelHref){
				var url = href.getAttribute("href");
				if (window.adxcel_ct_wrapper) {
					if (window.adxcel_ga.nature != "dfp"
						&& window.adxcel_ct_wrapper.indexOf("doubleclick.net") == -1) {
						url = encodeURIComponent(url);
					}
					url = window.adxcel_ct_wrapper.split("%DESTINATION_URL%").join(url);
				}		
				href.setAttribute("href", url);
				/*
				if(window.adxcel_settings.clickMode == "force_rev"){
					window.adxcel_settings.trackerClickTag = url;
					href.setAttribute("href", window.adxcel_settings.forceClickTag);
				}else{
					href.setAttribute("href", url);
				}
				*/
			}
		});
		
		someHrefs.forEach(function(href){
			href.onclick = function (e) {
				try{
					var a = e.currentTarget;
					if (!a) a = e.target;
					
					setTimeout(function(){
						//data-href-origin
						var href_origin = a && a.getAttribute("data-href-origin") ? a.getAttribute("data-href-origin") : null;
						if(href_origin){
							a.setAttribute("href", href_origin);
						}
					}, 500);
					
					var initiator = a && a.getAttribute("data-initiator") ? a.getAttribute("data-initiator") : "bnr";
					var ga_values_params = "initiator=" + initiator;
						
					if (a) {
						var prms_url = a.getAttribute("href");
						if (prms_url) {
							if (prms_url && prms_url.length > 80) {
								prms_url = prms_url.substr(0, 15) + "..." + prms_url.substr(prms_url.length - 65);
							}
		
							ga_values_params += "|url=" + encodeURIComponent(prms_url);
						}
					}
					
					if(window.adxcel_origin_ctp){
						ga_values_params += "|origin_ctp=" + encodeURIComponent(window.adxcel_origin_ctp);
					}
					
					ga_values_params += "|mrblvw=" + window.__ad__isMeasurableview();
					ga_values_params += "|adshown=" + (window.__ad__shown ? 1: 0);
		
					ga_values_params = window.adxcel_addUserSegmentParams(ga_values_params, "", false);
					adxcel_ga_event("dest", ga_values_params);
					//trackers.dest
					if (window.adxcel_settings.trackers && window.adxcel_settings.trackers.dest) {
						if (typeof window.adxcel_settings.trackers.dest === "string") {
							adxcel_imageTracker(window.replaceMacro(window.adxcel_settings.trackers.dest), window.adxcel_ga.parent, null);
						} else {
							for (var i = 0; i < window.adxcel_settings.trackers.dest.length; i++) {
								trackURL = window.replaceMacro(window.adxcel_settings.trackers.dest[i]);
								adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
							}
						}
					}
					
					//fclick_external
					//window.adxcel_settings.system_trackers  [ {events: "fclick_external", pixel: ""} ]
					var fclick_external = window.adxcel_settings.system_trackers.find(function(rec){
						return rec.events == "fclick_external";
					});
					if(!fclick_external){
						fclick_external = window.adxcel_settings.system_trackers.find(function(rec){
							return rec.events == "fclick";
						});
					}
					if(fclick_external){
						fclick_external.pixel = fclick_external.pixel.replace("%ENC_U1_LABEL%","%LABEL_LITE%").replace(/%ACTION%/g, "fclick");
						var ga_values_params = ""
						if(initiator){
							ga_values_params += "|initiator=" + "(initiator)";
						}
						if(fclick_external.pixel.indexOf("%LABEL%")!=-1){
							ga_values_params = window.adxcel_addUserSegmentParams(ga_values_params, "", false);
							fclick_external.pixel = fclick_external.pixel.replace(/%LABEL%/g, ga_values_params);
						}else if(fclick_external.pixel.indexOf("%LABEL_LITE%")!=-1){
							ga_values_params = window.adxcel_addUserSegmentParams(ga_values_params, "", false, ["bswx","prflrsp","mdmth","usrimp","dv360","xandr","ttd","adobe","ibmdt"]);
							fclick_external.pixel = fclick_external.pixel.replace(/%LABEL_LITE%/g, ga_values_params);
						}
						fclick_external =  window.replaceMacro( fclick_external.pixel);
						var url = a.getAttribute("href");
						url = url.replace("[enc_fclick_external]", encodeURIComponent(fclick_external));
						a.setAttribute("href",  url);
					}
					
					if(window.adxcel_settings.clickMode){
						switch(window.adxcel_settings.clickMode){
							case "force_rev":
									if(window.adxcel_settings.trackerClickTag){
										//create iframe for 
										var parent = document.getElementById(adxcel_id + "container");
										
										if(window.adxcel_settings.trackerClickTag){
											var img = document.createElement("img");
											img.width = "1px";
											img.height = "1px";
											img.src = window.adxcel_settings.trackerClickTag;
											parent.appendChild(img);
										}
										
									}
								break;
							case "force":
									if(window.adxcel_settings.forceClickTag){
										//create iframe for 
										var url = a.getAttribute("href");
										var iframe = document.createElement("iframe");
										iframe.width = "1px";
										iframe.height = "1px";
										iframe.src = url;
										window.adxcel_ga.parent.appendChild(iframe);
										
										//open force link
										var url = window.replaceMacro(window.adxcel_settings.forceClickTag);
										window.open(url, "_blank");
										return false;
									}
								break;
							case "force_chain":
									if(window.adxcel_settings.forceClickTag){
										var ctp = UrlParam("ctp", "");
										if(ctp && ctp.length >0){
											var url = ctp;
											var iframe = document.createElement("iframe");
											iframe.width = "1px";
											iframe.height = "1px";
											iframe.src = url;
											window.adxcel_ga.parent.appendChild(ctp);
											iframe.onload = function() {
												if(adxcel_settings.clickTagCompiled){
												    var url = window.replaceMacro(adxcel_settings.clickTagCompiled);
												    var iframe = document.createElement("iframe");
													iframe.width = "1px";
													iframe.height = "1px";
													iframe.src = url;
													window.adxcel_ga.parent.appendChild(url);
												}
											};
										}
										
										//open force link
										window.open(window.adxcel_settings.forceClickTag, "_blank");
										return false;
									}
								break;
							case "force_threads":
									if(window.adxcel_settings.forceClickTag){
										var ctp = UrlParam("ctp", "");
										if(ctp && ctp.length >0){
											var url = ctp;
											var iframe = document.createElement("iframe");
											iframe.width = "1px";
											iframe.height = "1px";
											iframe.src = url;
											window.adxcel_ga.parent.appendChild(ctp);
										}
										
										if(adxcel_settings.clickTagCompiled){
										    var url = window.replaceMacro(adxcel_settings.clickTagCompiled);
										    var iframe = document.createElement("iframe");
											iframe.width = "1px";
											iframe.height = "1px";
											iframe.src = url;
											window.adxcel_ga.parent.appendChild(url);
										}
										
										//open force link
										window.open(window.adxcel_settings.forceClickTag, "_blank");
										return false;
									}
								break;
									
							case "native":
							default:
								
								break;
							
						}
					}
					
					//general link behavior
					var mraid = a && a.getAttribute("data-mraid") ? a.getAttribute("data-mraid") : "0";
					//alert([mraid == "1", window.mraid!=null]);
					if(mraid == "1" && window.mraid!=null){
						 var expandedUrl = a.getAttribute("href");
						 //alert(expandedUrl);
						 //e.preventDefault();
						 window.mraid.setExpandProperties({
				           useCustomClose: true
				         });
				         window.mraid.expand(expandedUrl); //Two-part mraid expand ad
				         return false;
					}
				
					
				}catch(e){
					setTimeout(function(){
							adxcel_ga_event("error", "reason=dest:"+e.toString().substr(0,40)+"...");
						}, 10);
				}
			};
		});

		
	}

	//adxcelHref url prepare moved fo "get clickTag from content"

	if (adxcelHrefBox) {

		if (mode != "0") {
			adxcelHrefBox.style.display = "none";
		} else {
			adxcelHrefBox.style.opacity = 1;
			adxcelHrefBox.style.display = "inline";
		}

		var instance_id = window.adxcel_id;

		if (mode == "0" && window.adxcel_onContentReady) {
			try {
				window.adxcel_onContentReady(instance_id);
			} catch (e) {
				//
			}
		}

		//click traking
		var hrefbox = adxcelOverlay ? adxcelOverlay : adxcelHrefBox;
		var someHrefBoxes = hrefbox ? [hrefbox] : [];
		var matches = document.body.querySelectorAll("div[data-hrefbox='1']");
		if(matches && matches.length >0 ){
			for(var i=0;i<matches.length;i++){
				someHrefBoxes.push(matches[i]);
			}
		}
		
		if (someHrefBoxes.length>0) {
			someHrefBoxes.forEach(function(hrefbox){
				hrefbox.onclick = function (e) {
					
					var initiator = (e.currentTarget && e.currentTarget.getAttribute("data-initiator") ) ? e.currentTarget.getAttribute("data-initiator"): "";
		
					window.adxcel_ga.clicks++;
					//if(window.adxcel_ga.clicks > 1) return;
			
					var xx = 0;
					var yy = 0;
					
					var dt = new Date();
					var tm = dt.getTime() - window.adxcel_ga.startAt.getTime();
					tm = Math.round(tm / 1000);
					var param = [xx, yy, tm];
			
					var ga_values_params = "";
					ga_values_params += "|mrblvw=" + window.__ad__isMeasurableview();
					ga_values_params += "|adshown=" + (window.__ad__shown?1:0);
					ga_values_params += "|m=" + (param.join(","));
					if(initiator){
						ga_values_params += "|initiator=" + initiator;
					}
					ga_values_params = window.adxcel_addUserSegmentParams(ga_values_params, "", false);
					if (window.adxcel_ga.clicks == 1) 
					//all clicks as fclick
					{
						if(window.adxcel_settings.trackers_fclick_skip){
							//
						}else{
							adxcel_ga_event("fclick", ga_values_params);
						}
						
						if (window.adxcel_settings.trackers && window.adxcel_settings.trackers.fclick) {
							if (typeof window.adxcel_settings.trackers.fclick === "string") {
								adxcel_imageTracker(window.replaceMacro(window.adxcel_settings.trackers.fclick), window.adxcel_ga.parent, null);
							}else{
								for(var i=0; i<window.adxcel_settings.trackers.fclick.length; i++){
									adxcel_imageTracker(window.replaceMacro(window.adxcel_settings.trackers.fclick[i]), window.adxcel_ga.parent, null);
								}
							}
						}
						
						if (window.adxcel_settings.scripttrackers && window.adxcel_settings.scripttrackers.fclick) {
							adxcel_scriptTracker(window.adxcel_settings.scripttrackers.fclick, window.adxcel_ga.parent, null);
						}
					} else {
						adxcel_ga_event("nclick", ga_values_params);
					}
				};
			});			
		}

	}
	
	
	//q1w2e3r4
	var ga_values_params = "";
	try{
		var user = window.adxcel_ga.user;

		var utmtr = adxcel_getTimeTermIndex(window.adxcel_ga.startAt);
		var uage = adxcel_getAgeTermIndex(user.age);
		var rev = window.adxcel_ga.rev;
		var uid = user.uid;
		var udate_offset = 1356984000000; //2013-01-01
		var udate = Math.ceil((window.adxcel_ga.startAt.getTime() - udate_offset) / 1000 / 60 / 60 / 24);
		var udow = user.udow;
		var uwom = user.uwom;
		var dow = user.dow;
		var wom = user.wom;
		var udma = user.am_geo;
		var view = "";
		var targeting = user.targeting;

		var idfa = user.idfa;
		var pid = user.pid;
		var pcat = user.pcat;
		var device_id = user.device_id;
		var listener_id = user.listener_id;
		
		var extra_params = "";

		if (uid) {
			extra_params += "|uid=" + uid;
		}
		if (rev) {
			extra_params += "|rev=" + rev;
		}
		if (utmtr || utmtr == 0) {
			extra_params += "|utmtr=" + utmtr;
		}
		if (uage) {
			extra_params += "|uage=" + uage;
		}
		if (ugndr) {
			extra_params += "|ugndr=" + ugndr;
		}

		if (udma) {
			extra_params += "|udma=" + udma;
		}
		if (udate) {
			extra_params += "|udate=" + udate;
		}
		if (idfa) {
			extra_params += "|idfa=" + idfa;
		}
		if (device_id) {
			extra_params += "|device_id=" + device_id;
		}
		if (listener_id) {
			extra_params += "|listener_id =" + listener_id ;
		}
		
		ga_values_params = extra_params;
	}catch(e){
		ga_values_params = "error=1";
		setTimeout(function(){
			adxcel_ga_event("error", "reason=fclick:"+e.toString().substr(0,100)+"...");
		}, 500);
	}
	window.runtime_fclick = adxcel_ga_event("fclick", ga_values_params, null, true);
	
};


//after __ad__initViewabilitiy::omid
//0,1,2,4 - intersection,omid,mraid
window.__ad__isMeasurableview = function(){
	var result = 0;
	
	if(window.mraid){
		result = result | 4;
	}
	if(window.omid_supported){
		result = result | 2;
	}
	if( "IntersectionObserver" in window){
		if(window.__ad__viewability__intobs_error){
			//empty
		}else{
			result = result | 1;
		}
	}
	
	return result;
}

window.__ad__initViewabilitiy = function(imp1_params){
	var params = []
	var mraid_info = ""
	var version = "";
	
	var isMeasurableview = window.__ad__isMeasurableview();
	
	//mraid
	try{
		if(window.mraid){
			version = "";
			if(window.MRAID_ENV){
				version = window.MRAID_ENV["version"];
			}else{
				var state = mraid.getState();
				if(state == "loading"){
					version = "like 2.x";	
				}else{
					version = mraid.getVersion();
				}
			}
		}else{
			version = "no";
		}
	}catch(e){
		version = "error:" + e.toString().substr(0,40)+"...";
	}
	params.push("env_mraid_v=" + version);
	
	//omid
	var omid_info = "";
	window.omid_shown = false;
	try{
		var omidGlobal = __getOmidGlobal();
		var verificationClient = null;		  
		try{
			verificationClient = new omidGlobal.OmidVerificationClient['1.2.1']();
		}catch(e){
		  try{
				verificationClient = new omidGlobal.OmidVerificationClient();
		  }catch(e){
			  try{
					verificationClient = new omidGlobal.OmidVerificationClient['1.2.6-dev']();
			  }catch(e){
					omid_info = "error(2):" + e.toString().substr(0,40)+"...";
			  }
		  }
		}		
		if(verificationClient != null){
			var omid_supported = verificationClient.isSupported();
			omid_info = "supported_"+omid_supported;
			window.omid_supported = omid_supported;
			
			if(omid_supported){
				var sessionObserver = function (data) {
					//
				};
				var eventHandler = function (data) {
					//
				};
							
				try{
					verificationClient.registerSessionObserver(sessionObserver, "adxcel"); 
					verificationClient.addEventListener('impression', function (data) {
						if(!window.omid_shown){
							window.omid_shown = true;
							var tm = (new Date().getTime() - window.adxcel_time0);
							var params = "|tm=" + tm +"|vblrsn=omid";
							
							if(!window.__ad__shown_omid){
								window.__ad__shown_omid = true;
								adxcel_ga_event("show_omid", params + (imp1_params.indexOf("|")==0?"":"|") + imp1_params);
							}
						}
					});
					window.adxcel_omid_sessionObserver = sessionObserver;
				}catch(e){
					omid_info += "_error_" + e.toString().substr(0,160)+"...";
				}
			}else{
				if(!window.__ad__shown_no_omid){
					window.__ad__shown_no_omid = true;
					var tm = (new Date().getTime() - window.adxcel_time0);
					adxcel_ga_event("omid_not_supp", "|tm=" + tm +"|vblrsn=no_omid" + (imp1_params.indexOf("|")==0?"":"|") + imp1_params);
				}
			}
		}else{
			omid_info = "no_client";
			if(!window.__ad__shown_no_omid){
				window.__ad__shown_no_omid = true;
				var tm = (new Date().getTime() - window.adxcel_time0);
				adxcel_ga_event("omid_not_supp", "|tm=" + tm +"|vblrsn=no_omid_client" + (imp1_params.indexOf("|")==0?"":"|") + imp1_params);
			}
		}
	}catch(e){
		omid_info = "error(1):" + e.toString().substr(0,40)+"...";			  
	}
	params.push("env_omid=" + omid_info);
	
	
	var intobs_info = "";
	var intobs_error = false;
	try{
		//IntersectionObserver.prototype.THROTTLE_TIMEOUT * 3 || 100
		var options = {
		  threshold: 0.5
		}

		var observer = new IntersectionObserver(function(entries){
			
			entries.map((entry) => {
				if (entry.isIntersecting) {
				    observer.unobserve(entry.target);
					var intersectionRatio = entry.intersectionRatio ? entry.intersectionRatio.toFixed(2).toString() : "-1" ;
					var tm = (new Date().getTime() - window.adxcel_time0);
					var dev_params = "|tm=" + tm +"|vblrsn=intobs|int_ratio="+intersectionRatio;
					if(!window.__ad__shown_native){
						window.__ad__shown_native = true;
						adxcel_ga_event("show_native", dev_params + (imp1_params.indexOf("|")==0?"":"|") + imp1_params);
					}
				}
			  });
			  //
			
		}, options);
		var target_alias = '#' + "top"
		var target = document.querySelector(target_alias);
		if(!target){
			target_alias = '#' + adxcel_id + "overlay"
			target = document.querySelector(target_alias);
			if(!target){
				setTimeout(function(){
					try{
						target_alias = '#' + adxcel_id + "overlay"
						target = document.querySelector(target_alias);
						observer.observe(target);
					}catch(e){
						setTimeout(function(){
							var uid = window.adxcel_ga.user.uid;
							adxcel_ga_event("error", "|reason=IntersectionObserver_2:"+e.toString().substr(0,160)+"...|uid="+uid+"|observer_trget="+target_alias+":"+(target));
						}, 500);
					}
				},500);
			}
		}
		if(target){
			try{
				observer.observe(target);
			}catch(e){
				intobs_error = true;
				setTimeout(function(){
					var uid = window.adxcel_ga.user.uid;
					adxcel_ga_event("error", "|reason=IntersectionObserver_1:"+e.toString().substr(0,160)+"...|uid="+uid+"|observer_trget="+target_alias+":"+(target));
				}, 500);
			}
		}
		
		intobs_info = "exists";
	}catch(e){
		intobs_error = true;
		intobs_info = "error:" + e.toString().substr(0,80)+"...";
	}
	params.push("env_intobs=" + intobs_info);
	
	window.__ad__viewabilityInfo = "|"+params;	
	
	if(intobs_error){
		window.__ad__viewability__intobs_error = intobs_error;
	}
	isMeasurableview = window.__ad__isMeasurableview();
	
	
	return isMeasurableview;
}

window.adxcelTrackImpressions = function(adxcl_var){
	
	/*if(window.mraid){
		//track only in case of ad shown
		if(window.mraid.isViewable()){
			adxcel_asynReqImpInc("imp");
		}else{
			window.mraid.addEventListener("viewableChange", function(e){
				if(window.mraid.isViewable()){
					adxcelTrackImpressions(adxcl_var);
				}
			});
			return;
		}
	}*/
		
  	//
  	
  	
  	// for VT pixel we need to use excludeUID == false i.e. adxcel_addUserSegmentParams("", "")
		var imp1_params = (window.__ad__viewabilityInfo ? window.__ad__viewabilityInfo : "");
		imp1_params = window.adxcel_addUserSegmentParams(imp1_params, "", false);
		var mrblvw = 0;
		try{
			mrblvw = window.__ad__initViewabilitiy(imp1_params);
		}catch(e){
			setTimeout(function(){
				var uid = window.adxcel_ga.user.uid;
				adxcel_ga_event("error", "|uid="+uid+"|reason=initViewabilitiy:"+e.toString().substr(0,160)+"...");
			}, 100);
			mrblvw = -1;
		}
		if(mrblvw<1){
			adxcel_ga_event("show_unmsrble", imp1_params);
		}
		imp1_params = "|tm=" + (new Date().getTime() - window.adxcel_time0) + "|mrblvw=" + mrblvw + (imp1_params.indexOf("|")==0?"":"|")  + imp1_params;
		adxcel_ga_event("imp1", imp1_params);
		
		//trackevent

		var trackURL = "", scriptTrackURL = "";
		var varName = adxcl_var.indexOf(".") == -1 ? adxcl_var : adxcl_var.split(".")[0];
		var fullVarName = adxcl_var;
		if (adxcel_settings.trackURLByVars && adxcel_settings.trackURLByVars[fullVarName]) {
			if (typeof adxcel_settings.trackURLByVars[fullVarName] === "string") {
				trackURL = window.replaceMacro(adxcel_settings.trackURLByVars[fullVarName]);
				adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
			} else {
				for (var i = 0; i < adxcel_settings.trackURLByVars[fullVarName].length; i++) {
					trackURL = window.replaceMacro(adxcel_settings.trackURLByVars[fullVarName][i]);
					adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
				}
			}
		}
		if (adxcel_settings.trackURLByVars && adxcel_settings.trackURLByVars[varName]) {
			if (typeof adxcel_settings.trackURLByVars[varName] === "string") {
				trackURL = window.replaceMacro(adxcel_settings.trackURLByVars[varName]);
				adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
			} else {
				for (var i = 0; i < adxcel_settings.trackURLByVars[varName].length; i++) {
					trackURL = window.replaceMacro(adxcel_settings.trackURLByVars[varName][i]);
					adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
				}
			}
		}

		//scriptTrackURLByVars
		if (adxcel_settings.scriptTrackURLByVars && adxcel_settings.scriptTrackURLByVars[fullVarName]) {
			if (typeof adxcel_settings.scriptTrackURLByVars[fullVarName] === "string") {
				scriptTrackURL = window.replaceMacro(adxcel_settings.scriptTrackURLByVars[fullVarName]);
				adxcel_scriptTracker(scriptTrackURL, window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < adxcel_settings.scriptTrackURLByVars[fullVarName].length; i++) {
					scriptTrackURL = window.replaceMacro(adxcel_settings.scriptTrackURLByVars[fullVarName][i]);
					adxcel_scriptTracker(scriptTrackURL, window.adxcel_ga.parent, null);
				}
			}
		}
		if (adxcel_settings.scriptTrackURLByVars && adxcel_settings.scriptTrackURLByVars[varName]) {
			if (typeof adxcel_settings.scriptTrackURLByVars[varName] === "string") {
				scriptTrackURL = window.replaceMacro(adxcel_settings.scriptTrackURLByVars[varName]);
				adxcel_scriptTracker(scriptTrackURL, window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < adxcel_settings.scriptTrackURLByVars[varName].length; i++) {
					scriptTrackURL = window.replaceMacro(adxcel_settings.scriptTrackURLByVars[varName][i]);
					adxcel_scriptTracker(scriptTrackURL, window.adxcel_ga.parent, null);
				}
			}
		}

		//iframeTrackURLByVars
		if (adxcel_settings.iframeTrackURLByVars && adxcel_settings.iframeTrackURLByVars[fullVarName]) {
			if (typeof adxcel_settings.iframeTrackURLByVars[fullVarName] === "string") {
				scriptTrackURL = window.replaceMacro(adxcel_settings.iframeTrackURLByVars[fullVarName]);
				adxcel_iframeTracker(scriptTrackURL, window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < adxcel_settings.iframeTrackURLByVars[fullVarName].length; i++) {
					scriptTrackURL = window.replaceMacro(adxcel_settings.iframeTrackURLByVars[fullVarName][i]);
					adxcel_iframeTracker(scriptTrackURL, window.adxcel_ga.parent, null);
				}
			}
		}
		if (adxcel_settings.iframeTrackURLByVars && adxcel_settings.iframeTrackURLByVars[varName]) {
			if (typeof adxcel_settings.iframeTrackURLByVars[varName] === "string") {
				scriptTrackURL = window.replaceMacro(adxcel_settings.iframeTrackURLByVars[varName]);
				adxcel_iframeTracker(scriptTrackURL, window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < adxcel_settings.iframeTrackURLByVars[varName].length; i++) {
					scriptTrackURL = window.replaceMacro(adxcel_settings.iframeTrackURLByVars[varName][i]);
					adxcel_iframeTracker(scriptTrackURL, window.adxcel_ga.parent, null);
				}
			}
		}

		//trackers.imp
		if (window.adxcel_settings.trackers && window.adxcel_settings.trackers.imp) {
			if (typeof window.adxcel_settings.trackers.imp === "string") {
				adxcel_imageTracker(window.replaceMacro(window.adxcel_settings.trackers.imp), window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < window.adxcel_settings.trackers.imp.length; i++) {
					trackURL = window.replaceMacro(window.adxcel_settings.trackers.imp[i]);
					adxcel_imageTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
				}
			}
		}
		//scripttrackers.imp
		if (window.adxcel_settings.scripttrackers && window.adxcel_settings.scripttrackers.imp) {
			if (typeof window.adxcel_settings.scripttrackers.imp === "string") {
				adxcel_scriptTracker(window.replaceMacro(window.adxcel_settings.scripttrackers.imp), window.adxcel_ga.parent, null);
			} else {
				for (var i = 0; i < window.adxcel_settings.scripttrackers.imp.length; i++) {
					trackURL = window.replaceMacro(window.adxcel_settings.scripttrackers.imp[i]);
					adxcel_scriptTracker(trackURL, document.getElementById(window.adxcel_id + 'hrefbox'), null);
				}
			}
		}
  	
};

window.adxcel_passConditions = function (src, conditions) {
	var pass = false;
	if (conditions) {
		for (var i = 0; i < conditions.length; i++) {
			var re = conditions[i];
			var lp = false;
			try {
				lp = re.test(src);
				pass = (re && (lp));
			} catch (e) {
				pass = false;
			}
			if (pass) break;
		}
	}
	return pass;
};

window.adxcel_getTimeTermIndex = function (dt) {
	if (!dt) dt = new Date();
	var hh = dt.getHours();
	var hh2;
	var m = hh / 3;
	var ind = Math.floor(hh / 3);
	return ind;
};

window.adxcel_getGenderTermIndex = function (gender) {
	var ugndr = 0;
	if (gender == "m") ugndr = 1;
	if (gender == "f") ugndr = 2;
	return ugndr;
};

window.adxcel_getAgeTermIndex = function (age) {
	var str = 0;
	if (age > 0 && age < 13) str = 1;
	else if (age >= 13 && age <= 17) str = 2;
	else if (age >= 18 && age <= 24) str = 3;
	else if (age >= 25 && age <= 30) str = 40;
	else if (age >= 31 && age <= 34) str = 41;
	else if (age >= 35 && age <= 44) str = 5;
	else if (age >= 45 && age <= 54) str = 6;
	else if (age >= 55 && age <= 64) str = 7;
	else if (age >= 65) str = 8;
	return str;
};

window.adxcel_getAgeIndexTerm = function (ind) {
	var str = "unknown";
	if (ind == 1) str = "0-12";
	else if (ind == 2) str = "13-17";
	else if (ind == 3) str = "18-24";
	else if (ind == 40) str = "25-30";
	else if (ind == 41) str = "31-34";
	else if (ind == 5) str = "35-44";
	else if (ind == 6) str = "45-54";
	else if (ind == 7) str = "55-64";
	else if (ind == 8) str = "65-199";
	return str;
};

window.adxcel_getAgeIndexTermMZ = function (age) {
	var str = "00-00";
	if (age > 0 && age < 13) str = "";
	else if (age >= 14 && age <= 17) str = "14-17";
	else if (age >= 18 && age <= 24) str = "18-24";
	else if (age >= 25 && age <= 34) str = "25-34";
	else if (age >= 35 && age <= 44) str = "35-44";
	else if (age >= 45 && age <= 50) str = "45-50";
	else if (age >= 51) str = "51-99";
	return str;
};

window.adxcel_substring = function (pattern) {
	var value = "";
	var user = window.adxcel_ga.user;
	switch (pattern) {
		case "%VARIATION_SHORT_LABEL%":
			value = window.adxcel_ga.adxcl_var;
			break;
		case "%VARIATION_COMPACT_LABEL%":
			value = window.adxcel_ga.adxcl_var ? window.adxcel_ga.adxcl_var.replace(/\./g, "") : "";
			break;
		case "%AGE_LABEL%":
			value = adxcel_getAgeIndexTerm(adxcel_getAgeTermIndex(user.age));
			break;
		case "%AGE_LABEL_MZ%":
			value = adxcel_getAgeIndexTermMZ(user.age);
			break;
		case "%GENDER_LABEL%":
			var ugndr = 0;
			if (user.gender == "m") ugndr = 1;
			if (user.gender == "f") ugndr = 2;
			if (ugndr == 0) {
				value = "unknown";
			} else if (ugndr == 1) {
				value = "Male";
			} else if (ugndr == 2) {
				value = "Female";
			}
			break;
		case "%GENDER_COMPACT_LABEL%":
			var ugndr = 0;
			if (user.gender == "m") ugndr = 1;
			if (user.gender == "f") ugndr = 2;
			if (ugndr == 0) {
				value = "U";
			} else if (ugndr == 1) {
				value = "M";
			} else if (ugndr == 2) {
				value = "F";
			}
			break;
	}
	return value;
};

// demographic support for impression ENC_U1_CATEGORY_WITH_MSG

window.adxcel_addUserShortSegmentParams = function (params, mode, excludeUID) {
	var user = window.adxcel_ga.user;

	var utmtr = adxcel_getTimeTermIndex(window.adxcel_ga.startAt);
	var uage = adxcel_getAgeTermIndex(user.age);
	var rev = window.adxcel_ga.rev;
	var uid = user.uid;
	var udate_offset = 1356984000000; //2013-01-01
	var udate = Math.floor((window.adxcel_ga.startAt.getTime() - udate_offset) / 1000 / 60 / 60 / 24);
	var udma = user.am_geo;
	var view = "";

	//pandora age format
	var ugndr = 0;
	if (user.gender == "m") ugndr = 1;
	if (user.gender == "f") ugndr = 2;

	var uzp = 0;
	if (user.zip) {
		var loc_zip = user.zip ? user.zip : "";
		/*if(loc_zip && loc_zip.length > 3){
			loc_zip = loc_zip.substr(0, 3);
		}*/
		loc_zip = parseInt(loc_zip);
		if (loc_zip) {
			uzp = loc_zip;
		}
	}

	var extra_params = "";

	if (utmtr || utmtr == 0) {
		extra_params += (!extra_params ? "" : "|") + "utmtr=" + utmtr;
	}
	if (uage) {
		extra_params += (!extra_params ? "" : "|") + "uage=" + uage;
	}
	if (ugndr) {
		extra_params += (!extra_params ? "" : "|") + "ugndr=" + ugndr;
	}
	if (uzp) {
		extra_params += (!extra_params ? "" : "|") + "uzp=" + uzp;
	}
	if (udma) {
		extra_params += (!extra_params ? "" : "|") + "udma=" + udma;
	}
	if (udate) {
		extra_params += (!extra_params ? "" : "|") + "udate=" + udate;
	}

	params += extra_params;

	return params;
};
// END ENC_U1_CATEGORY_WITH_MSG


window.adxcel_addUserSegmentParams = function (params, mode, excludeUID, excludeProps) {
	var user = window.adxcel_ga.user;

	var utmtr = adxcel_getTimeTermIndex(window.adxcel_ga.startAt);
	var uage = adxcel_getAgeTermIndex(user.age);
	var rev = window.adxcel_ga.rev;
	var uid = user.uid;
	var udate_offset = 1356984000000; //2013-01-01
	var udate = Math.ceil((window.adxcel_ga.startAt.getTime() - udate_offset) / 1000 / 60 / 60 / 24);
	var udow = user.udow;
	var uwom = user.uwom;
	var dow = user.dow;
	var wom = user.wom;
	var udma = user.am_geo;
	var view = "";
	var targeting = user.targeting;

	var idfa = user.idfa;
	var pid = user.pid;
	var pcat = user.pcat;
	var device_id = user.device_id;
	var listener_id = user.listener_id;

	//padnora postback - 22-01-15
	//{aid_value}!{cid_value}!{advertiser_name}
	//dfp_ad_id=[aid_value]&dfp_creative_id=[cid_value]&adv_name=[advertiser_name]

	var dfp_ad_id = window.adxcel_settings.dfp_ad_id ? window.adxcel_settings.dfp_ad_id : "";
	var dfp_creative_id = window.adxcel_settings.dfp_creative_id ? window.adxcel_settings.dfp_creative_id : "";
	var pnd_adv_name = window.adxcel_settings.pnd_adv_name ? window.adxcel_settings.pnd_adv_name : "";
	var dfp_order_id = window.adxcel_settings.dfp_order_id ? window.adxcel_settings.dfp_order_id : "";

	var cost_model_id = window.adxcel_settings.cost_model_id ? window.adxcel_settings.cost_model_id : "";
	var cost_id = window.adxcel_settings.cost_id ? window.adxcel_settings.cost_id : "";
	var input_id = window.adxcel_settings.input_id ? window.adxcel_settings.input_id : "";
	var pnd_ctrk = dfp_ad_id + "!" + dfp_creative_id + "!" + pnd_adv_name + "!" + dfp_order_id + "!_";
	
	var bswx_ctrk = window.adxcel_settings.beeswax_tag_id ? (window.adxcel_settings.beeswax_tag_id+"!"+window.adxcel_settings.auction_id) : null;
	if(window.adxcel_settings.beeswax_tag_id){
		var tag_id = [];
		var tag_id_values = window.adxcel_settings.beeswax_tag_id;
		if(tag_id_values.length && tag_id_values.length>0 && tag_id_values[0]){
			for(var i=0;i<tag_id_values.length;i++){
				if(i%2 == 0){
					//action name
				}else if( !isNaN(parseInt(tag_id_values[i])) ){
					tag_id.push(tag_id_values[i]>0?tag_id_values[i]:"");
				}
			}
		}
		if(tag_id.length>0){
			bswx_ctrk = tag_id.join(",") + "!" + window.adxcel_settings.auction_id;
		}
	}
	if(bswx_ctrk){
		bswx_ctrk += "!" + (window.adxcel_settings.beeswax_user_id_type ? window.adxcel_settings.beeswax_user_id_type : "");
	}
	if(bswx_ctrk){
		var seg_id = [];
		var seg_values = window.adxcel_settings.beeswax_segment_keys;
		if(seg_values.length && seg_values.length>0 && seg_values[0]){
			for(var i=0;i<seg_values.length;i++){
				if(i%2 == 0){
					//action name
				}else{
					seg_id.push(seg_values[i]);
				}
			}
		}
		bswx_ctrk += "!"+ seg_id.join(",");
	}
	
	var beeswax_account_id = window.adxcel_settings.beeswax_account_id;
	if(bswx_ctrk){
		bswx_ctrk += "!"+ (beeswax_account_id?beeswax_account_id : "");
	}
	
	//beeswax
	var bsw_auction_id = window.adxcel_settings.auction_id;
	var bsw_line = window.adxcel_settings.bsw_line;
	var bsw_creative_id = window.adxcel_settings.bsw_creative_id;
	var beeswax_account_id = window.adxcel_settings.beeswax_account_id;
	
	//mm_
	var mediamath_uuid = window.adxcel_settings["mediamath_uuid"];
	var mediamath_BID_ATTR_bid_id = window.adxcel_settings["mediamath_BID_ATTR_bid_id"];
	var mediamath_data_str = window.mediamath_data_str;
	var mediamath_data_hash = window.mediamath_data_hash;

	//pandora age format
	var ugndr = 0;
	if (user.gender == "m") ugndr = 1;
	if (user.gender == "f") ugndr = 2;

	var uzp = 0;
	if (user.zip) {
		var loc_zip = user.zip ? user.zip : "";
		/*if(loc_zip && loc_zip.length > 3){
			loc_zip = loc_zip.substr(0, 3);
		}*/
		loc_zip = parseInt(loc_zip);
		if (loc_zip) {
			uzp = loc_zip;
		}
	}

	var extra_params = "";
	if (mode == "2") {
		//minimized
		if (uid && !excludeUID) {
			extra_params += "_uid" + uid;
		}
		if (view) {
			extra_params += "_vw" + view;
		}
		if (rev) {
			extra_params += "_rev" + rev;
		}
		if (utmtr || utmtr == 0) {
			extra_params += "_utt" + utmtr;
		}
		if (uage) {
			extra_params += "_uag" + uage;
		}
		if (ugndr) {
			extra_params += "_ugr" + ugndr;
		}
		if (uzp) {
			extra_params += "_uzp" + uzp;
		}
		if (udate) {
			extra_params += "_udt" + udate;
		}
		if (udma) {
			extra_params += "_udm" + udma;
		}
		if (pnd_ctrk && !excludeUID) {
			extra_params += "_ibmctrk" + pnd_ctrk;
		}
	} else if (mode == "adx") {
		//utmtr_6!uage_5!ugndr_1!uzp_223!udate_94
		//see adx tags
		//adx
		if (uid && !excludeUID) {
			extra_params += ((extra_params) ? "!" : "") + "uid_" + uid;
		}
		if (pnd_ctrk && !excludeUID) {
			extra_params += ((extra_params) ? "!" : "") + "ibmctrk_" + pnd_ctrk;
		}

		if (view) {
			extra_params += ((extra_params) ? "!" : "") + "view_" + view;
		}
		if (rev) {
			extra_params += ((extra_params) ? "!" : "") + "rev_" + rev;
		}
		if (utmtr) {
			extra_params += ((extra_params) ? "!" : "") + "utmtr_" + utmtr;
		}
		if (uage) {
			extra_params += ((extra_params) ? "!" : "") + "uage_" + uage;
		}
		if (ugndr) {
			extra_params += ((extra_params) ? "!" : "") + "ugndr_" + ugndr;
		}
		if (uzp) {
			extra_params += ((extra_params) ? "!" : "") + "uzp_" + uzp;
		}
		if (udate) {
			extra_params += ((extra_params) ? "!" : "") + "udate_" + udate;
		}
		if (udma) {
			extra_params += ((extra_params) ? "!" : "") + "udma_" + udma;
		}
		if (idfa) {
			extra_params += ((extra_params) ? "!" : "") + "idfa_" + idfa;
		}
		if (pid) {
			extra_params += ((extra_params) ? "!" : "") + "pid_" + pid;
		}
		if (pcat) {
			extra_params += ((extra_params) ? "!" : "") + "pcat_" + pcat;
		}
		if (device_id) {
			extra_params += ((extra_params) ? "!" : "") + "did_" + device_id;
		}
		if (listener_id) {
			extra_params += ((extra_params) ? "!" : "") + "listnerid_" + listener_id;
		}
	} else {
		if (uid && !excludeUID) {
			extra_params += "|uid=" + uid;
		}
		if (rev) {
			extra_params += "|rev=" + rev;
		}
		if (pnd_ctrk && !excludeUID) {
			extra_params += "|__ctrk=" + pnd_ctrk;
		}
		if (utmtr || utmtr == 0) {
			extra_params += "|utmtr=" + utmtr;
		}
		if (uage) {
			extra_params += "|uage=" + uage;
		}
		if (ugndr) {
			extra_params += "|ugndr=" + ugndr;
		}
		if (uzp) {
			extra_params += "|uzp=" + uzp;
		}
		if (udma) {
			extra_params += "|udma=" + udma;
		}
		if (udate) {
			extra_params += "|udate=" + udate;
		}
		if (idfa && !excludeUID) {
			extra_params += "|idfa=" + idfa;
		}
		if (device_id && !excludeUID) {
			extra_params += "|device_id=" + device_id;
		}
		if (listener_id  && !excludeUID) {
			extra_params += "|listener_id =" + listener_id ;
		}
		if (pid) {
			extra_params += "|pid=" + pid;
		}
		if (pcat) {
			extra_params += "|pcat=" + pcat;
		}
		if (targeting) {
			extra_params += "|trg=" + targeting;
		}
		
		
		if(window.adxcel_settings.clickMode){
			extra_params += "|clkmd=" + (window.adxcel_settings.clickMode);
		}	
		
		if(window.dco_ai_id){
			extra_params += "|dcoaid=" + (window.dco_ai_id);
		}	
		if(window.dco_mode){
			extra_params += "|dcomode=" + (window.dco_mode);
		}
		
		if (window.dco_ai_model_scores) {
			extra_params += "|dcomscrs=" + (dco_ai_model_scores.length ? dco_ai_model_scores.join(",") : "");
		}
		if(window.dco_ai_model_scores_slot_raw){
			extra_params += "|dcomscslt=" + dco_ai_model_scores_slot_raw;
		}
		if(window.adxcel_settings.dco_strategy){
			extra_params += "|dcostrg=" + window.adxcel_settings.dco_strategy;
		}
		
		if(window.dco_ai_clusters_id){
			extra_params += "|dcocid=" + window.dco_ai_clusters_id;
		}
		if(window.dco_ai_clusters_dist){
			extra_params += "|dcocdst=" + window.dco_ai_clusters_dist;
		}
		if(window.clusters_ai_id){
			extra_params += "|clstraid=" + window.clusters_ai_id;
		}
				
		if(!isNaN(udow)){
			extra_params += "|udow=" + (udow);
		}
		if(!isNaN(uwom)){
			extra_params += "|uwom=" + (uwom);
		}
		
		if(!isNaN(dow)){
			extra_params += "|dow=" + (dow);
		}
		if(!isNaN(wom)){
			extra_params += "|wom=" + (wom);
		}
		
		var urImp = createUserImp();
		
		if(urImp && (!excludeProps || excludeProps.indexOf("usrimp")==-1)){
			extra_params += "|usrimp=" + (JSON.stringify(urImp));
		}
		
		var ursData = {};
		try{
			if(adxcel_settings.profile["wfxzp_data"]){
				ursData["wfxzp"] = adxcel_settings.profile["wfxzp_data"];
			}
			if(adxcel_settings.profile["prizm_group"]){
				ursData["prizm_group"] = adxcel_settings.profile["prizm_group"];
			}
			if(adxcel_settings.profile["prizm_zip5"]){
				ursData["prizm_zip5"] = adxcel_settings.profile["prizm_zip5"];
				ursData["prizm_zip5"] = [];
				for(var prop in adxcel_settings.profile["prizm_zip5"]){
					var iprop = parseInt(prop);
					if(iprop<68){
						ursData["prizm_zip5"][iprop] = adxcel_settings.profile["prizm_zip5"][prop];
					}
				}
				ursData["prizm_zip5_str"] = ursData["prizm_zip5"].join(",");
				delete ursData["prizm_zip5"];
			}
		}catch(e){
			//
		}
		if(ursData && (!excludeProps || excludeProps.indexOf("usrimp")==-1)){
			extra_params += "|usrdt=" + (JSON.stringify(ursData));
			//console.log("ursData: ");
			//console.log(ursData)
		}
		
		if(window.adxcel_settings.profile_response && (!excludeProps || excludeProps.indexOf("prflrsp")==-1)){
			extra_params += "|prflrsp=" + (window.adxcel_settings.profile_response);
		}
		
		if(window.adxcel_settings.noprofile_reason){
			extra_params += "|noprofile=" + window.adxcel_settings.noprofile_reason;
		}
		
		if(window.adxcel_ga.adxcl_var){
			//extra_params += "|vrsind=" + adxcel_encodeVariation(window.adxcel_ga.adxcl_var, window.adxcel_settings.content.variations);
			extra_params += "|vrsind=0";
		}
		
		var localDate = new Date();
		extra_params += "|localtime=" + (Math.round(localDate.getTime()/1000));
		
		if(window.adxcel_settings.ga_adname){
			extra_params += "|adname=" + (window.adxcel_settings.ga_adname);
		}
		
		if(window.adxcel_settings.user_slot){
			extra_params += "|usrslt=" + (window.adxcel_settings.user_slot);
		}
		
		if(window.adxcel_macros_data_str){
			extra_params += "|mcrs=" + (window.adxcel_macros_hash?window.adxcel_macros_hash:"nohash") + ":" + (window.adxcel_macros_data_str);
		}
		
		if(window.adxcel_review){
			extra_params += "|review=" + adxcel_review;	
		}
		if(adxcel_selected_line){
			extra_params += "|mln=" + adxcel_selected_line.alias;
		}
		
		if(window.adxcel_rnd_info){
			extra_params += "|rndinf=" + window.adxcel_rnd_info;	
		}
		
		if(window.adxcel_tag_engine){
			extra_params += "|tgengn="+window.adxcel_tag_engine;
		}
		
		if(window.adxcel_tag_engine_review){
			extra_params += "|tgengnrv="+window.adxcel_tag_engine_review;
		}
		
		if(window.adxcel_snippetInfo){
			extra_params += "|sntpinf=" + (window.adxcel_snippetInfo);		
		}
		
		if(window.adxcel_dv360_data_str && (!excludeProps || excludeProps.indexOf("dv360")==-1)){
			extra_params += "|dv360=" + (window.adxcel_dv360_hash?window.adxcel_dv360_hash:"nohash") + ":" + (window.adxcel_dv360_data_str);
		}
		
		if(window.adxcel_dv360_auction_data_str && (!excludeProps || excludeProps.indexOf("dv360")==-1)){
			extra_params += "|dv360_auc=" + (window.adxcel_dv360_hash?window.adxcel_dv360_hash:"nohash") + ":" + (window.adxcel_dv360_auction_data_str);
		}
		
		if(window.adxcel_xandr_data_str && (!excludeProps || excludeProps.indexOf("xandr")==-1)){
			extra_params += "|xandr=" + (window.adxcel_xandr_hash?window.adxcel_xandr_hash:"nohash") + ":" + (window.adxcel_xandr_data_str);
		}
		
		if(window.adxcel_adobe_data_str && (!excludeProps || excludeProps.indexOf("adobe")==-1)){
			extra_params += "|adobe=" + (window.adxcel_adobe_hash?window.adxcel_adobe_hash:"nohash") + ":" + (window.adxcel_adobe_data_str);
		}
		
		if(window.ibm_data_str && (!excludeProps || excludeProps.indexOf("ibmdt")==-1)){
			extra_params += "|ibmdt=" + (window.ibm_data_hash?window.ibm_data_hash:"nohash") + ":" + (window.ibm_data_str);
		}
		
		if(window.adxcel_ttd_data_str && (!excludeProps || excludeProps.indexOf("ttd")==-1)){
			extra_params += "|ttd=" + (window.adxcel_ttd_hash?window.adxcel_ttd_hash:"nohash") + ":" + (window.adxcel_ttd_data_str);
		}
		
		if(bswx_ctrk && !excludeUID){
			extra_params += "|bswx_ctrk=" + (bswx_ctrk);	
		}
			
		if(beeswax_account_id && !excludeUID){
			extra_params += "|bswx_accid=" + (beeswax_account_id);	
		}
		
		if(window.adxcel_beeswax_data_str && (!excludeProps || excludeProps.indexOf("bswx")==-1)){
			extra_params += "|bswx=" + (window.adxcel_beeswax_hash?window.adxcel_beeswax_hash:"nohash") + ":" + (window.adxcel_beeswax_data_str);
		}
		
		if(bsw_auction_id){
			extra_params += "|bswx_auid=" + (bsw_auction_id);
		}
		if(bsw_line){
			extra_params += "|bswx_ln=" + (bsw_line);
		}
		if(bsw_creative_id){
			extra_params += "|bswx_crid=" + (bsw_creative_id);
		}
		
		if(mediamath_uuid){
			extra_params += "|mdmthuuid_=" + (mediamath_uuid);
		}
		if(mediamath_BID_ATTR_bid_id){
			extra_params += "|mdmthbid_id=" + (mediamath_BID_ATTR_bid_id);
		}
		if(mediamath_data_str && (!excludeProps || excludeProps.indexOf("mdmth")==-1)){
			extra_params += "|mdmth=" + (mediamath_data_hash?mediamath_data_hash:"nohash") + ":" + (mediamath_data_str);
		}
		
		if(window.adxcel_time_stamps){
			extra_params += "|tmstsmps=" + window.adxcel_time_stamps.join(",");
		}		
		
		if(window.adxcel_ga.href_length){
			extra_params += "|hreflength=" + window.adxcel_ga.href_length;
		}
		
		if(window.adxcel_settings.bundle){
			extra_params += "|bundle=" + encodeURIComponent(window.adxcel_settings.bundle);
		}
		
		if(window.adxcel_settings.msgAddon){
			for(var lp in window.adxcel_settings.msgAddon){
				extra_params += "|" + lp + "=" + encodeURIComponent(window.adxcel_settings.msgAddon[lp]);
			}
		}
	}
	params += extra_params;

	return params;
};

//window.adxcel_ga_event = function (event, value, callback) {
window.adxcel_ga_event = function (event, value, callback, return_url) {
	//dont send some event
	if (event == "widget.open"
		|| event == "page.open") {
		return;
	}

	if (event) {
		var ind = event.indexOf("imp");
		if (ind == 0) {
			var num = event.substr(3);
			num = parseInt(num);
			if (num && num > 0) {
				var prob = 1 / num;
				if (Math.random() < prob) {
					//ok
				} else {
					return;
				}
			}
		}
	}

	var app = window.adxcel_ga;
	var parent = document.getElementById(window.adxcel_id + 'hrefbox');
	app.ga_index++;
	var ind = app.ga_index;
	rec = [app.trackerAlias + '_trackEvent', app.adName, event, value];
	//adxcel_doAnalyticsRequest(parent, ind, rec, app, callback);

	//extra trackers
	if(return_url){
		return adxcel_try_adxcel_track_event(event, value, app, return_url);
	}
	
	adxcel_try_adxcel_track_event(event, value, app);
};

//window.adxcel_try_adxcel_track_event = function (event, value, app) {
window.adxcel_try_adxcel_track_event = function (event, value, app, return_url) {
	if (!app) app = window.adxcel_ga;

	if (app && app.trackers && app.trackers.length > 0) {
		var parent = app.parent ? app.parent : document.getElementById(window.adxcel_id + 'hrefbox');
		for (var i = 0; i < app.trackers.length; i++) {
			var trk = app.trackers[i];
			var active = false;
			var prob = trk.prob ? trk.prob : "";
			if (prob) {
				try {
					active = Math.random() < prob ? true : false;
				} catch (e) {
					//
				}
			} else {
				active = true;
			}
			var events = trk.events;
			if (active && (events == "*" || events == event)) {
				var url = trk.pixel;
				if (url) {
					url = url.replace(/%GA_CODE%/g, app.trackingAccount);
					url = url.replace(/%CATEGORY%/g, app.adName);
					url = url.replace(/%ACTION%/g, event);
					url = url.replace(/%LABEL%/g, encodeURIComponent(value));
					url = url.replace(/%URL_REQ%/g, encodeURIComponent("|url_req=" + encodeURIComponent(window.url_request)));
					url = url.replace(/%PROB%/g, prob ? ("|prob=" + prob) : "");

					var user = window.adxcel_ga.user;
					url = url.replace(/%ENC_U1_GA_CODE%/, enc_u1(((user && user.uid) ? user.uid : ""), app.trackingAccount));
					url = url.replace(/%ENC_U1_CATEGORY%/, enc_u1(((user && user.uid) ? user.uid : ""), app.adName));
					url = url.replace(/%ENC_U1_LABEL%/, enc_u1(((user && user.uid) ? user.uid : ""), (value)));
					
					if(url.indexOf("%LABEL_LITE%") != -1 || url.indexOf("%ENC_U1_LABEL_LITE%") != -1){
						var excludeProps = ["usrimp=", "bswx=", "prflrsp=","dv360=","xandr=","ttd=","adobe=","ibmdt="];
						var arr = value.split("|");
						value = [];
						arr.forEach(function(vl){
							var found = excludeProps.find(function(prop){ return vl.indexOf(prop)==0; });
							if(!found){
								value.push(vl);
							}
						});
						value = value.join("|");
						url = url.replace(/%LABEL_LITE%/g, encodeURIComponent(value));
						url = url.replace(/%ENC_U1_LABEL_LITE%/, enc_u1(((user && user.uid) ? user.uid : ""), (value)));
					}
					
					if(window.adxcel_is_verbose){
						console.log("event: " + event);
						console.log("MSG: " + value.split("|").join("\n"));
					}

//q1w2e3r4
					if(return_url){
						return url
					}

					adxcel_imageTracker(url, parent, null);
				}
			}
		}
	}
};

window.adxcel_rand = function (min, max) {
	return min + Math.floor(Math.random() * (max - min));
};
window.adxcel_generateHash = function (input) {
	var hash = 1; // hash buffer
	var leftMost7 = 0; // left-most 7 bits
	var pos;		   // character position in string
	var current;	   // current character in string		
	// if input is undef or empty, hash value is 1
	if (input != null && input != "") {
		hash = 0;
		// hash function
		for (pos = input.length - 1; pos >= 0; pos--) {
			current = input.charCodeAt(pos);
			hash = ((hash << 6) & 0xfffffff) + current + (current << 14);
			leftMost7 = hash & 0xfe00000;

			if (leftMost7 != 0) {
				hash ^= leftMost7 >> 21;
			}
		}
	}
	return hash;
};
window.adxcel_createGA_utmcc = function () {
	var utmcc = "";
	var hostname = window.location.hostname;
	if (!hostname) hostname = "local";

	//--see gdoc GA issue (DA account)

	var today = (new Date()).getTime();
	var today_seconds = Math.floor(today / 1000);
	//7 days cookie
	var countDays = 7;
	var expire = new Date();
	expire.setTime(today + 3600000 * 24 * countDays);

	var def_domainHash = adxcel_generateHash(hostname); //random cookie number
	var def_sessionId = adxcel_rand(1000000000, 2147483647); //number under 0x7FFFFFFF

	domainHash = def_domainHash;
	sessionId = def_sessionId;
	firstTime = today_seconds;
	lastTime = today_seconds;
	currentTime = today_seconds;
	sessionCount = 1;
	campaignCreation = today_seconds;
	campaignSessions = 1;
	responseCount = 1;

	//case of no cookies
	var __utma_value = domainHash + '.' + sessionId + '.' + firstTime + '.' + lastTime + '.' + currentTime + '.' + sessionCount;
	var __utmz_value = domainHash + '.' + campaignCreation + '.1.1.utmcsr=(direct)|utmccn=(direct)%|utmcmd=(none)';

	utmcc = "__utma=" + __utma_value + ";+__utmz=" + __utmz_value + ";";

	return {
		utmcc: utmcc,
		firstTime: firstTime,
		sessionId: sessionId,
		sessionCount: sessionCount
	};
};
window.adxcel_doAnalyticsRequest = function (parent, ind, rec, app, callback) {
	var method = rec[0]; // _setAccount, _trackEvent
	var category = (rec.length > 1 && rec[1]) ? rec[1] : ""; //XXX-XXX.def.def
	var action = (rec.length > 2 && rec[2]) ? rec[2] : ""; //"widget.open",
	var label = (rec.length > 3 && rec[3]) ? rec[3] : ""; //""
	var utmcc = "";
	if (!app.ga_utmcc) {
		utmcc = createGA_utmcc(app.sessionId, app.firstTime, app.sessionCount)
		app.ga_utmcc = utmcc;
	}

	utmcc = String(app.ga_utmcc);

	var params = null;
	switch (method) {
		case "_setAccount":
			//
			break;
		case "_trackEvent":
			params = {};
			params.utmwv = "4.3as";
			params.utms = ind;
			params.utmn = adxcel_rand(10000000, 99999999);
			params.utmhn = window.location.hostname;
			params.utmt = "event";
			params.utme = "5(" + category + "*" + action + "*" + label + ")";
			params.utmr = 0;
			//params.utmp = encodeURIComponent(window.location.pathname + window.location.search);
			params.utmp = encodeURIComponent(window.location.pathname);
			params.utmac = app.trackingAccount;
			params.utmcc = encodeURIComponent(utmcc);
			break;
	}
	if (params && params.utmac && params.utmac != "undefined") {
		var pixel_src = "http://www.google-analytics.com/__utm.gif";
		var params_str = "";
		for (var p in params) {
			params_str += ((params_str == "") ? ("?") : ("&")) + p + "=" + params[p];
		}
		adxcel_imageTracker(pixel_src + params_str, parent, callback);
	}
};

window.replaceMacro = function (url) {
	var ad_ga = window.adxcel_ga;
	var ad_user = ad_ga.user?ad_ga.user:{};
	var ad_set = window.adxcel_settings;
	var idfaOrDeviceID = ad_user.idfa?ad_user.idfa:(ad_user.device_id?ad_user.device_id:"");
	
	url = url.replace(/%(25)*GA_CODE%(25)*/g, window.adxcel_settings.ga_account);
	url = url.replace(/%(25)*CATEGORY%(25)*/g, window.adxcel_ga.adName);
	url = url.replace(/%(25)*ADXVRS%(25)*/g, window.adxcel_ga.adxcl_var);
	url = url.replace(/%(25)*UID%(25)*/g, (window.adxcel_ga.user.uid ? window.adxcel_ga.user.uid : ""));
	url = url.replace(/%(25)*IDFA%(25)*/g, (window.adxcel_ga.user.idfa ? window.adxcel_ga.user.idfa : ""));
	url = url.replace(/%(25)*DEVICE_ID%(25)*/g, (window.adxcel_ga.user.device_id ? window.adxcel_ga.user.device_id : ""));
	url = url.replace(/%(25)*listener_id%(25)*/g, (window.adxcel_ga.user.listener_id ? window.adxcel_ga.user.listener_id : ""));
	url = url.replace(/%(25)*MAID%(25)*/g, ((window.adxcel_ga.user.device_id && window.adxcel_ga.user.device_id != "__GAID__") ? window.adxcel_ga.user.device_id : ((window.adxcel_ga.user.idfa && window.adxcel_ga.user.idfa != "__IDFA__") ? window.adxcel_ga.user.idfa : "" )));
	
	url = url.replace(/%(25)*TAG%(25)*/g, "install");
	url = url.replace(/%(25)*LABEL%(25)*/g, encodeURIComponent(adxcel_addUserSegmentParams("_bnr", "2", true)));
	url = url.replace(/%LABEL_EVENT%/g, encodeURIComponent(adxcel_addUserSegmentParams("_bnr", "", false)));
	url = url.replace(/%LABEL_ADX%/g, encodeURIComponent(adxcel_addUserSegmentParams("bnr_1!", "adx", false)));
	url = url.replace(/%VARIATION_SHORT_LABEL%/g, window.adxcel_substring("%VARIATION_SHORT_LABEL%"));
	url = url.replace(/%VARIATION_COMPACT_LABEL%/g, window.adxcel_substring("%VARIATION_COMPACT_LABEL%"));
	url = url.replace(/%GENDER_LABEL%/g, window.adxcel_substring("%GENDER_LABEL%"));
	url = url.replace(/%GENDER_COMPACT_LABEL%/g, window.adxcel_substring("%GENDER_COMPACT_LABEL%"));
	url = url.replace(/%AGE%/g, (window.adxcel_ga.user.age ? window.adxcel_ga.user.age : ""));
	url = url.replace(/%AGE_LABEL%/g, window.adxcel_substring("%AGE_LABEL%"));
	url = url.replace(/%AGE_LABEL_MZ%/g, window.adxcel_substring("%AGE_LABEL_MZ%"));
	url = url.replace(/%IAB_CAT%/g, "game");
	url = url.replace(/%SIZE%/g, "300x250");
	url = url.replace(/%DMA%/g, window.adxcel_ga.user.am_geo);

	var user = window.adxcel_ga.user;
	var enc_key = (user.uid ? user.uid : "");
	url = url.replace(/%ENC_U1_GA_CODE%/g, enc_u1(enc_key, window.adxcel_settings.ga_account));
	url = url.replace(/%ENC_U1_CATEGORY%/g, enc_u1(enc_key, window.adxcel_ga.adName));
	url = url.replace(/%ENC_U1_CATEGORY_WITH_MSG%/g, enc_u1(enc_key, window.adxcel_ga.adName + "!" + window.adxcel_settings.rev + "!" + window.adxcel_addUserShortSegmentParams("", "", false)));
	url = url.replace(/%ENC_U1_LABEL%/g, (enc_u1(enc_key, adxcel_addUserSegmentParams("_bnr", "2", true))));
	var code_cat = window.adxcel_settings.ga_account + "!" + window.adxcel_ga.adName + "!";
	url = url.replace(/%ENC_U1_CODE_CAT%/g, enc_u1(enc_key, code_cat));
	var code_uid = window.adxcel_settings.ga_account + "!" + (window.adxcel_ga.user.uid ? window.adxcel_ga.user.uid : "");
	url = url.replace(/%ENC_U1_CODE_UID%/g, enc_u1(enc_key, code_uid));

	url = url.replace(/%(25)*eaid\!/g, window.adxcel_settings.dfp_ad_id);
	url = url.replace(/%(25)*ebuy\!/g, window.adxcel_settings.dfp_order_id);
	url = url.replace(/%(25)*ecid\!/g, window.adxcel_settings.dfp_creative_id);
	url = url.replace(/%(25)*eadv\!/g, window.adxcel_settings.dfp_advertiser_id);
	url = url.replace(/%(25)*epid\!/g, window.adxcel_settings.dfp_placement_id);

	url = url.replace(/%COST_MODEL_MACRO%/g, window.adxcel_settings.cost_model_id);
	url = url.replace(/%COST_MACRO%/g, window.adxcel_settings.cost_id);
	url = url.replace(/%INPUT_MACRO%/g, window.adxcel_settings.input_id);	
  
	var ord = Math.random() * 10000000000000000;
	url = url.replace(/\[ord\]/g, ord);

	var dt = new Date();
	var timestamp = "" + Math.round(dt.getTime() / 1000);
	url = url.replace(/\[timestamp\]/g, ord);

	var ord_static = typeof window[adxcel_id + "ord_static"] === "undefined" ? Math.random() * 10000000000000000 : window[adxcel_id + "ord_static"];
	window[adxcel_id + "ord_static"] = ord_static;
	url = url.replace(/\[ord_static\]/g, ord_static);
	
	if(window.adxcel_macros_data){
		for(var prop in window.adxcel_macros_data){
			url = url.replace(new RegExp(prop,"g"), window.adxcel_macros_data[prop]);
		}
	}
	
	url = url.replace(/\=mobADID/g, "="+idfaOrDeviceID);
	//url = url.replace(/$\{mobADID}/g, idfaOrDeviceID);
	
	//url = url.replace(/\{\{AUCTION_ID\}\}/g, window.adxcel_settings.auction_id?window.adxcel_settings.auction_id:"");
	//url = url.replace(/%AUCTION_ID%/g, window.adxcel_settings.auction_id?window.adxcel_settings.auction_id:"");
	

	return url;
};

window.adxcel_imageTracker = function (url, parent, callback) {
	var img = document.createElement("IMG");
	img.onload = function (e) {
		var img = e.currentTarget;
		if (!img) img = e.target;
		var parent = window.adxcel_ga.parent;

		parent.removeChild(img);
		if (callback) {
			callback();
		}
	};
	img.onerror = function (e) {
		var img = e.currentTarget;
		if (!img) img = e.target;
		var parent = window.adxcel_ga.parent;
		parent.removeChild(img);
		if (callback) {
			callback();
		}
	};

	img.setAttribute("width", 1);
	img.setAttribute("heigh", 1);

	if (url && url.indexOf("[timestamp]") != -1) {
		var dt = new Date();
		url = url.split("[timestamp]").join("" + Math.round(dt.getTime() / 1000));
	}

	if (url && url.indexOf("[ord]") != -1) {
		var ord = Math.random() * 10000000000000000;
		ord = Math.floor(ord);
		url = url.split("[ord]").join("" + ord);
	}


	if (window.adxcel_is_verbose || window.adxcel_is_debug) {
		console.log("imageTracker: " + url);
	} else {
		img.setAttribute("src", url);
		parent.appendChild(img);
	}
};
window.adxcel_scriptTracker = function (url, parent, callback) {
	var script = document.createElement('script');

	script.onload = function (e) {
		if (callback) {
			callback();
		}
	};
	script.onerror = function (e) {
		if (callback) {
			callback();
		}
	};


	if (window.adxcel_is_verbose || window.adxcel_is_debug) {
		console.log("scriptTracker: " + url);
	} else {
		//script.setAttribute("src", url);
		//document.getElementsByTagName('head')[0].appendChild(script);

		script.src = url;
		parent.appendChild(script);
	}
};
window.adxcel_iframeTracker = function (url, parent, callback) {
	var iframe = document.createElement("iframe");
	iframe.setAttribute("style", "display:none;");
	iframe.onload = function (e) {
		if (callback) {
			callback();
		}
	};
	iframe.onerror = function (e) {
		if (callback) {
			callback();
		}
	};


	if (window.adxcel_is_verbose || window.adxcel_is_debug) {
		console.log("iframeTracker: " + url);
	} else {
		//iframe.setAttribute("src", url);
		//document.getElementsByTagName('head')[0].appendChild(iframe);

		iframe.src = url;
		parent.appendChild(iframe);
	}
};

//CONTENT
//main action to apply content form var
function adxcel_applyContentAlpha_replace(url, content) {
	if (content) {
		for (var prop in content) {
			url = url.replace("{"+prop+"}", encodeURIComponent(content[prop]));
		}
	}
	//q1w2e3r4
//	if(url.indexOf("http") != 0) {
	if(url.indexOf("http") < 0) {
		url = window.adxcel_settings.frame_base + url;
	}
	if(url.indexOf("runtime_clickTag") != -1){
		url = url.replace("{@runtime_clickTag}", encodeURIComponent(window.runtime_clickTag));
	}
	if(url.indexOf("runtime_fclick") != -1){
		url = url.replace("{@runtime_fclick}", encodeURIComponent(window.runtime_fclick));
	}
//
	return url;
}

/*
function adxcel_applyContentAlpha_replace(url, content) {
	if (content) {
		for (var prop in content) {
			url = url.replace("{"+prop+"}", encodeURIComponent(content[prop]));
		}
	}
	return url;
}
*/
function adxcel_applyContentAlpha(content) {
	if (!content) return;
		
	var nodes = [];
	var container = document.getElementById(adxcel_id + "container");
	for (var prop in content) {
		if(!prop || prop.indexOf("@")!=0){
			continue;
		}
		
		if(prop == "@iframe"){
			var url = content[prop];
			url = adxcel_applyContentAlpha_replace(url, content);
			var iframe = document.createElement("iframe");
				iframe.width = "100%";
				iframe.height = "100%";
				iframe.src = url;
				iframe.setAttribute("border", 0);
				iframe.setAttribute("scrolling", "no");				
				iframe.style["border-width"] = "0px";
				iframe.style["position"] = "absolute";
				iframe.style["left"] = "0px";
				iframe.style["top"] = "0px";
				if(window.adxcel_is_verbose){
					console.log("IFRAME: " + url);
				}
				iframe.onload = function(){
					if(window.adxcel_is_verbose){
						console.log("iframe.onload")
					}
					if(!window.adxcel_iframe_loaded){
						window.adxcel_iframe_loaded = true;
						//4
						//window.adxcel_time_stamps.push(new Date().getTime() - window.adxcel_time0);
					}

				}
			container.appendChild(iframe);				
		}else if(prop == "@script"){
			var url = content[prop];
			url = adxcel_applyContentAlpha_replace(url, content);
			var node = document.createElement("script");
				node.setAttribute("src", url);
			nodes.push(node);
		}else if(prop == "@link"){
			var url = content[prop];
			url = adxcel_applyContentAlpha_replace(url, content);
			var node = document.createElement("link");
				node.setAttribute("href", url);
				node.rel  = 'stylesheet';
			    node.type = 'text/css';
			    node.media = 'all';
			nodes.push(node);
			//<link href="css/tag_v2.css" rel="stylesheet" media="screen">
		}
	}
	
	//load with limitation
	if(nodes && nodes.length>0){
		adxcel_loadContentAlphaNodes(nodes);
	}
}

function adxcel_loadContentAlphaNodes(nodes){
	
	if(!nodes || nodes.length ==0) return;
	
	var allNodes = nodes.slice(); 
	var onloadHandler = function(node){
		var ind = allNodes.indexOf(node);
		if(ind != -1) allNodes.splice(ind, 1);
		if(allNodes.length == 0){
			onloadReady();	
		}	
	};
	var onloadReady = function(){
		//
	};
	allNodes.forEach(function(node){
		adxcel_loadContentAlphaNodes_load(node, onloadHandler);
	});	
}

function adxcel_loadContentAlphaNodes_load(node, onloadHandler){
	node.onload = node.onerror = function(){
		onloadHandler(node);
	};
	
	var container = document.getElementById(adxcel_id + "container");
	container.appendChild(node);
}

//main action to apply content form var
function adxcel_applyContent(content) {
	if (!content) return;
	
	//@ alphaContent
	
	var packageOrder = [];
	for (var prop in content) {
		if (prop){
			var cnt = content[prop];
			//if(cnt["data-src"] || cnt["-pkg"]  && (cnt["skip-pkg"]!="true" && cnt["skip-pkg"]!="1") ){
			if( (cnt["data-src"] || cnt["-pkg"]) && (cnt["skip-pkg"]!="true" && cnt["skip-pkg"]!="1") ){
				packageOrder.push(prop);
			}
		}
	}
	
	//see constructor
	packageOrder.sort(function (a, b) {
	  var result = a > b ? 1 : ((a < b) ? -1 : 0);
	  return result;
	});

	//applyContentItem
	for (var prop in content) {
		if(!prop || prop.indexOf("@")==0){
			continue;
		}
		
		//var packageIndex = packageOrder.indexOf(prop);
		
		//find srcURL = data["data-src"]
		var packageIndex = packageOrder.indexOf(prop);
		
		if (prop.indexOf("#") == 0) {
			var prop0 = prop.substr(1);
			var item = document.getElementById(window.adxcel_id + "_" + prop0);
			var cnt = content[prop];
			adxcel_applyContentItem(item, cnt, packageIndex, content);
			if (cnt) {
				if (!item) {
					if(window.adxcel_is_verbose){
						console.log("not found: " + prop0);
					}
				} else {
					item.style.display = "inline";
				}
			}
		}
		if (prop.indexOf("_#") == 0) {
			var prop0 = prop.substr(2);
			var item = document.getElementById(window.adxcel_id + prop0);
			var cnt = content[prop];
			adxcel_applyContentItem(item, cnt, packageIndex, content);
			if (cnt) {
				if (!item) {
					if(window.adxcel_is_verbose){
						console.log("not found: " + prop0);
					}
				} else {
					item.style.display = "inline";
				}
			}
		}
	}

	if (window.onApplyContent) {
		window.onApplyContent(content);
	}
}
function adxcel_applyContentItem(item, cnt, packageIndex, topContent){
	if(item && cnt){
		var ladxcl_var = window.adxcel_ga.adxcl_var;
		if(ladxcl_var) ladxcl_var = ladxcl_var.replace(/\./g,"");
				
		for(var attr in cnt){
			if(attr == "id") continue;
			var vl = cnt[attr];
			
			if(attr == "@iframe"){
				var iframe_scale = cnt["@iframe_scale"];
				var url = vl;
				url = adxcel_applyContentAlpha_replace(url, topContent);
				var iframe = document.createElement("iframe");
					iframe.width = "100%";
					iframe.height = "100%";
					iframe.src = url;
					iframe.setAttribute("border", 0);
					iframe.setAttribute("scrolling", "no");				
					iframe.style["border-width"] = "0px";
					iframe.style["position"] = "absolute";
					iframe.style["left"] = "0px";
					iframe.style["top"] = "0px";
					if(iframe_scale && iframe_scale.length>1){
						var scaleX = iframe_scale[0];
						var scaleY = iframe_scale[1];
						iframe.style["transform"] = "scale("+ scaleX +", " + scaleY + ")";
						iframe.style["transform-origin"] = "0 0 ";
						iframe.style["-webkit-transform"] = "scale("+ scaleX +", " + scaleY + ")";
						iframe.style["-webkit-transform-origin"] = "0 0 ";
						
						iframe.width = (100/scaleX)+"%";
						iframe.height = (100/scaleY)+"%";
					}
					
					if(window.adxcel_is_verbose){
						console.log("IFRAME: " + url);
					}
					iframe.onload = function(){
						if(window.adxcel_is_verbose){
							console.log("iframe.onload")
						}
						if(!window.adxcel_iframe_loaded){
							window.adxcel_iframe_loaded = true;
							//4
							window.adxcel_time_stamps.push(new Date().getTime() - window.adxcel_time0);
						}

					}
					
				item.appendChild(iframe);				
			}
			
			if(!attr || attr.indexOf("@")==0){
				continue;
			}
			
			if (attr == "-pkg") {
				attr = "data-pkg";
			}
			if (attr == "data-src" && !cnt["skip-pkg"]) {
				var coordinates = adxcel_content_packages ? adxcel_content_packages[ladxcl_var] : null;
				
				//exclude extended B1+B2
				if(ladxcl_var.indexOf("extended_v2") != -1 && (ladxcl_var.indexOf("B1")!=-1 || ladxcl_var.indexOf("B2")!=-1)){
					//coordinates = null;
				}
				
				if(coordinates && coordinates[packageIndex]){
					var position = "-" + coordinates[packageIndex][0]+"px"+" " + "-" + coordinates[packageIndex][1] + "px";					
					item.style["background-position"] = position;
					item.style["background-image"] = "url(" + adxcel_getCurrentPackageURL()+ ")";
			  		item.style["background-repeat"]= "no-repeat";			  		
			  		if((item.nodeName.toLowerCase()=="img")){
			  			item.setAttribute("src", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=");
			  		}			  		
		  		}else{
		  			if(item.nodeName && item.nodeName.toLowerCase()=="div"){
		  				var url = cnt[attr];
		  				if(url.indexOf("http") != 0) {
							url = window.adxcel_settings.frame_base + url;
						}
		  				item.style["background-position"] = "0px 0px";
						item.style["background-image"] = "url(" + url + ")";
		  			}else if(item.nodeName && (item.nodeName.toLowerCase()=="img")){
		  				var url = cnt[attr];
		  				if(url.indexOf("http") != 0) {
							url = window.adxcel_settings.frame_base + url;
						}
		  				item.setAttribute("src", url);
		  				//item.setAttribute("src", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=");
		  			}
		  		}
			}else if(attr == "data-src" && cnt["skip-pkg"]){
				if(item.nodeName && (item.nodeName.toLowerCase()=="div")){
	  				var url = cnt[attr];
	  				if(url.indexOf("http") != 0) {
						url = window.adxcel_settings.frame_base + url;
					}
	  				item.style["background-position"] = "0px 0px";
					item.style["background-image"] = "url(" + url + ")";
	  			}else if(item.nodeName && (item.nodeName.toLowerCase()=="img")){
	  				var url = cnt[attr];
	  				if(url.indexOf("http") != 0) {
						url = window.adxcel_settings.frame_base + url;
					}
	  				item.setAttribute("src", url);
	  			}
			}
			
			if(attr == "data-src"){
				//attr = "src";
			}
			if(attr == "src" && vl && vl.indexOf("http")!=0){
				vl = window.adxcel_settings.frame_base + vl;
			}
			
			if(attr == "innerHTML"){
				item[attr] = cnt[attr];
			}else if(attr != "style"){
				item.setAttribute(attr, vl);
			}else if(attr == "style"){
				 var stl =  cnt[attr];
				 for(var prop in stl){
					//$item.css(prop, stl[prop]);	
					item.style[prop] = stl[prop];
				}
			}
		}
	}
}

	
function adxcel_getCurrentPackageURL(){
	var adxcl_var = window.adxcel_ga.adxcl_var;
	adxcl_var = adxcl_var.replace(/\./g,"");
	var url = adxcel_content_packages_path + adxcl_var + adxcel_content_packages_path_addon;
	return url;
}

//, 10, adxcel_id);


//setTimeout(function () { window.adxcel_createAd(window.adxcel_id); }, 100);
//adxcel_getRandomWeightArrIndex + weight 
//portion - 0..1 - need for RND sharding
function adxcel_selectRevisionBySlot(slot, revisions, weights, portion){
	
	if(!portion) portion = 1;
	var volume = 16384 * portion;
	
	var rev = -1;
	
	var sumW = 0;
	var wSegments = [];
	weights.forEach(function(w){
		sumW += w;
		wSegments.push(sumW);
	});
	
	var wSlot = slot/volume * sumW; 
	var left = 0;;
	var ind = -1;
	while(wSlot >= left){
		ind++;
		left += weights[ind];
	}
	if(ind>=0 && ind<revisions.length){
		rev = revisions[ind]; 
	}
	
	rev = revisions[ind];
	
	if(window.adxcel_is_verbose){
		var output = "SLOT: " + slot +"/" + volume.toFixed(2) + " -> " + (slot/volume*100).toFixed(2)+"%  ->  " + revisions.join(",")+"|"+weights.join(",") + " -> " + " ind:"+ind + " -> val:"+rev;
		console.log(output);
	}
	
	return rev;
}

//profile request
function createEmptyProfile(){
	var profile = {
				lv: [0,0,0],
				impressions: 0,
				timestamp:null,
				localtime:null,
				clicks: 0,
				lc:0
		};
	return profile;	
}

function asyncReqProfile(){
	var key = "",
		idfa = UrlParam("idfa", ""),
		device_id = UrlParam("device_id", UrlParam("consumer_id", ""))
		;
				
	if ((!idfa || idfa == "__IDFA__") && (!device_id || device_id == "__GAID__")) {
		key = null;
	} else {
		key += (idfa && idfa !== "__IDFA__") ? idfa : device_id;
	}
	
	/*if(!key || key.length == 0 || key == "00000000-0000-0000-0000-000000000000"){
		window.adxcel_settings.profile = null;
		window.adxcel_settings.noprofile_reason = "nokey";
		setTimeout(function(){
			window.adxcel_createAd(window.adxcel_id);
		},100);
		return;	
	}*/
	
	var ad_log = window.adxcel_settings.ga_account;
	var ua = window.navigator ? navigator.userAgent : "";
	ua = ((adxcel_device && adxcel_device.vendor) ? adxcel_device.vendor : "Generic") + ( (adxcel_os && adxcel_os.version) ? ( (adxcel_os.version.indexOf(".")>0) ? adxcel_os.version.split(".").shift() : adxcel_os.version.split("_").shift() ) : "-1" );
	if(!ua || ua.length == 0){
		ua = window.navigator ? navigator.userAgent : "";
	}	
		
	var cfg_domain = "arttrk.com";
	if(window.adxcel_settings.domain_cfg){
		cfg_domain = window.adxcel_settings.cfg_domain;
	}else if(window.adxcel_settings.domain_mapping){
		cfg_domain = window.adxcel_settings.domain_mapping["cfg"] ? window.adxcel_settings.domain_mapping["cfg"] : cfg_domain;
	}
	//nostrict	
	var url = "https://"+cfg_domain+"/service/?action=consumer.profile.get"
	+ "&ad_log="+ad_log 
	+ "&uid=" + window.adxcel_uid
	+ (key ? ("&consumer_id="+key) : "") 
	//+ "&ua="+encodeURIComponent(ua)
	+ "&inc_ucxt=1"
	+ "&inc_isp=1"
	+ ( window.adxcel_settings.inc_wfxzp ? "&inc_wfxzp=" + (isNaN(parseInt(window.adxcel_settings.inc_wfxzp))?1:parseInt(window.adxcel_settings.inc_wfxzp)) : "")
	+ "&inc_devatl=1"
	+ ( (window.adxcel_settings.hasOwnProperty("inc_segm") ? window.adxcel_settings.inc_segm : true ) ? "&inc_segm=1" : "")
	+ ( (window.adxcel_settings.hasOwnProperty("inc_aip") ? window.adxcel_settings.inc_aip : true ) ? "&inc_aip=1" : "")
	+ ( (window.adxcel_settings.hasOwnProperty("inc_zip5") ? window.adxcel_settings.inc_zip5 : true ) ? "&inc_zip5=1" : "")
	
	+ "&nostrict=1"
	;
	
	
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.ontimeout = function() {
		window.adxcel_settings.profile = createEmptyProfile();
		window.adxcel_settings.noprofile_reason = "timeout";
		window.adxcel_createAd(window.adxcel_id);
	};
	
	xhr.onload = function (e) {
		if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				onLoadAsyncReqProfile(xhr.responseText);
			} else {
				//
			}
		}
	};
	
	xhr.onerror = function (e) {
		window.adxcel_settings.profile = createEmptyProfile();
		window.adxcel_settings.noprofile_reason = "error";
		window.adxcel_createAd(window.adxcel_id);
	};
	xhr.timeout = 5000;
	try{
		xhr.send(null);
	}catch(e){
		console.log(e);
		window.adxcel_settings.profile = null;
		window.adxcel_settings.noprofile_reason = "senderror";
		setTimeout(function(){
			window.adxcel_createAd(window.adxcel_id);
		},100);				
	}
}

function onLoadAsyncReqProfile(responseText){
	var profile = null;
	var geo = null;	
	var slot = null;
	try{		
		if(responseText && responseText != "{}"){
			var response = JSON.parse(responseText);
			
			var response_zip5 = response.zip5;
			delete response.zip5;
			
			//window.adxcel_settings.profile_response = (responseText);
			window.adxcel_settings.profile_response = JSON.stringify(response);

			if(response.isp){
				window.adxcel_isp_data = response.isp;
			}
			delete response.isp;


			if(response.ucxt){
				window.adxcel_ucxt_data = response.ucxt;
			}
			delete response.ucxt;

			//DA use random slot
			if(!window.adxcel_settings.use_slots){
				response.slot = Math.floor(16384 * Math.random());
			}
			
			slot = response.slot;
			delete response.slot;						
			
			//PatchTagContentCustomProfileSlot
			var in_profile_slot = (UrlParam("profile_slot", ""));
			if(in_profile_slot){
				if(in_profile_slot=="rnd"){
					in_profile_slot = Math.random();
				}else{
					in_profile_slot = parseFloat(in_profile_slot)
				}
			}
			if(in_profile_slot && !isNaN(in_profile_slot)){
				slot = Math.floor(in_profile_slot * 16384);
				//alert("DEBUG SLOT: " + slot);
				//var div = document.getElementsByTagName("div");
				var div = document.createElement("div");
				div.style["font-family"] = "Arial, Helvetica, sans-serif";
				div.style["position"] = "absolute";
				div.style["left"] = "0px";
				div.style["right"] = "0px";
				div.style["top"] = "0px";
				div.style["color"] = "#FFFFFF";
				div.style["background"] = "#80000099";
				div.style["padding"] = "4px";
				div.innerHTML = "DEBUG SLOT: " + slot;
				try{
					document.body.appendChild(div);
				}catch(e){
					console.log(e);
				}
			}
			//PatchTagContentCustomProfileSlot/end
			delete response.slot;
			
			if(response.devatl){
				window.adxcel_devatl_data = response.devatl;
			}
			delete response.devatl;
			
			var wfxzp_data = {};
			var wfxzp_map = {};
			var wfxzp_map_is_empty = true;
			if(response.wfxzp){
				for(var w_prop in response.wfxzp){
					var w_list = response.wfxzp[w_prop];
					var w_list_alias = (w_prop == "current") ? "c" : "f";
					if(w_list && w_list.length>0){
						for(var i=0;i<w_list.length; i++){
							if(!wfxzp_data[w_list_alias]){
								wfxzp_data[w_list_alias] = [];
							}
							wfxzp_data[w_list_alias].push(w_list[i])
							if(w_prop == "current"){
								wfxzp_map["s_w"+w_list[i]] = 1;
							}else{
								wfxzp_map["s_"+w_list_alias+"_w"+w_list[i]] = 1;
							}	
							wfxzp_map_is_empty = false;
						}									
					}
				}
			}
			
			if(wfxzp_map_is_empty){
				wfxzp_data = {};
				if(window.adxcel_settings.inc_wfxzp){
					wfxzp_map["s_w"] = 1;
				}else{
					wfxzp_map = null;
				}
			}
			delete response.wfxzp;
			
			var user_segments = [];
			if(response.segments){
				user_segments = response.segments
			}
			delete response.segments;
			
			var user_oracle_segments = [];
			if(response.oracle){
				user_oracle_segments = response.oracle;
			}
			delete response.oracle;
			
			var user_prizm_segment = null;
			var prizm_group = null;
			if(response.prizm){
				user_prizm_segment = response.prizm;
				
				if(user_prizm_segment && user_prizm_segment["segment"]){
					var prizm_segment_value = user_prizm_segment["segment"];
					prizm_groups = {
						"Y1":[  4, 13, 21, 25, 31, 34, 35],
						"Y2":[ 40, 47, 48, 50, 54],
						"Y3":[ 55, 59, 60, 63, 64, 65, 66],
						"F1":[  2,  5,  6, 10, 11, 14, 15, 16],
						"F2":[ 23, 26, 27, 29, 30],
						"F3":[ 33, 37, 39, 44, 51],
						"F4":[ 42, 45, 56, 61, 68],
						"M1":[  1,  3,  7,  8,  9, 12],
						"M2":[ 17, 18, 19, 20, 22, 24, 28],
						"M3":[ 32, 36, 38, 41, 43, 46, 49, 52, 53],
						"M4":[ 57, 58, 62, 67]
					}
					for(var prop in prizm_groups){
						if(prizm_groups[prop] && prizm_groups[prop].indexOf(prizm_segment_value) != -1){
							prizm_group = prop;
							break;
						}
					}
				}			 
			}
			delete response.prizm;
			
			var prizm_zip5 = null;
			if(response_zip5){
				for(var i=0; i<response_zip5.length; i++){
					var percentValue = parseFloat(response_zip5[i]["percent"]);
					if(!isNaN(percentValue)){
						if(!prizm_zip5){
							prizm_zip5 = {};
						}
						prizm_zip5[response_zip5[i]["segment"]] = Math.round(percentValue*100)/100;
					}
				}
			}
			delete response.zip5;
			
			
			geo = {};
			geo.city = response.city;
			geo.zip = response.zip;
			geo.dma = response.dma;
			delete response.city;
			delete response.zip;
			delete response.dma;
			if(geo.city){
				geo.city = geo.city.toUpperCase();
				geo.city = geo.city.replace(/\ /g,"_");
			}
			
			delete response.ip;
			
			profile = createEmptyProfile();
			if(wfxzp_map){
				profile["wfxzp_map"] = wfxzp_map;
			}
			if(wfxzp_data){
				profile["wfxzp_data"] = wfxzp_data;
			}
			if(prizm_group){
				profile["prizm_group"] = prizm_group;
			}
			if(prizm_zip5){
				profile["prizm_zip5"] = prizm_zip5;
			}
			profile["segments"] = user_segments;
			profile["oracle_segments"] = user_oracle_segments;
			profile["prizm_segment"] = user_prizm_segment;
			for(var prop in response){
				profile[prop] = response[prop];
			}
			if( profile.timestamp ){
				profile.localtime = profile.timestamp  * 1000;
			}
			
		}else{
			profile = createEmptyProfile();
			window.adxcel_settings.noprofile_reason = "emptyresp";
		}
	}catch(e){
		profile = createEmptyProfile();
		window.adxcel_settings.noprofile_reason = "parse";
	}
	window.adxcel_settings.profile = profile;
	window.adxcel_settings.user_slot = slot;
	window.adxcel_settings.user_geo = geo;
	window.adxcel_createAd(window.adxcel_id);
}
if(window.__ad__ && window.__ad__.profile_response){
	onLoadAsyncReqProfile(window.__ad__.profile_response);
}else{
	asyncReqProfile();
}

//#OMID

function __getOmidGlobal() {
	if ("undefined" !== typeof omidGlobal && omidGlobal) {
		return omidGlobal;
	}
	if ("undefined" !== typeof global && global) {
		return global;
	}
	if ("undefined" !== typeof window && window) {
		return window;
	}
	if ("undefined" !== typeof module$contents$omid$common$OmidGlobalProvider_globalThis && module$contents$omid$common$OmidGlobalProvider_globalThis) {
		return module$contents$omid$common$OmidGlobalProvider_globalThis;
	}
	error("Could not determine global object context.");
}

//---

///omid build 

;(function(omidGlobal, factory, exports) {
  // CommonJS support
  if (typeof exports === 'object' && typeof exports.nodeName !== 'string') {
    factory(omidGlobal, exports);

  // If neither AMD nor CommonJS are used, export to a versioned name in the
  // global context.
  } else {
    var exports = {};
    var version = '1.2.6-dev';
    factory(omidGlobal, exports);

    function deepFreeze(object) {
      for (var key in object) {
        if (object.hasOwnProperty(key)) {
          object[key] = deepFreeze(object[key]);
        }
      }
      return Object.freeze(object);
    }

    // Inject and freeze the exported components of omid.
    for (var key in exports) {
      if (exports.hasOwnProperty(key)) {
        if (Object.getOwnPropertyDescriptor(omidGlobal, key) == null
          || Object.getOwnPropertyDescriptor(omidGlobal[key], version) == null) {
          // Define the top level property in the global scope
          if (Object.getOwnPropertyDescriptor(omidGlobal, key) == null) {
            Object.defineProperty(omidGlobal, key, {
              value: {},
            });
          }
          // Define the object exports keyed-off versions
          Object.defineProperty(omidGlobal[key], version, {
            get: function () {
              return deepFreeze(exports[key]);
            },
            enumerable: true,
          });
        }
      }
    }
  }
}(typeof global === 'undefined' ? this : global, function(omidGlobal, omidExports) {
  'use strict';var $jscomp = $jscomp || {};
$jscomp.scope = {};
$jscomp.inherits = function(a, b) {
  function c() {
  }
  c.prototype = b.prototype;
  a.superClass_ = b.prototype;
  a.prototype = new c;
  a.prototype.constructor = a;
  for (var d in b) {
    if ("prototype" != d) {
      if (Object.defineProperties) {
        var e = Object.getOwnPropertyDescriptor(b, d);
        e && Object.defineProperty(a, d, e);
      } else {
        a[d] = b[d];
      }
    }
  }
};
$jscomp.ASSUME_ES5 = !1;
$jscomp.ASSUME_NO_NATIVE_MAP = !1;
$jscomp.ASSUME_NO_NATIVE_SET = !1;
$jscomp.defineProperty = $jscomp.ASSUME_ES5 || "function" == typeof Object.defineProperties ? Object.defineProperty : function(a, b, c) {
  a != Array.prototype && a != Object.prototype && (a[b] = c.value);
};
$jscomp.getGlobal = function(a) {
  return "undefined" != typeof window && window === a ? a : "undefined" != typeof global && null != global ? global : a;
};
$jscomp.global = $jscomp.getGlobal(this);
$jscomp.SYMBOL_PREFIX = "jscomp_symbol_";
$jscomp.initSymbol = function() {
  $jscomp.initSymbol = function() {
  };
  $jscomp.global.Symbol || ($jscomp.global.Symbol = $jscomp.Symbol);
};
$jscomp.symbolCounter_ = 0;
$jscomp.Symbol = function(a) {
  return $jscomp.SYMBOL_PREFIX + (a || "") + $jscomp.symbolCounter_++;
};
$jscomp.initSymbolIterator = function() {
  $jscomp.initSymbol();
  var a = $jscomp.global.Symbol.iterator;
  a || (a = $jscomp.global.Symbol.iterator = $jscomp.global.Symbol("iterator"));
  "function" != typeof Array.prototype[a] && $jscomp.defineProperty(Array.prototype, a, {configurable:!0, writable:!0, value:function() {
    return $jscomp.arrayIterator(this);
  }});
  $jscomp.initSymbolIterator = function() {
  };
};
$jscomp.arrayIterator = function(a) {
  var b = 0;
  return $jscomp.iteratorPrototype(function() {
    return b < a.length ? {done:!1, value:a[b++]} : {done:!0};
  });
};
$jscomp.iteratorPrototype = function(a) {
  $jscomp.initSymbolIterator();
  a = {next:a};
  a[$jscomp.global.Symbol.iterator] = function() {
    return this;
  };
  return a;
};
$jscomp.makeIterator = function(a) {
  $jscomp.initSymbolIterator();
  var b = a[Symbol.iterator];
  return b ? b.call(a) : $jscomp.arrayIterator(a);
};
$jscomp.arrayFromIterator = function(a) {
  for (var b, c = []; !(b = a.next()).done;) {
    c.push(b.value);
  }
  return c;
};
$jscomp.arrayFromIterable = function(a) {
  return a instanceof Array ? a : $jscomp.arrayFromIterator($jscomp.makeIterator(a));
};
var module$exports$omid$common$argsChecker = {assertTruthyString:function(a, b) {
  if (!b) {
    throw Error("Value for " + a + " is undefined, null or blank.");
  }
  if ("string" !== typeof b && !(b instanceof String)) {
    throw Error("Value for " + a + " is not a string.");
  }
  if ("" === b.trim()) {
    throw Error("Value for " + a + " is empty string.");
  }
}, assertNotNullObject:function(a, b) {
  if (null == b) {
    throw Error("Value for " + a + " is undefined or null");
  }
}, assertNumber:function(a, b) {
  if (null == b) {
    throw Error(a + " must not be null or undefined.");
  }
  if ("number" !== typeof b || isNaN(b)) {
    throw Error("Value for " + a + " is not a number");
  }
}, assertNumberBetween:function(a, b, c, d) {
  (0,module$exports$omid$common$argsChecker.assertNumber)(a, b);
  if (b < c || b > d) {
    throw Error("Value for " + a + " is outside the range [" + c + "," + d + "]");
  }
}, assertFunction:function(a, b) {
  if (!b) {
    throw Error(a + " must not be truthy.");
  }
}, assertPositiveNumber:function(a, b) {
  (0,module$exports$omid$common$argsChecker.assertNumber)(a, b);
  if (0 > b) {
    throw Error(a + " must be a positive number.");
  }
}};
var module$exports$omid$common$VersionUtils = {}, module$contents$omid$common$VersionUtils_SEMVER_DIGITS_NUMBER = 3;
module$exports$omid$common$VersionUtils.isValidVersion = function(a) {
  return /\d+\.\d+\.\d+(-.*)?/.test(a);
};
module$exports$omid$common$VersionUtils.versionGreaterOrEqual = function(a, b) {
  a = a.split("-")[0].split(".");
  b = b.split("-")[0].split(".");
  for (var c = 0; c < module$contents$omid$common$VersionUtils_SEMVER_DIGITS_NUMBER; c++) {
    var d = parseInt(a[c], 10), e = parseInt(b[c], 10);
    if (d > e) {
      break;
    } else {
      if (d < e) {
        return !1;
      }
    }
  }
  return !0;
};
var module$exports$omid$common$ArgsSerDe = {}, module$contents$omid$common$ArgsSerDe_ARGS_NOT_SERIALIZED_VERSION = "1.0.3";
module$exports$omid$common$ArgsSerDe.serializeMessageArgs = function(a, b) {
  return (0,module$exports$omid$common$VersionUtils.isValidVersion)(a) && (0,module$exports$omid$common$VersionUtils.versionGreaterOrEqual)(a, module$contents$omid$common$ArgsSerDe_ARGS_NOT_SERIALIZED_VERSION) ? b : JSON.stringify(b);
};
module$exports$omid$common$ArgsSerDe.deserializeMessageArgs = function(a, b) {
  return (0,module$exports$omid$common$VersionUtils.isValidVersion)(a) && (0,module$exports$omid$common$VersionUtils.versionGreaterOrEqual)(a, module$contents$omid$common$ArgsSerDe_ARGS_NOT_SERIALIZED_VERSION) ? b ? b : [] : b && "string" === typeof b ? JSON.parse(b) : [];
};
var module$exports$omid$common$constants = {AdEventType:{IMPRESSION:"impression", STATE_CHANGE:"stateChange", GEOMETRY_CHANGE:"geometryChange", SESSION_START:"sessionStart", SESSION_ERROR:"sessionError", SESSION_FINISH:"sessionFinish", VIDEO:"video", LOADED:"loaded", START:"start", FIRST_QUARTILE:"firstQuartile", MIDPOINT:"midpoint", THIRD_QUARTILE:"thirdQuartile", COMPLETE:"complete", PAUSE:"pause", RESUME:"resume", BUFFER_START:"bufferStart", BUFFER_FINISH:"bufferFinish", SKIPPED:"skipped", VOLUME_CHANGE:"volumeChange", 
PLAYER_STATE_CHANGE:"playerStateChange", AD_USER_INTERACTION:"adUserInteraction"}, VideoEventType:{LOADED:"loaded", START:"start", FIRST_QUARTILE:"firstQuartile", MIDPOINT:"midpoint", THIRD_QUARTILE:"thirdQuartile", COMPLETE:"complete", PAUSE:"pause", RESUME:"resume", BUFFER_START:"bufferStart", BUFFER_FINISH:"bufferFinish", SKIPPED:"skipped", VOLUME_CHANGE:"volumeChange", PLAYER_STATE_CHANGE:"playerStateChange", AD_USER_INTERACTION:"adUserInteraction"}, ErrorType:{GENERIC:"generic", VIDEO:"video"}, 
AdSessionType:{NATIVE:"native", HTML:"html"}, EventOwner:{NATIVE:"native", JAVASCRIPT:"javascript", NONE:"none"}, AccessMode:{FULL:"full", LIMITED:"limited"}, AppState:{BACKGROUNDED:"backgrounded", FOREGROUNDED:"foregrounded"}, Environment:{MOBILE:"app"}, InteractionType:{CLICK:"click", INVITATION_ACCEPT:"invitationAccept"}, MediaType:{DISPLAY:"display", VIDEO:"video"}, Reason:{NOT_FOUND:"notFound", HIDDEN:"hidden", BACKGROUNDED:"backgrounded", VIEWPORT:"viewport", OBSTRUCTED:"obstructed", CLIPPED:"clipped"}, 
SupportedFeatures:{CONTAINER:"clid", VIDEO:"vlid"}, VideoPosition:{PREROLL:"preroll", MIDROLL:"midroll", POSTROLL:"postroll", STANDALONE:"standalone"}, VideoPlayerState:{MINIMIZED:"minimized", COLLAPSED:"collapsed", NORMAL:"normal", EXPANDED:"expanded", FULLSCREEN:"fullscreen"}, NativeViewKeys:{X:"x", LEFT:"left", Y:"y", TOP:"top", WIDTH:"width", HEIGHT:"height", AD_SESSION_ID:"adSessionId", IS_FRIENDLY_OBSTRUCTION_FOR:"isFriendlyObstructionFor", CLIPS_TO_BOUNDS:"clipsToBounds", CHILD_VIEWS:"childViews", 
END_X:"endX", END_Y:"endY", OBSTRUCTIONS:"obstructions"}, MeasurementStateChangeSource:{CONTAINER:"container", CREATIVE:"creative"}, ElementMarkup:{OMID_ELEMENT_CLASS_NAME:"omid-element"}, CommunicationType:{NONE:"NONE", DIRECT:"DIRECT", POST_MESSAGE:"POST_MESSAGE"}, OmidImplementer:{OMSDK:"omsdk"}};
var module$contents$omid$common$InternalMessage_GUID_KEY = "omid_message_guid", module$contents$omid$common$InternalMessage_METHOD_KEY = "omid_message_method", module$contents$omid$common$InternalMessage_VERSION_KEY = "omid_message_version", module$contents$omid$common$InternalMessage_ARGS_KEY = "omid_message_args", module$exports$omid$common$InternalMessage = function(a, b, c, d) {
  this.guid = a;
  this.method = b;
  this.version = c;
  this.args = d;
};
module$exports$omid$common$InternalMessage.isValidSerializedMessage = function(a) {
  return !!a && void 0 !== a[module$contents$omid$common$InternalMessage_GUID_KEY] && void 0 !== a[module$contents$omid$common$InternalMessage_METHOD_KEY] && void 0 !== a[module$contents$omid$common$InternalMessage_VERSION_KEY] && "string" === typeof a[module$contents$omid$common$InternalMessage_GUID_KEY] && "string" === typeof a[module$contents$omid$common$InternalMessage_METHOD_KEY] && "string" === typeof a[module$contents$omid$common$InternalMessage_VERSION_KEY] && (void 0 === a[module$contents$omid$common$InternalMessage_ARGS_KEY] || 
  void 0 !== a[module$contents$omid$common$InternalMessage_ARGS_KEY]);
};
module$exports$omid$common$InternalMessage.deserialize = function(a) {
  return new module$exports$omid$common$InternalMessage(a[module$contents$omid$common$InternalMessage_GUID_KEY], a[module$contents$omid$common$InternalMessage_METHOD_KEY], a[module$contents$omid$common$InternalMessage_VERSION_KEY], a[module$contents$omid$common$InternalMessage_ARGS_KEY]);
};
module$exports$omid$common$InternalMessage.prototype.serialize = function() {
  var a = {};
  a = (a[module$contents$omid$common$InternalMessage_GUID_KEY] = this.guid, a[module$contents$omid$common$InternalMessage_METHOD_KEY] = this.method, a[module$contents$omid$common$InternalMessage_VERSION_KEY] = this.version, a);
  void 0 !== this.args && (a[module$contents$omid$common$InternalMessage_ARGS_KEY] = this.args);
  return a;
};
var module$exports$omid$common$Communication = function(a) {
  this.to = a;
  this.communicationType_ = module$exports$omid$common$constants.CommunicationType.NONE;
};
module$exports$omid$common$Communication.prototype.sendMessage = function(a, b) {
};
module$exports$omid$common$Communication.prototype.handleMessage = function(a, b) {
  if (this.onMessage) {
    this.onMessage(a, b);
  }
};
module$exports$omid$common$Communication.prototype.generateGuid = function() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(a) {
    var b = 16 * Math.random() | 0;
    a = "y" === a ? (b & 3 | 8).toString(16) : b.toString(16);
    return a;
  });
};
module$exports$omid$common$Communication.prototype.serialize = function(a) {
  return JSON.stringify(a);
};
module$exports$omid$common$Communication.prototype.deserialize = function(a) {
  return JSON.parse(a);
};
module$exports$omid$common$Communication.prototype.isDirectCommunication = function() {
  return this.communicationType_ === module$exports$omid$common$constants.CommunicationType.DIRECT;
};
var module$exports$omid$common$DetectOmid = {OMID_PRESENT_FRAME_NAME:"omid_v1_present", isOmidPresent:function(a) {
  try {
    return a.frames ? !!a.frames[module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME] : !1;
  } catch (b) {
    return !1;
  }
}, declareOmidPresence:function(a) {
  a.frames && a.document && (module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME in a.frames || (null == a.document.body && module$exports$omid$common$DetectOmid.isMutationObserverAvailable_(a) ? module$exports$omid$common$DetectOmid.registerMutationObserver_(a) : a.document.body ? module$exports$omid$common$DetectOmid.appendPresenceIframe_(a) : a.document.write('<iframe style="display:none" ' + ('id="' + module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME + '"') + (' name="' + 
  module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME + '">') + "</iframe>")));
}, appendPresenceIframe_:function(a) {
  var b = a.document.createElement("iframe");
  b.id = module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME;
  b.name = module$exports$omid$common$DetectOmid.OMID_PRESENT_FRAME_NAME;
  b.style.display = "none";
  a.document.body.appendChild(b);
}, isMutationObserverAvailable_:function(a) {
  return "MutationObserver" in a;
}, registerMutationObserver_:function(a) {
  var b = new MutationObserver(function(c) {
    c.forEach(function(c) {
      "BODY" === c.addedNodes[0].nodeName && (module$exports$omid$common$DetectOmid.appendPresenceIframe_(a), b.disconnect());
    });
  });
  b.observe(a.document.documentElement, {childList:!0});
}};
var module$exports$omid$common$DirectCommunication = function(a) {
  module$exports$omid$common$Communication.call(this, a);
  this.communicationType_ = module$exports$omid$common$constants.CommunicationType.DIRECT;
  this.handleExportedMessage = module$exports$omid$common$DirectCommunication.prototype.handleExportedMessage.bind(this);
};
$jscomp.inherits(module$exports$omid$common$DirectCommunication, module$exports$omid$common$Communication);
module$exports$omid$common$DirectCommunication.prototype.sendMessage = function(a, b) {
  b = void 0 === b ? this.to : b;
  if (!b) {
    throw Error("Message destination must be defined at construction time or when sending the message.");
  }
  b.handleExportedMessage(a.serialize(), this);
};
module$exports$omid$common$DirectCommunication.prototype.handleExportedMessage = function(a, b) {
  module$exports$omid$common$InternalMessage.isValidSerializedMessage(a) && this.handleMessage(module$exports$omid$common$InternalMessage.deserialize(a), b);
};
var module$exports$omid$common$eventTypedefs = {};
var module$exports$omid$common$exporter = {};
function module$contents$omid$common$exporter_getOmidExports() {
  return "undefined" === typeof omidExports ? null : omidExports;
}
function module$contents$omid$common$exporter_getOrCreateName(a, b) {
  return a && (a[b] || (a[b] = {}));
}
module$exports$omid$common$exporter.packageExport = function(a, b, c) {
  if (c = void 0 === c ? module$contents$omid$common$exporter_getOmidExports() : c) {
    a = a.split("."), a.slice(0, a.length - 1).reduce(module$contents$omid$common$exporter_getOrCreateName, c)[a[a.length - 1]] = b;
  }
};
var module$exports$omid$common$logger = {error:function(a) {
  for (var b = [], c = 0; c < arguments.length; ++c) {
    b[c - 0] = arguments[c];
  }
  module$contents$omid$common$logger_executeLog(function() {
    throw new (Function.prototype.bind.apply(Error, [null].concat(["Could not complete the test successfully - "], $jscomp.arrayFromIterable(b))));
  }, function() {
    return console.error.apply(console, [].concat($jscomp.arrayFromIterable(b)));
  });
}, debug:function(a) {
  for (var b = [], c = 0; c < arguments.length; ++c) {
    b[c - 0] = arguments[c];
  }
  module$contents$omid$common$logger_executeLog(function() {
  }, function() {
    return console.error.apply(console, [].concat($jscomp.arrayFromIterable(b)));
  });
}};
function module$contents$omid$common$logger_executeLog(a, b) {
  "undefined" !== typeof jasmine && jasmine ? a() : "undefined" !== typeof console && console && console.error && b();
}
;var module$exports$omid$common$OmidGlobalProvider = {}, module$contents$omid$common$OmidGlobalProvider_globalThis = eval("this");
function module$contents$omid$common$OmidGlobalProvider_getOmidGlobal() {
  if ("undefined" !== typeof omidGlobal && omidGlobal) {
    return omidGlobal;
  }
  if ("undefined" !== typeof global && global) {
    return global;
  }
  if ("undefined" !== typeof window && window) {
    return window;
  }
  if ("undefined" !== typeof module$contents$omid$common$OmidGlobalProvider_globalThis && module$contents$omid$common$OmidGlobalProvider_globalThis) {
    return module$contents$omid$common$OmidGlobalProvider_globalThis;
  }
  throw Error("Could not determine global object context.");
}
module$exports$omid$common$OmidGlobalProvider.omidGlobal = module$contents$omid$common$OmidGlobalProvider_getOmidGlobal();
var module$exports$omid$common$PostMessageCommunication = function(a, b) {
  b = void 0 === b ? module$exports$omid$common$OmidGlobalProvider.omidGlobal : b;
  module$exports$omid$common$Communication.call(this, b);
  var c = this;
  this.communicationType_ = module$exports$omid$common$constants.CommunicationType.POST_MESSAGE;
  a.addEventListener("message", function(a) {
    if ("object" === typeof a.data) {
      var b = a.data;
      module$exports$omid$common$InternalMessage.isValidSerializedMessage(b) && (b = module$exports$omid$common$InternalMessage.deserialize(b), a.source && c.handleMessage(b, a.source));
    }
  });
};
$jscomp.inherits(module$exports$omid$common$PostMessageCommunication, module$exports$omid$common$Communication);
module$exports$omid$common$PostMessageCommunication.isCompatibleContext = function(a) {
  return !!(a && a.addEventListener && a.postMessage);
};
module$exports$omid$common$PostMessageCommunication.prototype.sendMessage = function(a, b) {
  b = void 0 === b ? this.to : b;
  if (!b) {
    throw Error("Message destination must be defined at construction time or when sending the message.");
  }
  b.postMessage(a.serialize(), "*");
};
var module$exports$omid$common$Rectangle = function(a, b, c, d) {
  this.x = a;
  this.y = b;
  this.width = c;
  this.height = d;
};
var module$exports$omid$common$serviceCommunication = {resolveTopWindowContext:function(a) {
  "undefined" === typeof a && "undefined" !== typeof window && window && (a = window);
  if ("undefined" === typeof a || !a || "undefined" === typeof a.top || !a.top) {
    return module$exports$omid$common$OmidGlobalProvider.omidGlobal;
  }
  if (a === a.top) {
    return a;
  }
  try {
    return "undefined" === typeof a.top.location.hostname ? a : a.top;
  } catch (b) {
    return a;
  }
}};
function module$contents$omid$common$serviceCommunication_getUnobfuscatedKey(a, b) {
  return b.reduce(function(a, b) {
    return a && a[b];
  }, a);
}
module$exports$omid$common$serviceCommunication.startServiceCommunication = function(a, b, c) {
  c = void 0 === c ? module$exports$omid$common$DetectOmid.isOmidPresent : c;
  return (b = module$contents$omid$common$serviceCommunication_getUnobfuscatedKey(a, b)) ? new module$exports$omid$common$DirectCommunication(b) : a.top && c(a.top) ? new module$exports$omid$common$PostMessageCommunication(a, a.top) : null;
};
var module$exports$omid$common$VastProperties = function(a, b, c, d) {
  this.isSkippable = a;
  this.skipOffset = b;
  this.isAutoPlay = c;
  this.position = d;
};
var module$exports$omid$common$version = {ApiVersion:"1.0", Version:"1.2.6-dev"};
var module$contents$omid$verificationClient$VerificationClient_VERIFICATION_CLIENT_VERSION = module$exports$omid$common$version.Version, module$contents$omid$verificationClient$VerificationClient_EventCallback;
function module$contents$omid$verificationClient$VerificationClient_getThirdPartyOmid() {
  var a = module$exports$omid$common$OmidGlobalProvider.omidGlobal.omid3p;
  return a && "function" === typeof a.registerSessionObserver && "function" === typeof a.addEventListener ? a : null;
}
var module$exports$omid$verificationClient$VerificationClient = function(a) {
  if (this.communication = a = void 0 === a ? (0,module$exports$omid$common$serviceCommunication.startServiceCommunication)((0,module$exports$omid$common$serviceCommunication.resolveTopWindowContext)(), ["omid", "v1_VerificationServiceCommunication"]) : a) {
    this.communication.onMessage = this.handleMessage_.bind(this);
  } else {
    if (a = module$contents$omid$verificationClient$VerificationClient_getThirdPartyOmid()) {
      this.omid3p = a;
    }
  }
  this.remoteIntervals_ = this.remoteTimeouts_ = 0;
  this.callbackMap_ = {};
  this.imgCache_ = [];
};
module$exports$omid$verificationClient$VerificationClient.prototype.isSupported = function() {
  return !(!this.communication && !this.omid3p);
};
module$exports$omid$verificationClient$VerificationClient.prototype.registerSessionObserver = function(a, b) {
  (0,module$exports$omid$common$argsChecker.assertFunction)("functionToExecute", a);
  this.omid3p ? this.omid3p.registerSessionObserver(a, b) : this.sendMessage_("addSessionListener", a, b);
};
module$exports$omid$verificationClient$VerificationClient.prototype.addEventListener = function(a, b) {
  (0,module$exports$omid$common$argsChecker.assertTruthyString)("eventType", a);
  (0,module$exports$omid$common$argsChecker.assertFunction)("functionToExecute", b);
  this.omid3p ? this.omid3p.addEventListener(a, b) : this.sendMessage_("addEventListener", b, a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.sendUrl = function(a, b, c) {
  (0,module$exports$omid$common$argsChecker.assertTruthyString)("url", a);
  module$exports$omid$common$OmidGlobalProvider.omidGlobal.document && module$exports$omid$common$OmidGlobalProvider.omidGlobal.document.createElement ? this.sendUrlWithImg_(a, b, c) : this.sendMessage_("sendUrl", function(a) {
    a && b ? b() : !a && c && c();
  }, a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.sendUrlWithImg_ = function(a, b, c) {
  var d = this, e = module$exports$omid$common$OmidGlobalProvider.omidGlobal.document.createElement("img");
  this.imgCache_.push(e);
  var f = function(a) {
    var b = d.imgCache_.indexOf(e);
    0 <= b && d.imgCache_.splice(b, 1);
    a && a();
  };
  e.addEventListener("load", f.bind(this, b));
  e.addEventListener("error", f.bind(this, c));
  e.src = a;
};
module$exports$omid$verificationClient$VerificationClient.prototype.injectJavaScriptResource = function(a, b, c) {
  var d = this;
  (0,module$exports$omid$common$argsChecker.assertTruthyString)("url", a);
  module$exports$omid$common$OmidGlobalProvider.omidGlobal.document ? this.injectJavascriptResourceUrlInDom_(a, b, c) : this.sendMessage_("injectJavaScriptResource", function(e, f) {
    e ? (d.evaluateJavaScript_(f, a), b()) : (module$exports$omid$common$logger.error("Service failed to load JavaScript resource."), c());
  }, a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.injectJavascriptResourceUrlInDom_ = function(a, b, c) {
  var d = module$exports$omid$common$OmidGlobalProvider.omidGlobal.document, e = d.body;
  d = d.createElement("script");
  d.onload = b;
  d.onerror = c;
  d.src = a;
  d.type = "application/javascript";
  e.appendChild(d);
};
module$exports$omid$verificationClient$VerificationClient.prototype.evaluateJavaScript_ = function(a, b) {
  try {
    eval(a);
  } catch (c) {
    module$exports$omid$common$logger.error('Error evaluating the JavaScript resource from "' + b + '".');
  }
};
module$exports$omid$verificationClient$VerificationClient.prototype.setTimeout = function(a, b) {
  (0,module$exports$omid$common$argsChecker.assertFunction)("functionToExecute", a);
  (0,module$exports$omid$common$argsChecker.assertPositiveNumber)("timeInMillis", b);
  if (this.hasTimeoutMethods_()) {
    return module$exports$omid$common$OmidGlobalProvider.omidGlobal.setTimeout(a, b);
  }
  var c = this.remoteTimeouts_++;
  this.sendMessage_("setTimeout", a, c, b);
  return c;
};
module$exports$omid$verificationClient$VerificationClient.prototype.clearTimeout = function(a) {
  (0,module$exports$omid$common$argsChecker.assertPositiveNumber)("timeoutId", a);
  this.hasTimeoutMethods_() ? module$exports$omid$common$OmidGlobalProvider.omidGlobal.clearTimeout(a) : this.sendOneWayMessage_("clearTimeout", a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.setInterval = function(a, b) {
  (0,module$exports$omid$common$argsChecker.assertFunction)("functionToExecute", a);
  (0,module$exports$omid$common$argsChecker.assertPositiveNumber)("timeInMillis", b);
  if (this.hasIntervalMethods_()) {
    return module$exports$omid$common$OmidGlobalProvider.omidGlobal.setInterval(a, b);
  }
  var c = this.remoteIntervals_++;
  this.sendMessage_("setInterval", a, c, b);
  return c;
};
module$exports$omid$verificationClient$VerificationClient.prototype.clearInterval = function(a) {
  (0,module$exports$omid$common$argsChecker.assertPositiveNumber)("intervalId", a);
  this.hasIntervalMethods_() ? module$exports$omid$common$OmidGlobalProvider.omidGlobal.clearInterval(a) : this.sendOneWayMessage_("clearInterval", a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.hasTimeoutMethods_ = function() {
  return "function" === typeof module$exports$omid$common$OmidGlobalProvider.omidGlobal.setTimeout && "function" === typeof module$exports$omid$common$OmidGlobalProvider.omidGlobal.clearTimeout;
};
module$exports$omid$verificationClient$VerificationClient.prototype.hasIntervalMethods_ = function() {
  return "function" === typeof module$exports$omid$common$OmidGlobalProvider.omidGlobal.setInterval && "function" === typeof module$exports$omid$common$OmidGlobalProvider.omidGlobal.clearInterval;
};
module$exports$omid$verificationClient$VerificationClient.prototype.handleMessage_ = function(a, b) {
  b = a.method;
  var c = a.guid;
  a = a.args;
  if ("response" === b && this.callbackMap_[c]) {
    var d = (0,module$exports$omid$common$ArgsSerDe.deserializeMessageArgs)(module$contents$omid$verificationClient$VerificationClient_VERIFICATION_CLIENT_VERSION, a);
    this.callbackMap_[c].apply(this, d);
  }
  "error" === b && window.console && module$exports$omid$common$logger.error(a);
};
module$exports$omid$verificationClient$VerificationClient.prototype.sendOneWayMessage_ = function(a, b) {
  for (var c = [], d = 1; d < arguments.length; ++d) {
    c[d - 1] = arguments[d];
  }
  this.sendMessage_.apply(this, [].concat([a, null], $jscomp.arrayFromIterable(c)));
};
module$exports$omid$verificationClient$VerificationClient.prototype.sendMessage_ = function(a, b, c) {
  for (var d = [], e = 2; e < arguments.length; ++e) {
    d[e - 2] = arguments[e];
  }
  this.communication && (e = this.communication.generateGuid(), b && (this.callbackMap_[e] = b), d = new module$exports$omid$common$InternalMessage(e, "VerificationService." + a, module$contents$omid$verificationClient$VerificationClient_VERIFICATION_CLIENT_VERSION, (0,module$exports$omid$common$ArgsSerDe.serializeMessageArgs)(module$contents$omid$verificationClient$VerificationClient_VERIFICATION_CLIENT_VERSION, d)), this.communication.sendMessage(d));
};
(0,module$exports$omid$common$exporter.packageExport)("OmidVerificationClient", module$exports$omid$verificationClient$VerificationClient);

}, typeof exports === 'undefined' ? undefined : exports));



//#OMID:END

//reweights
try{
	if(window.adxcel_settings.revisionsWeights){
		if(adxcel_lines[0]["dco"]["dco_ai_logits"] != null){
			window.adxcel_settings.revisionsWeights = [0,0,0,85,0,0,15]
		}
	}
}catch(e){
	setTimeout(function(){
				adxcel_ga_event("error", "reason=reweights:"+e.toString().substr(0,40)+"...");
			}, 500);
}
//reweights: end

//skip clusters
try{
	if(window.adxcel_settings.revisionsWeights[5]>0){
		var vl = window.adxcel_settings.revisionsWeights[5];
		window.adxcel_settings.revisionsWeights[5] = 0;
		if(window.adxcel_settings.revisionsWeights[3]>0){
			window.adxcel_settings.revisionsWeights[3] = window.adxcel_settings.revisionsWeights[3] + vl;
		}else{
			window.adxcel_settings.revisionsWeights[6] = window.adxcel_settings.revisionsWeights[6] + vl;
		}
	}
}catch(e){
	setTimeout(function(){
					adxcel_ga_event("error", "reason=skip_clusters:"+e.toString().substr(0,40)+"...");
				}, 500);
}
//skip clusters:end
//#INCLUDE ENGINE: END



